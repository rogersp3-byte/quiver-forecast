<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiver — Spanish Point</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #0f0f0f;
  --surface: #1a1a1a;
  --surface2:#222222;
  --white:   #ffffff;
  --muted:   rgba(255,255,255,0.35);
  --faint:   rgba(255,255,255,0.1);
  --good:    #22c55e;
  --fair:    #f5c800;
  --poor:    #ef4444;
}
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }
body { background:var(--bg); color:var(--white); font-family:'Archivo Black', sans-serif; overflow-x:hidden; }
body::after {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.07; mix-blend-mode:overlay;
}

/* ── ONBOARDING MODAL ── */
.modal-backdrop {
  position:fixed; inset:0; background:rgba(0,0,0,0.85);
  z-index:1000; display:flex; align-items:center; justify-content:center;
  padding:24px;
}
.modal {
  background:var(--surface); max-width:480px; width:100%; padding:36px;
  border:1px solid rgba(255,255,255,0.1);
}
.modal-title { font-size:22px; letter-spacing:-0.5px; margin-bottom:6px; }
.modal-sub { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:32px; }
.field { margin-bottom:22px; }
.field-label { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.6); margin-bottom:10px; display:block; }
.field select, .field input {
  width:100%; background:#111; border:1px solid rgba(255,255,255,0.15);
  color:var(--white); font-family:'DM Mono',monospace; font-size:12px;
  padding:12px 14px; outline:none; appearance:none;
  transition:border-color 0.2s;
}
.field select:focus, .field input:focus { border-color:rgba(255,255,255,0.4); }
.modal-btn {
  width:100%; background:var(--white); color:#0f0f0f;
  border:none; font-family:'Archivo Black',sans-serif;
  font-size:13px; letter-spacing:1px; padding:16px;
  cursor:pointer; transition:opacity 0.15s;
}
.modal-btn:hover { opacity:0.9; }

/* ── HEADER ── */
header { padding:18px 28px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--faint); }
.logo { font-size:18px; letter-spacing:2px; }
.logo-tag { font-family:'DM Mono',monospace; font-size:7px; letter-spacing:3px; text-transform:uppercase; color:var(--muted); margin-top:2px; }
.profile-btn { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); background:none; border:1px solid rgba(255,255,255,0.15); padding:7px 14px; cursor:pointer; }
.profile-btn:hover { border-color:rgba(255,255,255,0.35); color:rgba(255,255,255,0.7); }

/* ── HERO ── */
.hero { padding:52px 28px 48px; text-align:center; border-bottom:1px solid var(--faint); }
.break-name { font-size:clamp(52px,13vw,120px); letter-spacing:-2px; line-height:0.9; }
.break-loc { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:3px; text-transform:uppercase; color:var(--muted); margin-top:14px; }

.main { max-width:900px; margin:0 auto; padding:36px 24px 80px; }

/* ── WINDOW ALERT ── */
.window-alert {
  border:1px solid rgba(255,255,255,0.12); padding:20px 24px;
  margin-bottom:28px; position:relative; overflow:hidden;
}
.window-alert::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
}
.window-alert.good-window::before { background:var(--good); }
.window-alert.fair-window::before { background:var(--fair); }
.window-alert.poor-window::before { background:var(--poor); }
.window-eyebrow { font-family:'DM Mono',monospace; font-size:8px; letter-spacing:3px; text-transform:uppercase; color:var(--muted); margin-bottom:8px; }
.window-text { font-family:'DM Mono',monospace; font-size:12px; letter-spacing:0.5px; color:rgba(255,255,255,0.85); line-height:1.7; font-style:italic; }

/* ── BADGE + READ ── */
.badge-row { display:flex; align-items:flex-start; gap:20px; margin-bottom:24px; flex-wrap:wrap; }
.badge { display:inline-block; font-family:'DM Mono',monospace; font-size:10px; letter-spacing:3px; text-transform:uppercase; padding:7px 18px; border:1.5px solid; white-space:nowrap; }
.badge-epic,.badge-good { color:var(--good); border-color:var(--good); }
.badge-fair  { color:var(--fair);  border-color:var(--fair); }
.badge-poor  { color:var(--poor);  border-color:var(--poor); }
.badge-flat  { color:var(--muted); border-color:var(--muted); }
.conditions-read { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.5px; color:rgba(255,255,255,0.65); line-height:1.7; padding:7px 0 7px 16px; border-left:2px solid rgba(255,255,255,0.15); font-style:italic; }

/* ── CURRENT CARD ── */
.current-card { background:var(--surface); padding:28px; margin-bottom:4px; }
.card-label { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:3px; text-transform:uppercase; color:rgba(255,255,255,0.6); margin-bottom:22px; }
.current-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; }
.current-grid-bottom { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin-top:24px; padding-top:24px; border-top:1px solid var(--faint); }
.c-val { font-size:clamp(28px,4.5vw,44px); letter-spacing:-1px; line-height:1; }
.c-unit { font-size:0.42em; opacity:0.4; letter-spacing:0; }
.c-lbl { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.7); margin-top:7px; }
.dir-display { display:flex; align-items:center; gap:12px; }
.dir-arrow { width:38px; height:38px; display:flex; align-items:center; justify-content:center; border:1.5px solid rgba(255,255,255,0.2); border-radius:50%; flex-shrink:0; }
.dir-arrow svg { width:18px; height:18px; }

/* ── SECTION LABEL ── */
.sec-label { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:3px; text-transform:uppercase; color:rgba(255,255,255,0.65); margin:28px 0 8px; display:flex; align-items:center; gap:10px; }
.sec-label::before { content:''; width:16px; height:1px; background:rgba(255,255,255,0.4); }

/* ── 24HR ROWS ── */
.forecast-table { width:100%; border-collapse:collapse; }
.forecast-table th {
  font-family:'DM Mono',monospace; font-size:8px; letter-spacing:2px; text-transform:uppercase;
  color:var(--muted); padding:8px 12px; text-align:left;
  border-bottom:1px solid var(--faint);
}
.forecast-table th:not(:first-child) { text-align:center; }
.forecast-row { border-bottom:1px solid rgba(255,255,255,0.05); transition:background 0.15s; border-left:3px solid transparent; }
.forecast-row:hover { background:var(--surface2); }
.forecast-row.good { border-left-color:var(--good); }
.forecast-row.fair { border-left-color:var(--fair); }
.forecast-row.poor { border-left-color:var(--poor); }
.forecast-row.epic { border-left-color:var(--good); }
.forecast-row td { padding:13px 12px; vertical-align:middle; }
.row-time { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:1px; color:rgba(255,255,255,0.5); white-space:nowrap; }
.row-time.highlight { color:var(--fair); }
.row-height { font-size:20px; letter-spacing:-0.5px; text-align:center; }
.row-height.good,.row-height.epic { color:var(--good); }
.row-height.fair { color:var(--fair); }
.row-height.poor { color:var(--poor); }
.row-unit { font-size:10px; opacity:0.4; }
.row-dir { font-family:'DM Mono',monospace; font-size:10px; text-align:center; color:rgba(255,255,255,0.7); line-height:1.6; }
.row-wind { font-family:'DM Mono',monospace; font-size:10px; text-align:center; color:rgba(255,255,255,0.7); line-height:1.6; }
.row-period { font-family:'DM Mono',monospace; font-size:11px; text-align:center; color:rgba(255,255,255,0.7); }
.row-energy { font-family:'DM Mono',monospace; font-size:11px; text-align:center; color:rgba(255,255,255,0.5); }
.row-tag { display:inline-block; font-family:'DM Mono',monospace; font-size:7px; letter-spacing:1.5px; text-transform:uppercase; padding:2px 6px; margin-top:2px; }
.row-tag.dawn  { background:rgba(100,150,255,0.15); color:rgba(100,180,255,0.8); }
.row-tag.dusk  { background:rgba(255,160,60,0.15);  color:rgba(255,180,80,0.8); }
.row-tag.avail { background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.5); }

/* ── TIDES ── */
.tide-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:3px; }
.tide-card { background:var(--surface); padding:16px 18px; display:flex; align-items:center; gap:14px; }
.tide-icon { font-size:20px; flex-shrink:0; }
.tide-type { font-family:'DM Mono',monospace; font-size:8px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:3px; }
.tide-time { font-size:20px; letter-spacing:-0.5px; }
.tide-ht { font-family:'DM Mono',monospace; font-size:9px; color:var(--muted); margin-top:2px; }

/* ── 7 DAY ── */
.seven-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:3px; }
.day-card { background:var(--surface); padding:16px 14px; text-align:center; border-top:2px solid transparent; }
.day-card.epic,.day-card.good { border-top-color:var(--good); }
.day-card.fair { border-top-color:var(--fair); }
.day-card.poor { border-top-color:var(--poor); }
.day-name { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.6); margin-bottom:8px; }
.day-height { font-size:24px; letter-spacing:-1px; }
.day-card.epic .day-height,.day-card.good .day-height { color:var(--good); }
.day-card.fair .day-height { color:var(--fair); }
.day-card.poor .day-height { color:var(--poor); }
.day-detail { font-family:'DM Mono',monospace; font-size:8px; color:rgba(255,255,255,0.5); margin-top:5px; line-height:1.7; text-transform:uppercase; }

.status { text-align:center; padding:80px 24px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); }
.status.error { color:var(--poor); }

@media (max-width:640px) {
  .current-grid,.current-grid-bottom { grid-template-columns:repeat(2,1fr); }
  header { padding:14px 18px; }
  .hero { padding:36px 18px 36px; }
  .main { padding:24px 16px 60px; }
  .current-card { padding:20px; }
  .badge-row { flex-direction:column; gap:12px; }
  .forecast-table th:nth-child(5),
  .forecast-table td:nth-child(5) { display:none; }
}
</style>
</head>
<body>

<!-- ONBOARDING MODAL -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <div class="modal-title">Set Up Your Profile</div>
    <div class="modal-sub">Takes 30 seconds · helps us read the forecast for you</div>
    <div class="field">
      <label class="field-label">Your Name</label>
      <input type="text" id="p-name" placeholder="e.g. Conor" />
    </div>
    <div class="field">
      <label class="field-label">Skill Level</label>
      <select id="p-skill">
        <option value="beginner">Beginner — still learning to stand up</option>
        <option value="intermediate">Intermediate — comfortable on green waves</option>
        <option value="advanced" selected>Advanced — surfing most conditions</option>
        <option value="expert">Expert — charging anything</option>
      </select>
    </div>
    <div class="field">
      <label class="field-label">Work Schedule</label>
      <select id="p-work">
        <option value="9to5" selected>9–5 weekdays (weekends free)</option>
        <option value="flexible">Flexible / remote</option>
        <option value="shift">Shift work — varies</option>
        <option value="retired">Retired / student</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveProfile()">Save &amp; Load Forecast →</button>
  </div>
</div>

<header>
  <div><div class="logo">QUIVER</div><div class="logo-tag">Surf Guide</div></div>
  <button class="profile-btn" onclick="resetProfile()">Edit Profile</button>
</header>

<div class="hero">
  <div class="break-name">SPANISH<br>POINT</div>
  <div class="break-loc">Co. Clare · Ireland · 52.8441° N, 9.4747° W</div>
</div>

<main class="main">
  <div id="app"><div class="status">Loading forecast...</div></div>
</main>

<script>
const LAT = 52.8441, LNG = -9.4747;
const BEACH_FACING = 285; // WNW — direction the break faces

// ── PROFILE ──
function getProfile() {
  try { return JSON.parse(localStorage.getItem('quiver_profile')); } catch(e) { return null; }
}
function saveProfile() {
  const name  = document.getElementById('p-name').value.trim() || 'Surfer';
  const skill = document.getElementById('p-skill').value;
  const work  = document.getElementById('p-work').value;
  localStorage.setItem('quiver_profile', JSON.stringify({ name, skill, work }));
  document.getElementById('modal').style.display = 'none';
  load();
}
function resetProfile() {
  document.getElementById('modal').style.display = 'flex';
}
// Show modal if no profile saved
if (getProfile()) document.getElementById('modal').style.display = 'none';

// ── HELPERS ──
function windDir(d) { return ['N','NE','E','SE','S','SW','W','NW'][Math.round(d/45)%8]; }

function dirArrowSVG(deg, color) {
  return `<div class="dir-arrow"><svg viewBox="0 0 24 24" style="transform:rotate(${deg}deg)" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="6 11 12 5 18 11"/></svg></div>`;
}

function arrowChar(deg) {
  return ['↑','↗','→','↘','↓','↙','←','↖'][Math.round(deg/45)%8];
}

function waveEnergy(h, t) { return Math.round(0.5 * h * h * t); }

function isOnshore(windDeg) {
  // Onshore = wind blowing FROM the sea (from the W/WNW direction the beach faces).
  // Spanish Point faces WNW (~285°), so onshore wind comes from roughly W through NW.
  const diff = ((windDeg - BEACH_FACING) + 360) % 360;
  return diff <= 90 || diff >= 270;
}
function isOffshore(windDeg) {
  // Offshore = wind blowing FROM land out to sea = coming from the E/SE side (~105°).
  const diff = ((windDeg - BEACH_FACING) + 360) % 360;
  return diff > 90 && diff < 270;
}

function rate(h, w, p) {
  if (h < 0.3) return 'flat';
  if (h >= 1.5 && p >= 12 && w < 5)  return 'epic';
  if (h >= 0.8 && p >= 9  && w < 10) return 'good';
  if (h >= 0.5 && w < 15)             return 'fair';
  return 'poor';
}
function rateLabel(r) {
  return {epic:'Epic',good:'Good conditions',fair:'Fair conditions',poor:'Poor conditions',flat:'Flat'}[r];
}

function conditionsRead(h, ws, wd, swP, swD, wD) {
  const wDir = windDir(wd), swDir = windDir(swD || wD);
  const parts = [];
  if (h < 0.3) return "Waves too small to surf.";
  const ft = (h * 3.281).toFixed(0);
  if (h >= 2.5) parts.push(`solid ${ft}ft of swell in the water`);
  else if (h >= 1.2) parts.push(`${ft}ft of swell running`);
  else parts.push(`small ${ft}ft waves`);
  if (swP >= 14)     parts.push("very long period — likely to have good shape");
  else if (swP >= 10) parts.push("decent period on the swell");
  else if (swP < 7)   parts.push("short period — likely to be choppy");
  if (ws < 5) parts.push("virtually no wind");
  else if (isOffshore(wd) && ws < 15) parts.push(`${wDir} offshore wind — could clean up the faces`);
  else if (isOffshore(wd) && ws >= 15) parts.push(`strong ${wDir} offshore — may be blown out`);
  else if (isOnshore(wd) && ws >= 15)  parts.push(`strong ${wDir} onshore — likely messy`);
  else if (isOnshore(wd) && ws >= 8)   parts.push(`${wDir} onshore — expect some chop on the face`);
  else if (isOnshore(wd)) parts.push(`light ${wDir} onshore`);
  else parts.push(`${wDir} sideshore at ${ws.toFixed(0)}kn`);
  return parts.join(". ") + ".";
}

// ── SUNRISE / SUNSET (simple formula, good enough for Ireland) ──
function getSunTimes(lat, lng, date) {
  const rad = Math.PI / 180;
  const d = date;
  const dayOfYear = Math.floor((d - new Date(d.getFullYear(),0,0)) / 86400000);
  const B = (360/365) * (dayOfYear - 81) * rad;
  const eqTime = 9.87*Math.sin(2*B) - 7.53*Math.cos(B) - 1.5*Math.sin(B);
  const decl = 23.45 * Math.sin(B) * rad;
  const HA = Math.acos(-Math.tan(lat*rad)*Math.tan(decl)) / rad;
  const tzOffset = 0; // UTC, we'll adjust
  const noon = 12 - (lng/15) - (eqTime/60) + tzOffset;
  const sunrise = noon - HA/15;
  const sunset  = noon + HA/15;
  // Ireland is UTC+0 in winter, UTC+1 in summer
  const isDST = d.getTimezoneOffset() < 0 || (d.getMonth() >= 2 && d.getMonth() <= 9);
  const offset = isDST ? 1 : 0;
  const toHHMM = (h) => {
    const hh = Math.floor(h + offset) % 24;
    const mm = Math.round((h + offset - Math.floor(h + offset)) * 60);
    return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
  };
  return { sunrise: sunrise + offset, sunset: sunset + offset, sunriseStr: toHHMM(sunrise), sunsetStr: toHHMM(sunset) };
}

// ── WINDOW ALERT ──
function buildWindowAlert(slots, profile, sun, tides) {
  if (!profile) return '';
  const { name, skill, work } = profile;

  const skillMinWave = { beginner:0.3, intermediate:0.5, advanced:0.8, expert:1.2 }[skill];
  const skillMaxWave = { beginner:1.0, intermediate:1.8, advanced:3.5, expert:99  }[skill];
  const skillMinPeriod = { beginner:5, intermediate:7, advanced:9, expert:10 }[skill];

  const now = new Date();
  const isWeekend = [0,6].includes(now.getDay());
  const isFlexible = work === 'flexible' || work === 'retired';

  // Score each slot
  const scored = slots.map(s => {
    const slotDate = new Date(s.time);
    const hour = slotDate.getHours();
    const dayOfWeek = slotDate.getDay();
    const isAvailable = isFlexible || [0,6].includes(dayOfWeek) || hour < 8 || hour > 18;
    const r = rate(s.h, s.ws, s.p);
    const offshore = isOffshore(s.wd);
    const goodWind = offshore || s.ws < 8;
    const goodSize = s.h >= skillMinWave && s.h <= skillMaxWave;
    const goodPeriod = s.p >= skillMinPeriod;
    const daylight = hour >= Math.floor(sun.sunrise) && hour <= Math.floor(sun.sunset);

    let score = 0;
    if (goodSize)   score += 3;
    if (goodPeriod) score += 2;
    if (goodWind)   score += 2;
    if (offshore)   score += 1;
    if (isAvailable) score += 2;
    if (daylight)   score += 1;

    return { ...s, score, isAvailable, r, goodWind, goodSize, goodPeriod, daylight, slotDate, hour, dayOfWeek };
  });

  // Find best window
  const best = scored.filter(s => s.score >= 5 && s.goodSize).sort((a,b) => b.score - a.score)[0];

  if (!best) {
    const next = scored.filter(s => s.goodSize).sort((a,b) => b.score - a.score)[0];
    if (!next) return `<div class="window-alert poor-window"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">Nothing great in the next 24 hours. Check back as conditions develop.</div></div>`;
    const dayName = next.slotDate.toDateString() === now.toDateString() ? 'today' : next.slotDate.toLocaleDateString('en-IE',{weekday:'long'});
    return `<div class="window-alert fair-window"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">Best of a quiet spell around ${fmtT(next.time)} ${dayName}. ${next.h.toFixed(1)}m, ${next.p.toFixed(0)}s — worth keeping an eye on.</div></div>`;
  }

  const dayName = best.slotDate.toDateString() === now.toDateString() ? 'today' : best.slotDate.toLocaleDateString('en-IE',{weekday:'long'});
  const unavailableNote = !best.isAvailable && work === '9to5' ? ' — you\'ll need to duck out early or make it a lunch paddle' : '';
  const windNote = isOffshore(best.wd) ? `${windDir(best.wd)} offshore wind` : `light ${windDir(best.wd)} wind`;
  const qualityWord = best.r === 'epic' ? 'an epic' : best.r === 'good' ? 'a good' : 'a fair';

  let msg = `Looks like ${qualityWord} window around ${fmtT(best.time)} ${dayName}${unavailableNote}. `;
  msg += `${best.h.toFixed(1)}m at ${best.p.toFixed(0)}s with ${windNote}.`;

  if (skill === 'beginner' && best.h < 1.0) msg += ` Good size for building confidence.`;
  else if (skill === 'expert' && best.h >= 2.0) msg += ` Sizeable — should be worth the paddle.`;
  else if (skill === 'advanced' && best.h < 0.9) msg += ` A bit small but could be fun on a log.`;

  const alertClass = best.r === 'good' || best.r === 'epic' ? 'good-window' : 'fair-window';
  return `<div class="window-alert ${alertClass}"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">${msg}</div></div>`;
}

function fmtT(iso) {
  return new Date(iso).toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit',hour12:false});
}
function fmtDay(iso) {
  const d=new Date(iso),t=new Date(),tm=new Date();
  tm.setDate(tm.getDate()+1);
  if(d.toDateString()===t.toDateString()) return 'Today';
  if(d.toDateString()===tm.toDateString()) return 'Tmrw';
  return d.toLocaleDateString('en-IE',{weekday:'short'});
}

// ── SIMPLE TIDE ESTIMATOR (based on Atlantic tidal pattern) ──
// Since Open-Meteo tide data isn't reliable at this coast, we'll use a simple harmonic estimate
// Real product would use a dedicated tide API
function estimateTides(date) {
  // Spanish Point: avg tide cycle ~12.4 hours, mean range ~3.8m
  // Reference: low tide at 00:00 Jan 1 2026 UTC (approximate)
  const refTime = new Date('2026-01-01T00:00:00Z').getTime();
  const now = date.getTime();
  const tidalPeriod = 12.4 * 60 * 60 * 1000; // 12.4 hours in ms
  const phase = ((now - refTime) % tidalPeriod) / tidalPeriod;
  const tides = [];
  // Find next 4 extremes (high/low) from start of day
  const dayStart = new Date(date); dayStart.setHours(0,0,0,0);
  for (let i = 0; i < 4; i++) {
    const highOffset = (0.25 - ((dayStart.getTime() - refTime) / tidalPeriod % 1) + i * 0.5) * tidalPeriod;
    const lowOffset  = (0.75 - ((dayStart.getTime() - refTime) / tidalPeriod % 1) + i * 0.5) * tidalPeriod;
    const highTime = new Date(dayStart.getTime() + ((highOffset % tidalPeriod + tidalPeriod) % tidalPeriod));
    const lowTime  = new Date(dayStart.getTime() + ((lowOffset  % tidalPeriod + tidalPeriod) % tidalPeriod));
    if (highTime.getDate() === date.getDate()) tides.push({ type:'high', time:highTime, height:4.2 });
    if (lowTime.getDate()  === date.getDate()) tides.push({ type:'low',  time:lowTime,  height:0.5 });
  }
  return tides.sort((a,b) => a.time - b.time).slice(0,4);
}

// ── MAIN LOAD ──
async function load() {
  const app = document.getElementById('app');
  const profile = getProfile();
  if (!profile) return;

  try {
    const [mr, wr] = await Promise.all([
      fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${LAT}&longitude=${LNG}`
        +`&hourly=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period`
        +`&daily=wave_height_max,wave_period_max,wave_direction_dominant,swell_wave_height_max`
        +`&wind_speed_unit=kn&timezone=Europe%2FDublin&forecast_days=7`),
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LNG}`
        +`&hourly=wind_speed_10m,wind_direction_10m`
        +`&wind_speed_unit=kn&timezone=Europe%2FDublin&forecast_days=7`)
    ]);
    if (!mr.ok) throw new Error('Marine API '+mr.status);
    if (!wr.ok) throw new Error('Wind API '+wr.status);

    const m = await mr.json(), w = await wr.json();
    const times=m.hourly.time, wH=m.hourly.wave_height, wDir=m.hourly.wave_direction;
    const wP=m.hourly.wave_period, swH=m.hourly.swell_wave_height;
    const swD=m.hourly.swell_wave_direction, swP=m.hourly.swell_wave_period;
    const wndS=w.hourly.wind_speed_10m, wndD=w.hourly.wind_direction_10m;
    const daily=m.daily;

    const now = new Date();
    const ns = now.toISOString().slice(0,13);
    let ci = times.findIndex(t=>t.startsWith(ns)); if(ci<0) ci=0;

    const cH=wH[ci]??0, cD=wDir[ci]??0, cP=wP[ci]??0;
    const cSwD=swD[ci]??cD, cSwP=swP[ci]??cP;
    const cWS=wndS[ci]??0, cWD=wndD[ci]??0;
    const r=rate(cH,cWS,cP);
    const energy=waveEnergy(cH,cP);
    const read=conditionsRead(cH,cWS,cWD,cSwP,cSwD,cD);
    const rColor=r==='good'||r==='epic'?'var(--good)':r==='fair'?'var(--fair)':r==='poor'?'var(--poor)':'var(--muted)';

    // Sun times
    const sun = getSunTimes(LAT, LNG, now);

    // Slots for 24hrs
    const slots=[];
    for(let i=ci;i<ci+24&&i<times.length;i+=3){
      slots.push({time:times[i],h:wH[i]??0,p:wP[i]??0,waveDir:wDir[i]??0,swDir:swD[i]??null,swP:swP[i]??0,ws:wndS[i]??0,wd:wndD[i]??0});
    }

    // Tides for today
    const tides = estimateTides(now);

    // Window alert
    const windowHTML = buildWindowAlert(slots, profile, sun, tides);

    // 7 day
    const days=daily.time.map((t,i)=>({time:t,h:daily.wave_height_max[i]??0,p:daily.wave_period_max[i]??0,dir:daily.wave_direction_dominant[i]??0}));

    app.innerHTML = `
      ${windowHTML}

      <div class="badge-row">
        <span class="badge badge-${r}">${rateLabel(r)}</span>
        <div class="conditions-read">${read}</div>
      </div>

      <div class="current-card">
        <div class="card-label">Now · ${now.toLocaleDateString('en-IE',{weekday:'long'})} ${fmtT(now.toISOString())}</div>
        <div class="current-grid">
          <div>
            <div class="c-val">${cH.toFixed(1)}<span class="c-unit">m</span></div>
            <div class="c-lbl">Wave Height</div>
          </div>
          <div>
            <div class="c-val">${cP.toFixed(0)}<span class="c-unit">s</span></div>
            <div class="c-lbl">Period</div>
          </div>
          <div>
            <div class="c-val">${(cH*3.281).toFixed(1)}<span class="c-unit">ft</span></div>
            <div class="c-lbl">In Feet</div>
          </div>
        </div>
        <div class="current-grid-bottom">
          <div>
            <div class="dir-display">
              ${dirArrowSVG(cSwD,'var(--fair)')}
              <div>
                <div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">${windDir(cSwD)}</div>
                <div class="c-lbl">Swell Direction</div>
              </div>
            </div>
          </div>
          <div>
            <div class="dir-display">
              ${dirArrowSVG(cWD,'rgba(255,255,255,0.6)')}
              <div>
                <div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">${cWS.toFixed(0)}<span class="c-unit">kn</span> ${windDir(cWD)}</div>
                <div class="c-lbl">Wind</div>
              </div>
            </div>
          </div>
          <div>
            <div class="c-val" style="color:${rColor}">${energy}<span class="c-unit">kJ/m</span></div>
            <div class="c-lbl">Wave Energy</div>
          </div>
        </div>
      </div>

      <div class="sec-label">Next 24 Hours</div>
      <table class="forecast-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Height</th>
            <th>Swell</th>
            <th>Wind</th>
            <th>Period</th>
            <th>Energy</th>
          </tr>
        </thead>
        <tbody>
          ${slots.map(s => {
            const sr = rate(s.h, s.ws, s.p);
            const dir = s.swDir ?? s.waveDir;
            const slotHour = new Date(s.time).getHours();
            const isDawn = Math.abs(slotHour - Math.floor(sun.sunrise)) <= 1;
            const isDusk = Math.abs(slotHour - Math.floor(sun.sunset)) <= 1;
            const isWork = profile.work === '9to5' && ![0,6].includes(new Date(s.time).getDay()) && slotHour >= 9 && slotHour <= 17;
            const en = waveEnergy(s.h, s.p);
            const tag = isDawn ? '<span class="row-tag dawn">First Light</span>' : isDusk ? '<span class="row-tag dusk">Last Light</span>' : isWork ? '<span class="row-tag avail">Work hours</span>' : '';
            return `<tr class="forecast-row ${sr}">
              <td><div class="row-time ${isDawn||isDusk?'highlight':''}">${fmtT(s.time)}${tag?'<br>'+tag:''}</div></td>
              <td><div class="row-height ${sr}">${s.h.toFixed(1)}<span class="row-unit">m</span></div></td>
              <td><div class="row-dir">${arrowChar(dir)} ${windDir(dir)}<br><span style="font-size:9px;opacity:0.5">${(s.swP||s.p).toFixed(0)}s</span></div></td>
              <td><div class="row-wind">${arrowChar(s.wd)} ${windDir(s.wd)}<br><span style="font-size:9px;opacity:0.5">${s.ws.toFixed(0)}kn</span></div></td>
              <td><div class="row-period">${s.p.toFixed(0)}s</div></td>
              <td><div class="row-energy">${en}</div></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>

      <div class="sec-label">Tides · Today</div>
      <div class="tide-grid">
        ${tides.map(t => `
          <div class="tide-card">
            <div class="tide-icon">${t.type==='high'?'↑':'↓'}</div>
            <div>
              <div class="tide-type">${t.type==='high'?'High':'Low'} Tide</div>
              <div class="tide-time">${fmtT(t.time.toISOString())}</div>
              <div class="tide-ht">~${t.height.toFixed(1)}m · estimate</div>
            </div>
          </div>`).join('')}
      </div>

      <div class="sec-label">First &amp; Last Light</div>
      <div class="tide-grid">
        <div class="tide-card">
          <div class="tide-icon" style="color:rgba(100,180,255,0.8)">☀</div>
          <div>
            <div class="tide-type">First Light</div>
            <div class="tide-time">${sun.sunriseStr}</div>
            <div class="tide-ht">Sunrise</div>
          </div>
        </div>
        <div class="tide-card">
          <div class="tide-icon" style="color:rgba(255,160,60,0.8)">☀</div>
          <div>
            <div class="tide-type">Last Light</div>
            <div class="tide-time">${sun.sunsetStr}</div>
            <div class="tide-ht">Sunset</div>
          </div>
        </div>
      </div>

      <div class="sec-label">7 Day Outlook</div>
      <div class="seven-grid">
        ${days.map(d=>{const dr=rate(d.h,10,d.p);return`
          <div class="day-card ${dr}">
            <div class="day-name">${fmtDay(d.time)}</div>
            <div class="day-height">${d.h.toFixed(1)}<span style="font-size:11px;opacity:0.4;letter-spacing:0">m</span></div>
            <div class="day-detail">${arrowChar(d.dir)} ${windDir(d.dir)}<br>${d.p.toFixed(0)}s period</div>
          </div>`;}).join('')}
      </div>
    `;
  } catch(e) {
    app.innerHTML = `<div class="status error">Couldn't load — ${e.message}</div>`;
  }
}

load();
</script>
</body>
</html>
