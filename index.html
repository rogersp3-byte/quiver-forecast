<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiver — Forecast</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f0f0f;--surface:#1a1a1a;--surface2:#222;
  --white:#fff;--muted:rgba(255,255,255,0.35);--faint:rgba(255,255,255,0.1);
  --good:#22c55e;--fair:#f5c800;--poor:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--white);font-family:'Archivo Black',sans-serif;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.07;mix-blend-mode:overlay;}

/* MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:1000;display:flex;align-items:center;justify-content:center;padding:24px;}
.modal-backdrop.hidden{display:none;}
.modal{background:var(--surface);max-width:480px;width:100%;padding:36px;border:1px solid rgba(255,255,255,0.1);}
.modal-title{font-size:22px;letter-spacing:-0.5px;margin-bottom:6px;}
.modal-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:32px;}
.field{margin-bottom:22px;}
.field-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:10px;display:block;}
.field select,.field input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.15);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:12px 14px;outline:none;appearance:none;transition:border-color 0.2s;}
.field select:focus,.field input:focus{border-color:rgba(255,255,255,0.4);}
.modal-btn{width:100%;background:var(--white);color:#0f0f0f;border:none;font-family:'Archivo Black',sans-serif;font-size:13px;letter-spacing:1px;padding:16px;cursor:pointer;transition:opacity 0.15s;}
.modal-btn:hover{opacity:0.9;}

/* HEADER */
header{padding:18px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--faint);}
.logo{font-size:18px;letter-spacing:2px;}
.logo-tag{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.main-nav{display:flex;gap:0;border:1px solid rgba(255,255,255,0.12);flex:1;margin:0 32px;}
.nav-link{flex:1;text-align:center;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:11px 20px;color:var(--muted);text-decoration:none;border-right:1px solid rgba(255,255,255,0.12);transition:all 0.15s;}
.nav-link:last-child{border-right:none;}
.nav-link:hover{color:var(--white);background:rgba(255,255,255,0.06);}
.nav-link.active{color:var(--white);background:rgba(255,255,255,0.08);}
.profile-btn{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid rgba(255,255,255,0.15);padding:7px 14px;cursor:pointer;}
.profile-btn:hover{border-color:rgba(255,255,255,0.35);color:rgba(255,255,255,0.7);}

/* SEARCH LANDING */
#searchPage{min-height:calc(100vh - 65px);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:clamp(32px,5vh,64px) 24px 40px;}
#searchPage.hidden{display:none;}
.search-landing-title{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:4px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:32px;text-align:center;}

/* GLOBE */
.globe-wrap{width:200px;height:200px;margin:0 auto 36px;position:relative;flex-shrink:0;align-self:center;}
.globe-canvas{display:block;border-radius:50%;}
@media(max-width:640px){
  .globe-wrap{width:150px;height:150px;margin-bottom:28px;}
}

.search-box-wrap{width:100%;max-width:520px;position:relative;align-self:center;}
.search-input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.18);color:var(--white);font-family:'DM Mono',monospace;font-size:14px;padding:18px 22px;outline:none;letter-spacing:1px;transition:border-color 0.2s;}
.search-input:focus{border-color:rgba(255,255,255,0.45);}
.search-input::placeholder{color:rgba(255,255,255,0.25);}
/* ── SEARCH RESULTS DROPDOWN ── */
.search-results{
  position:absolute;top:calc(100% + 1px);left:0;right:0;
  background:#111;border:1px solid rgba(255,255,255,0.14);border-top:none;
  z-index:20;display:none;max-height:380px;overflow-y:auto;
}
.search-results.show{display:block;}
.sr-region-header{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;
  color:rgba(255,255,255,0.25);padding:10px 18px 5px;
  border-top:1px solid rgba(255,255,255,0.06);
}
.sr-region-header:first-child{border-top:none;}
.search-result-item{
  padding:11px 18px 11px 24px;cursor:pointer;
  display:flex;align-items:baseline;justify-content:space-between;gap:12px;
  transition:background 0.1s;
}
.search-result-item:hover,.search-result-item.focused{background:rgba(255,255,255,0.06);}
.sri-name{font-size:13px;letter-spacing:0.3px;}
.sri-meta{font-family:'DM Mono',monospace;font-size:9px;color:rgba(255,255,255,0.28);white-space:nowrap;}
.sri-saved{color:rgba(245,200,0,0.7);margin-right:3px;}

/* SAVED SPOTS */
.saved-spots-section{width:100%;max-width:520px;margin-top:24px;}
.saved-spots-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.25);margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.saved-spots-label::before{content:'★';color:rgba(245,200,0,0.5);font-size:10px;}
.saved-spots-list{display:flex;flex-wrap:wrap;gap:6px;}
.saved-spot-chip{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:7px 14px;background:rgba(245,200,0,0.07);border:1px solid rgba(245,200,0,0.2);color:rgba(245,200,0,0.8);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:6px;}
.saved-spot-chip:hover{background:rgba(245,200,0,0.12);border-color:rgba(245,200,0,0.4);}
.saved-spot-chip .chip-remove{color:rgba(255,255,255,0.25);font-size:11px;margin-left:4px;line-height:1;}
.saved-spot-chip .chip-remove:hover{color:rgba(255,100,100,0.7);}
.search-hint{display:none;}
/* Spot index toggle button */
.spot-index-btn{
  width:100%;max-width:520px;margin-top:32px;align-self:center;
  font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2.5px;text-transform:uppercase;
  color:rgba(255,255,255,0.28);background:none;
  border:1px solid rgba(255,255,255,0.1);
  padding:13px 22px;cursor:pointer;text-align:left;
  display:flex;align-items:center;justify-content:space-between;
  transition:all 0.15s;
}
.spot-index-btn:hover{color:rgba(255,255,255,0.5);border-color:rgba(255,255,255,0.22);}
.spot-index-btn .sib-arrow{transition:transform 0.2s;display:inline-block;}
.spot-index-btn.open .sib-arrow{transform:rotate(180deg);}
/* Spot index panel */
.spot-index{
  width:100%;max-width:520px;align-self:center;
  border:1px solid rgba(255,255,255,0.1);border-top:none;
  display:none;background:#0d0d0d;
  max-height:420px;overflow-y:auto;
}
.spot-index.show{display:block;}
.si-region{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;
  color:rgba(255,255,255,0.22);padding:12px 18px 6px;
  border-top:1px solid rgba(255,255,255,0.06);
}
.si-region:first-child{border-top:none;}
.si-spot{
  padding:10px 18px 10px 28px;cursor:pointer;
  display:flex;align-items:baseline;justify-content:space-between;gap:12px;
  transition:background 0.1s;
}
.si-spot:hover{background:rgba(255,255,255,0.05);}
.si-spot-name{font-size:13px;letter-spacing:0.3px;}
.si-spot-meta{font-family:'DM Mono',monospace;font-size:9px;color:rgba(255,255,255,0.25);white-space:nowrap;}

/* FORECAST PAGE */
#forecastPage{display:none;touch-action:pan-y;}
#forecastPage.show{display:block;}

/* UNIT TOGGLE */
.unit-toggle{display:inline-flex;border:1px solid rgba(255,255,255,0.2);margin-top:14px;}
.unit-btn{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:6px 14px;background:none;border:none;color:var(--muted);cursor:pointer;transition:all 0.15s;}
.unit-btn.active{background:rgba(255,255,255,0.1);color:var(--white);}
.unit-btn:hover:not(.active){color:rgba(255,255,255,0.6);}

/* HERO */
.hero{padding:32px 28px 0;border-bottom:1px solid var(--faint);}
.hero-inner{max-width:900px;margin:0 auto;text-align:center;}
.area-name{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:4px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.break-name{font-size:clamp(36px,9vw,84px);letter-spacing:-2px;line-height:0.9;}
.break-loc{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:10px;}

/* SAVE SPOT BUTTON */
.save-spot-btn{display:inline-flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;background:none;border:1px solid rgba(255,255,255,0.18);color:rgba(255,255,255,0.4);padding:6px 14px;cursor:pointer;margin-top:12px;transition:all 0.15s;}
.save-spot-btn:hover{border-color:rgba(245,200,0,0.4);color:rgba(245,200,0,0.8);}
.save-spot-btn.saved{border-color:rgba(245,200,0,0.5);color:rgba(245,200,0,0.9);background:rgba(245,200,0,0.06);}
.save-spot-btn .star{font-size:11px;}

/* SPOT SELECTOR */
.spot-selector{display:flex;gap:0;margin-top:24px;border-top:1px solid var(--faint);}
.spot-btn{flex:1;padding:12px 6px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;background:none;border:none;border-right:1px solid var(--faint);color:var(--muted);cursor:pointer;transition:all 0.15s;text-align:center;position:relative;white-space:nowrap;}
.spot-btn:last-child{border-right:none;}
.spot-btn:hover{color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.03);}
.spot-btn.active{color:var(--white);background:rgba(255,255,255,0.05);}
.spot-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--white);}
.spot-btn .spot-badge{display:block;width:7px;height:7px;border-radius:50%;margin:0 auto 5px;background:var(--muted);}
.spot-btn.active .spot-badge{background:var(--white);}
.spot-badge.good-dot{background:var(--good)!important;}
.spot-badge.fair-dot{background:var(--fair)!important;}
.spot-badge.poor-dot{background:var(--poor)!important;}

.main{max-width:900px;margin:0 auto;padding:36px 24px 80px;}

/* SURF REPORT CARD (merged live + window) */
.surf-report-card{background:var(--surface);border:1px solid rgba(255,255,255,0.08);padding:22px 24px;margin-bottom:20px;position:relative;overflow:hidden;}
.surf-report-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.surf-report-card.good-card::before{background:var(--good);}
.surf-report-card.fair-card::before{background:var(--fair);}
.surf-report-card.poor-card::before{background:var(--poor);}
.surf-report-card.flat-card::before{background:var(--muted);}
.surf-report-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.surf-report-body{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:0.3px;color:rgba(255,255,255,0.8);line-height:1.8;font-style:italic;}
.surf-report-window{margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.07);font-family:'DM Mono',monospace;font-size:11px;color:rgba(255,255,255,0.6);line-height:1.7;font-style:normal;}
.surf-report-window-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:6px;}

/* SWELL WARNING */
.swell-warning{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.5px;color:rgba(255,165,0,0.85);background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.2);padding:10px 14px;margin-bottom:16px;font-style:italic;}

/* BADGE */
.badge{display:inline-block;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;padding:7px 18px;border:1.5px solid;white-space:nowrap;}
.badge-great,.badge-good{color:var(--good);border-color:var(--good);}
.badge-fair{color:var(--fair);border-color:var(--fair);}
.badge-poor{color:var(--poor);border-color:var(--poor);}
.badge-flat{color:var(--muted);border-color:var(--muted);}

/* CURRENT CARD */
.current-card{background:var(--surface);padding:28px;margin-bottom:4px;}
.card-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:22px;}
.current-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;}
.current-grid-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:24px;padding-top:24px;border-top:1px solid var(--faint);}
.c-val{font-size:clamp(22px,3.5vw,38px);letter-spacing:-1px;line-height:1;}
.c-unit{font-size:0.42em;opacity:0.4;letter-spacing:0;}
.c-lbl{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.7);margin-top:7px;}
.c-sub{font-family:'DM Mono',monospace;font-size:9px;color:rgba(255,255,255,0.35);margin-top:3px;}
.dir-display{display:flex;align-items:center;gap:12px;}
.dir-arrow{width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,0.2);border-radius:50%;flex-shrink:0;}
.dir-arrow svg{width:18px;height:18px;}

/* BUOY BADGE */
.buoy-tag{display:inline-block;font-family:'DM Mono',monospace;font-size:7px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 7px;background:rgba(100,180,255,0.12);color:rgba(100,180,255,0.8);border:1px solid rgba(100,180,255,0.2);margin-bottom:10px;}

/* SECONDARY SWELL */
.swell-secondary{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:14px 20px;margin-top:4px;display:flex;gap:24px;align-items:center;flex-wrap:wrap;}
.swell-sec-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:4px;}
.swell-sec-val{font-family:'Archivo Black',sans-serif;font-size:16px;letter-spacing:-0.5px;}
.swell-sec-item{min-width:80px;}

/* SECTION LABEL */
.sec-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.65);margin:28px 0 8px;display:flex;align-items:center;gap:10px;}
.sec-label::before{content:'';width:16px;height:1px;background:rgba(255,255,255,0.4);}

/* GRAPH */
.graph-wrap{background:var(--surface);padding:24px 20px 16px;margin-bottom:4px;overflow:hidden;}
.graph-canvas{width:100%;height:140px;display:block;}

/* FORECAST TABLE — MOBILE CARDS */
.forecast-table{width:100%;border-collapse:collapse;}
.forecast-table th{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:8px 10px;text-align:left;border-bottom:1px solid var(--faint);}
.forecast-table th:not(:first-child){text-align:center;}
.forecast-row{border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s;border-left:3px solid transparent;}
.forecast-row:hover{background:var(--surface2);}
.forecast-row.good,.forecast-row.great{border-left-color:var(--good);}
.forecast-row.fair{border-left-color:var(--fair);}
.forecast-row.poor{border-left-color:var(--poor);}
.forecast-row td{padding:11px 10px;vertical-align:middle;}
.row-time{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;color:rgba(255,255,255,0.5);white-space:nowrap;}
.row-height{font-size:18px;letter-spacing:-0.5px;text-align:center;}
.row-height.good,.row-height.great{color:var(--good);}
.row-height.fair{color:var(--fair);}
.row-height.poor{color:var(--poor);}
.row-unit{font-size:10px;opacity:0.4;}
.row-dir,.row-wind{font-family:'DM Mono',monospace;font-size:10px;text-align:center;color:rgba(255,255,255,0.7);line-height:1.6;}
.row-period{font-family:'DM Mono',monospace;font-size:11px;text-align:center;color:rgba(255,255,255,0.6);}
.row-tag{display:inline-block;font-family:'DM Mono',monospace;font-size:7px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 6px;margin-top:2px;}
.row-tag.dawn{background:rgba(100,150,255,0.15);color:rgba(100,180,255,0.8);}
.row-tag.dusk{background:rgba(255,160,60,0.15);color:rgba(255,180,80,0.8);}
.row-tag.work{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.4);}

/* MOBILE FORECAST CARDS */
.forecast-cards{display:none;gap:4px;flex-direction:column;}
.fc-card{background:var(--surface);padding:14px 16px;border-left:3px solid transparent;display:grid;grid-template-columns:80px 1fr 1fr;align-items:center;gap:12px;}
.fc-card.great,.fc-card.good{border-left-color:var(--good);}
.fc-card.fair{border-left-color:var(--fair);}
.fc-card.poor{border-left-color:var(--poor);}
.fc-time{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;color:rgba(255,255,255,0.5);}
.fc-height{font-size:22px;letter-spacing:-1px;text-align:center;}
.fc-height.great,.fc-height.good{color:var(--good);}
.fc-height.fair{color:var(--fair);}
.fc-height.poor{color:var(--poor);}
.fc-meta{font-family:'DM Mono',monospace;font-size:9px;color:rgba(255,255,255,0.45);line-height:1.8;}

/* 7 DAY — ENHANCED */
.seven-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.day-card{background:var(--surface);padding:10px 4px;text-align:center;border-top:2px solid transparent;position:relative;box-sizing:border-box;overflow:hidden;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;min-width:0;}
.day-card.great,.day-card.good{border-top-color:var(--good);}
.day-card.fair{border-top-color:var(--fair);}
.day-card.poor{border-top-color:var(--poor);}
.day-card::after{content:'';position:absolute;inset:0;opacity:0.04;pointer-events:none;}
.day-card.great::after,.day-card.good::after{background:var(--good);}
.day-card.fair::after{background:var(--fair);}
.day-card.poor::after{background:var(--poor);}
.day-name{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:0.5px;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.day-card.today .day-name{color:rgba(245,200,0,0.8);}

.day-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.4);}
.day-expand{
  display:none;position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,0.85);
  align-items:center;justify-content:center;padding:24px;
}
.day-expand.open{display:flex;}
.day-expand-card{
  background:#141410;border:1px solid rgba(245,200,0,0.2);
  padding:28px 32px;max-width:420px;width:100%;position:relative;
}
.day-expand-close{
  position:absolute;top:14px;right:16px;
  font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;
  color:rgba(255,255,255,0.4);cursor:pointer;background:none;border:none;
  text-transform:uppercase;
}
.day-expand-close:hover{color:rgba(245,200,0,0.8);}
.day-expand-date{
  font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;
  text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:16px;
}
.day-expand-rating{
  font-size:11px;font-family:'DM Mono',monospace;letter-spacing:2px;
  text-transform:uppercase;margin-bottom:20px;
}
.day-expand-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;
}
.day-expand-item .dei-label{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;
  text-transform:uppercase;color:rgba(255,255,255,0.35);margin-bottom:4px;
}
.day-expand-item .dei-val{
  font-size:22px;font-weight:700;
}
.day-expand-item .dei-unit{
  font-size:12px;opacity:0.5;margin-left:2px;
}
.day-expand-item .dei-sub{
  font-family:'DM Mono',monospace;font-size:10px;color:rgba(255,255,255,0.4);margin-top:2px;
}
.day-height{font-size:clamp(13px,1.5vw,18px);letter-spacing:-0.5px;}
.day-card.great .day-height,.day-card.good .day-height{color:var(--good);}
.day-card.fair .day-height{color:var(--fair);}
.day-card.poor .day-height{color:var(--poor);}
.day-unit{font-size:9px;opacity:0.35;letter-spacing:0;}
.day-badge{font-family:'DM Mono',monospace;font-size:6px;letter-spacing:0.5px;text-transform:uppercase;padding:2px 4px;margin:4px auto;border:1px solid;display:block;width:fit-content;}
.day-card.great .day-badge,.day-card.good .day-badge{color:var(--good);border-color:rgba(34,197,94,0.3);}
.day-card.fair .day-badge{color:var(--fair);border-color:rgba(245,200,0,0.3);}
.day-card.poor .day-badge{color:var(--poor);border-color:rgba(239,68,68,0.3);}
.day-detail{display:none;}

/* TIDE SIMPLE CARDS */
.tide-simple-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:3px;margin-bottom:4px;}
.tide-simple-card{background:var(--surface);padding:18px 16px;display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;}
.tide-simple-icon{opacity:0.85;}
.tide-simple-type{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.tide-simple-time{font-size:24px;letter-spacing:-1px;line-height:1;}
.tide-high .tide-simple-time{color:rgba(100,180,255,0.9);}
.tide-low .tide-simple-time{color:rgba(255,255,255,0.7);}
.tide-simple-ht{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
.tide-simple-day{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:2px;}

/* TIDES (old cards kept for fallback) */
.tide-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:3px;}
.tide-card{background:var(--surface);padding:16px 18px;display:flex;align-items:center;gap:14px;}
.tide-icon{flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.tide-type{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.tide-time{font-size:20px;letter-spacing:-0.5px;}
.tide-ht{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:2px;}

/* CHANGE SPOT BUTTON — prominent */
.change-spot-btn{display:inline-flex;align-items:center;gap:8px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.75);padding:12px 22px;cursor:pointer;transition:all 0.2s;margin-top:4px;}
.change-spot-btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.6);color:#fff;}
.change-spot-btn svg{width:14px;height:14px;stroke:currentColor;stroke-width:2;fill:none;}

/* SPOT INFO */
.spot-info{background:var(--surface);padding:16px 20px;margin-bottom:20px;display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start;border-left:3px solid rgba(255,255,255,0.15);}
.spot-info-item{min-width:100px;}
.spot-info-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.spot-info-val{font-family:'DM Mono',monospace;font-size:11px;color:rgba(255,255,255,0.8);line-height:1.5;}

/* LIGHT SECTION */
.light-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px;}
.light-card{background:var(--surface);padding:16px 20px;display:flex;align-items:center;gap:14px;}
.light-icon{flex-shrink:0;}
.light-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.light-time{font-size:22px;letter-spacing:-0.5px;}
.light-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:2px;}

.status{text-align:center;padding:80px 24px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.status.error{color:var(--poor);}
.disclaimer{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.5px;color:rgba(255,255,255,0.25);text-align:center;padding:24px 20px;border-top:1px solid var(--faint);margin-top:28px;line-height:1.8;font-style:italic;}

/* SWIPE OVERLAY */
#swipeHint{position:fixed;left:0;top:0;bottom:0;width:48px;pointer-events:none;z-index:100;opacity:0;transition:opacity 0.2s;}
#swipeHint.visible{opacity:1;}
#swipeHint-inner{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.4);writing-mode:vertical-rl;text-orientation:mixed;}

/* MOBILE BOTTOM NAV */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,10,0.97);border-top:1px solid rgba(255,255,255,0.1);z-index:500;padding:10px 0 max(10px,env(safe-area-inset-bottom));backdrop-filter:blur(12px);}
.bottom-nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;color:rgba(255,255,255,0.35);text-decoration:none;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;transition:color 0.15s;padding:4px 0;}
.bottom-nav-item svg{width:20px;height:20px;}
.bottom-nav-item:hover,.bottom-nav-item.active{color:#fff;}
.bottom-nav-item.active svg{stroke:#f5c800;}

@media(max-width:540px){
  .seven-grid{grid-template-columns:repeat(4,1fr);gap:3px;}
}
@media(max-width:640px){
  .bottom-nav{display:flex;}
  .main-nav{display:none!important;}
  body{padding-bottom:72px;}
  .current-grid{grid-template-columns:repeat(2,1fr);}
  .current-grid-bottom{grid-template-columns:repeat(2,1fr);}
  header{padding:14px 18px;}
  .hero{padding:20px 18px 0;}
  .main{padding:24px 16px 60px;}
  .current-card{padding:20px;}
  /* Hide table on mobile, show cards */
  .forecast-table-wrap{display:none;}
  .forecast-cards{display:flex;}
  .spot-btn{font-size:8px;padding:10px 3px;}
  #searchPage{padding:28px 18px;}
  .globe-wrap{width:150px;height:150px;margin-bottom:28px;}
  .globe-canvas{width:150px;height:150px;}
  .seven-grid{grid-template-columns:repeat(4,1fr);gap:3px;}
}
</style>
</head>
<body>

<div class="modal-backdrop hidden" id="modal">
  <div class="modal">
    <div class="modal-title">Edit Profile</div>
    <div class="modal-sub">Updates across the whole app</div>
    <div class="field"><label class="field-label">Your Name</label><input type="text" id="p-name" placeholder="e.g. Conor"/></div>
    <div class="field">
      <label class="field-label">Skill Level</label>
      <select id="p-skill">
        <option value="beginner">Beginner — still learning to stand up</option>
        <option value="intermediate">Intermediate — comfortable on green waves</option>
        <option value="advanced" selected>Advanced — surfing most conditions</option>
        <option value="expert">Expert — I'm a hell man and will charge anything</option>
      </select>
    </div>
    <div class="field">
      <label class="field-label">Work Schedule</label>
      <select id="p-work">
        <option value="9to5" selected>9–5 weekdays (weekends free)</option>
        <option value="flexible">Flexible / remote</option>
        <option value="shift">Shift work — varies</option>
        <option value="retired">Retired / student</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveProfile()">Save →</button>
  </div>
</div>

<header>
  <div><div class="logo">QUIVER</div><div class="logo-tag">Surf Guide</div></div>
  <nav class="main-nav">
    <a href="index.html" class="nav-link active">Forecast</a>
    <a href="workshop.html" class="nav-link">Workshop</a>
    <a href="trip.html" class="nav-link">Trip</a>
  </nav>
  <button class="profile-btn" onclick="openModal()">Edit Profile</button>
</header>

<!-- SEARCH LANDING -->
<div id="searchPage">
  <div class="globe-wrap">
    <canvas class="globe-canvas" id="globeCanvas" width="400" height="400"></canvas>
  </div>

  <div class="search-box-wrap">
    <input class="search-input" id="searchInput" placeholder="Search a spot..."
      autocomplete="off" spellcheck="false"
      oninput="onSearch(this.value)"
      onkeydown="onSearchKey(event)"
      onblur="setTimeout(()=>{document.getElementById('searchResults').classList.remove('show');},180)"/>
    <div class="search-results" id="searchResults"></div>
  </div>

  <button class="spot-index-btn" id="spotIndexBtn" onclick="toggleSpotIndex()">
    See spot index <span class="sib-arrow">↓</span>
  </button>
  <div class="spot-index" id="spotIndex"></div>

  <div class="saved-spots-section" id="savedSpotsSection" style="display:none;margin-top:20px;">
    <div class="saved-spots-label">Saved Spots</div>
    <div class="saved-spots-list" id="savedSpotsList"></div>
  </div>
</div>

<!-- FORECAST PAGE -->
<div id="forecastPage">
  <div id="swipeHint"><div id="swipeHint-inner">← back</div></div>
  <div class="hero">
    <div class="hero-inner">
      <div class="area-name" id="heroRegion">Ireland</div>
      <div class="break-name" id="heroName">—</div>
      <div class="break-loc" id="heroLoc"></div>
      <div style="display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;">
        <div class="unit-toggle">
          <button class="unit-btn active" id="btnFt" onclick="setUnit('ft')">ft</button>
          <button class="unit-btn" id="btnM" onclick="setUnit('m')">m</button>
        </div>
        <button class="save-spot-btn" id="saveSpotBtn" onclick="toggleSaveSpot()">
          <span class="star">☆</span><span id="saveSpotLabel">Save Spot</span>
        </button>
      </div>
    </div>
    <div style="max-width:900px;margin:0 auto;">
      <div class="spot-selector" id="spotSelector"></div>
    </div>
  </div>
  <main class="main">
    <div id="app"><div class="status">Loading forecast...</div></div>
  </main>
</div>

<script>
// ── ALL SPOTS ──
const ALL_SPOTS = [
  // tideStation: nearest Marine Institute IMI_TidePrediction_HighLow station ID
  {id:'beach',    name:'Spanish Point Beach', shortName:'Beach',       region:'Clare',   group:'spanish-point', groupName:'Spanish Point', lat:52.841486, lng:-9.435728, beachFacing:270, swellWindow:[247,315], level:'Beginner to intermediate', waveType:'Beach break',  useBuoy:false, tidePreference:'any',     tideStation:'Kilrush'},
  {id:'inner',    name:'Inner Reef',          shortName:'Inner Reef',  region:'Clare',   group:'spanish-point', groupName:'Spanish Point', lat:52.844650, lng:-9.443633, beachFacing:225, swellWindow:[202,292], level:'Intermediate and above',   waveType:'A-frame',      useBuoy:false, tidePreference:'mid',     tideStation:'Kilrush'},
  {id:'middle',   name:'Middle Reef',         shortName:'Middle Reef', region:'Clare',   group:'spanish-point', groupName:'Spanish Point', lat:52.845419, lng:-9.449256, beachFacing:225, swellWindow:[202,292], level:'Intermediate and above',   waveType:'Right hander', useBuoy:false, tidePreference:'low-mid', tideStation:'Kilrush'},
  {id:'lahinch',  name:'Lahinch Beach',       shortName:'Lahinch',     region:'Clare',   group:'lahinch',       groupName:'Lahinch',       lat:52.933056, lng:-9.344167, beachFacing:270, swellWindow:[225,315], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'any',     tideStation:'Lahinch_MODELLED'},
  {id:'bundoran', name:'Bundoran Peak',       shortName:'The Peak',    region:'Donegal', group:'bundoran',      groupName:'Bundoran',      lat:54.477222, lng:-8.277778, beachFacing:247, swellWindow:[225,315], level:'Intermediate and above',   waveType:'Reef break',   useBuoy:false, tidePreference:'any',     tideStation:'Killybegs'},
  {id:'whiterock',name:'White Rock',          shortName:'White Rock',  region:'Dublin',  group:'dublin-south',  groupName:'Dublin South',  lat:53.266083, lng:-6.105183, beachFacing:90,  swellWindow:[135,180], level:'All levels',               waveType:'Beach break',  useBuoy:true,  tidePreference:'low',     tideStation:'Dublin_Port', minSwellH:2.0},
  {id:'killiney', name:'Killiney',            shortName:'Killiney',    region:'Dublin',  group:'dublin-south',  groupName:'Dublin South',  lat:53.256386, lng:-6.111353, beachFacing:90,  swellWindow:[0,60],    level:'All levels',               waveType:'Beach break',  useBuoy:true,  tidePreference:'low',     tideStation:'Dublin_Port', minSwellH:2.0},

  // ── LAHINCH REEFS ──
  {id:'cornish',  name:'Cornish',             shortName:'Cornish',     region:'Clare',   group:'lahinch',       groupName:'Lahinch',       lat:52.929472, lng:-9.349553, beachFacing:270, swellWindow:[225,315], level:'Intermediate and above',   waveType:'Beach break',  useBuoy:false, tidePreference:'mid',     tideStation:'Lahinch_MODELLED'},
  {id:'shits',    name:'Shits',               shortName:'Shits',       region:'Clare',   group:'lahinch',       groupName:'Lahinch',       lat:52.928136, lng:-9.351014, beachFacing:270, swellWindow:[225,315], level:'Intermediate and above',   waveType:'Beach break',  useBuoy:false, tidePreference:'mid',     tideStation:'Lahinch_MODELLED'},
  {id:'cregg',    name:'Cregg Reef',          shortName:'Cregg Reef',  region:'Clare',   group:'lahinch',       groupName:'Lahinch',       lat:52.923233, lng:-9.354639, beachFacing:270, swellWindow:[225,315], level:'Advanced and above',       waveType:'Reef break',   useBuoy:false, tidePreference:'mid',     tideStation:'Lahinch_MODELLED'},

  // ── BUNDORAN ──
  {id:'tullan',   name:'Tullan Strand',       shortName:'Tullan',      region:'Donegal', group:'bundoran',      groupName:'Bundoran',      lat:54.494700, lng:-8.266700, beachFacing:270, swellWindow:[247,340], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'low-mid', tideStation:'Killybegs'},

  // ── ROSSKNOWLAGH ──
  {id:'rossnowlagh', name:'Rossnowlagh',      shortName:'Rossnowlagh', region:'Donegal', group:'rossnowlagh',   groupName:'Rossnowlagh',   lat:54.551967, lng:-8.213653, beachFacing:247, swellWindow:[202,315], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'mid-high',tideStation:'Killybegs'},

  // ── STRANDHILL ──
  {id:'strandhill', name:'Strandhill',        shortName:'Strandhill',  region:'Sligo',   group:'strandhill',    groupName:'Strandhill',    lat:54.268400, lng:-8.597800, beachFacing:292, swellWindow:[247,340], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'high',    tideStation:'Sligo'},

  // ── WICKLOW ──
  {id:'magheramore', name:'Magheramore',      shortName:'Magheramore', region:'Wicklow', group:'wicklow',       groupName:'Wicklow',       lat:52.930267, lng:-6.021939, beachFacing:90,  swellWindow:[45,135],  level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'any',     tideStation:'Wicklow', minSwellH:1.5},

  // ── WATERFORD ──
  {id:'tramore',  name:'Tramore',             shortName:'Tramore',     region:'Waterford',group:'waterford',    groupName:'Waterford',     lat:52.155800, lng:-7.151900, beachFacing:180, swellWindow:[135,247], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'any',     tideStation:'Dunmore_East'},

  // ── CORK ──
  {id:'inchidoney', name:'Inchidoney',        shortName:'Inchidoney',  region:'Cork',    group:'cork',          groupName:'Cork',          lat:51.594258, lng:-8.862969, beachFacing:225, swellWindow:[180,292], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'any',     tideStation:'Cork_Harbour'},

  // ── KERRY ──
  {id:'inch',     name:'Inch Beach',          shortName:'Inch',        region:'Kerry',   group:'kerry',         groupName:'Kerry',         lat:52.133400, lng:-9.998600, beachFacing:270, swellWindow:[225,315], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'any',     tideStation:'Tarbert'},
  {id:'banna',    name:'Banna Strand',        shortName:'Banna',       region:'Kerry',   group:'kerry',         groupName:'Kerry',         lat:52.338689, lng:-9.837739, beachFacing:270, swellWindow:[225,340], level:'All levels',               waveType:'Beach break',  useBuoy:false, tidePreference:'any',     tideStation:'Tarbert'},
];

function getSpotsInGroup(g){return ALL_SPOTS.filter(s=>s.group===g);}

let currentSpot = ALL_SPOTS[0];
let currentGroup = getSpotsInGroup('spanish-point');
let currentUnit = 'ft';

function setUnit(u){
  currentUnit=u;
  document.getElementById('btnFt').classList.toggle('active',u==='ft');
  document.getElementById('btnM').classList.toggle('active',u==='m');
  if(document.getElementById('forecastPage').classList.contains('show'))load();
}
function displayH(hs){
  if(currentUnit==='ft') return (hs*0.7*3.281).toFixed(1);
  return hs.toFixed(1);
}
function displayUnit(){return currentUnit==='ft'?'ft':'m';}

// ── SAVED SPOTS ──
function getSavedSpots(){
  try{return JSON.parse(localStorage.getItem('quiver_saved'))||[];}
  catch(e){return[];}
}
function isSpotSaved(id){return getSavedSpots().includes(id);}
function toggleSaveSpot(){
  const id=currentSpot.id;
  let saved=getSavedSpots();
  if(saved.includes(id)){saved=saved.filter(s=>s!==id);}
  else{saved.push(id);}
  try{localStorage.setItem('quiver_saved',JSON.stringify(saved));}catch(e){}
  updateSaveBtn();
  renderSavedSpots();
}
function updateSaveBtn(){
  const btn=document.getElementById('saveSpotBtn');
  const lbl=document.getElementById('saveSpotLabel');
  if(!btn||!lbl)return;
  const saved=isSpotSaved(currentSpot.id);
  btn.classList.toggle('saved',saved);
  btn.querySelector('.star').textContent=saved?'★':'☆';
  lbl.textContent=saved?'Saved':'Save Spot';
}
function renderSavedSpots(){
  const saved=getSavedSpots();
  const sec=document.getElementById('savedSpotsSection');
  const list=document.getElementById('savedSpotsList');
  if(!sec||!list)return;
  if(saved.length===0){sec.style.display='none';return;}
  sec.style.display='block';
  list.innerHTML=saved.map(id=>{
    const s=ALL_SPOTS.find(x=>x.id===id);
    if(!s)return'';
    return'<div class="saved-spot-chip" onclick="selectSpot(\''+id+'\')">'
      +'<span>★</span>'+s.groupName
      +'<span class="chip-remove" onclick="event.stopPropagation();removeSaved(\''+id+'\')">×</span>'
      +'</div>';
  }).join('');
}
function removeSaved(id){
  let saved=getSavedSpots().filter(s=>s!==id);
  try{localStorage.setItem('quiver_saved',JSON.stringify(saved));}catch(e){}
  renderSavedSpots();
}

// ── PROFILE ──
function getProfile(){
  try{const p=JSON.parse(localStorage.getItem('quiver_profile'));return p&&p.skill?p:null;}
  catch(e){return null;}
}
function saveProfile(){
  try{
    const name=document.getElementById('p-name').value.trim()||'Surfer';
    const skill=document.getElementById('p-skill').value;
    const work=document.getElementById('p-work').value;
    localStorage.setItem('quiver_profile',JSON.stringify({name,skill,work}));
  }catch(e){}
  document.getElementById('modal').classList.add('hidden');
}
function openModal(){
  const p=getProfile();
  if(p){
    document.getElementById('p-name').value=p.name||'';
    ['p-skill','p-work'].forEach(id=>{
      const s=document.getElementById(id);
      const key=id==='p-skill'?'skill':'work';
      [...s.options].forEach(o=>o.selected=o.value===p[key]);
    });
  }
  document.getElementById('modal').classList.remove('hidden');
}
document.getElementById('modal').addEventListener('click',function(e){if(e.target===this)this.classList.add('hidden');});

// ── SWIPE TO GO BACK ──
(function(){
  let startX=0,startY=0,tracking=false;
  const fp=document.getElementById('forecastPage');
  fp.addEventListener('touchstart',function(e){
    if(e.touches[0].clientX<40){startX=e.touches[0].clientX;startY=e.touches[0].clientY;tracking=true;}
  },{passive:true});
  fp.addEventListener('touchmove',function(e){
    if(!tracking)return;
    const dx=e.touches[0].clientX-startX,dy=e.touches[0].clientY-startY;
    if(dx>20&&Math.abs(dy)<60){
      const hint=document.getElementById('swipeHint');
      const prog=Math.min(dx/120,1);
      hint.style.opacity=prog*0.8;
    }
  },{passive:true});
  fp.addEventListener('touchend',function(e){
    if(!tracking)return;
    tracking=false;
    document.getElementById('swipeHint').style.opacity=0;
    const dx=e.changedTouches[0].clientX-startX,dy=e.changedTouches[0].clientY-startY;
    if(dx>80&&Math.abs(dy)<80)showSearch();
  },{passive:true});
})();

// ── SEARCH HELPERS ──
const REGION_ORDER=['Clare','Donegal','Sligo','Kerry','Cork','Waterford','Wicklow','Dublin'];

function groupSpotsByRegion(spots){
  const seen={},byRegion={};
  spots.forEach(s=>{
    if(seen[s.group])return; seen[s.group]=true;
    const r=s.region||'Ireland';
    if(!byRegion[r])byRegion[r]=[];
    byRegion[r].push(s);
  });
  const regions=Object.keys(byRegion).sort((a,b)=>{
    const ai=REGION_ORDER.indexOf(a),bi=REGION_ORDER.indexOf(b);
    if(ai>=0&&bi>=0)return ai-bi;
    if(ai>=0)return -1; if(bi>=0)return 1;
    return a.localeCompare(b);
  });
  return{byRegion,regions};
}

function renderSpotRows(spots){
  const{byRegion,regions}=groupSpotsByRegion(spots);
  let h='';
  regions.forEach(region=>{
    if(regions.length>1)h+='<div class="sr-region-header">'+region+'</div>';
    byRegion[region].forEach(s=>{
      const gs=getSpotsInGroup(s.group);
      const meta=[gs.length>1?gs.length+' breaks':'',s.waveType].filter(Boolean).join(' · ');
      const saved=isSpotSaved(s.id)?'<span class="sri-saved">★</span>':'';
      h+='<div class="search-result-item" onmousedown="selectSpot(\''+s.id+'\')">'+
        '<span class="sri-name">'+saved+s.groupName+'</span>'+
        (meta?'<span class="sri-meta">'+meta+'</span>':'')+
        '</div>';
    });
  });
  return h;
}

function renderIndexRows(spots){
  const{byRegion,regions}=groupSpotsByRegion(spots);
  let h='';
  regions.forEach(region=>{
    h+='<div class="si-region">'+region+'</div>';
    byRegion[region].forEach(s=>{
      const gs=getSpotsInGroup(s.group);
      const meta=[gs.length>1?gs.length+' breaks':'',s.waveType].filter(Boolean).join(' · ');
      const saved=isSpotSaved(s.id)?'★ ':'';
      h+='<div class="si-spot" onmousedown="selectSpot(\''+s.id+'\')">'+
        '<span class="si-spot-name">'+saved+s.groupName+'</span>'+
        (meta?'<span class="si-spot-meta">'+meta+'</span>':'')+
        '</div>';
    });
  });
  return h;
}

// ── SEARCH ──
let _searchFocusIdx=-1;

function onSearch(val){
  const q=val.trim().toLowerCase();
  _searchFocusIdx=-1;
  const res=document.getElementById('searchResults');
  // Empty — hide dropdown cleanly
  if(!q){res.classList.remove('show');res.innerHTML='';return;}
  const matches=ALL_SPOTS.filter(s=>(s.name+' '+s.groupName+' '+s.region).toLowerCase().includes(q));
  if(!matches.length){
    res.innerHTML='<div class="search-result-item" style="padding:14px 18px;color:rgba(255,255,255,0.3);font-family:\'DM Mono\',monospace;font-size:11px;letter-spacing:1px;">No spots found</div>';
  }else{
    res.innerHTML=renderSpotRows(matches);
  }
  res.classList.add('show');
}

function onSearchKey(e){
  const items=document.querySelectorAll('#searchResults .search-result-item');
  if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();_searchFocusIdx=Math.min(_searchFocusIdx+1,items.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();_searchFocusIdx=Math.max(_searchFocusIdx-1,0);}
  else if(e.key==='Enter'){if(_searchFocusIdx>=0)items[_searchFocusIdx].dispatchEvent(new MouseEvent('mousedown'));return;}
  else if(e.key==='Escape'){document.getElementById('searchResults').classList.remove('show');return;}
  items.forEach((el,i)=>el.classList.toggle('focused',i===_searchFocusIdx));
  if(_searchFocusIdx>=0)items[_searchFocusIdx].scrollIntoView({block:'nearest'});
}

// ── SPOT INDEX ──
function toggleSpotIndex(){
  const panel=document.getElementById('spotIndex');
  const btn=document.getElementById('spotIndexBtn');
  const opening=!panel.classList.contains('show');
  panel.classList.toggle('show',opening);
  btn.classList.toggle('open',opening);
  if(opening&&!panel.innerHTML.trim())panel.innerHTML=renderIndexRows(ALL_SPOTS);
}

function selectSpot(id){
  const spot=ALL_SPOTS.find(s=>s.id===id)||ALL_SPOTS[0];
  currentSpot=spot;
  currentGroup=getSpotsInGroup(spot.group);
  document.getElementById('searchResults').classList.remove('show');
  document.getElementById('searchInput').value='';
  setTimeout(showForecast,200);
}

function showForecast(){
  document.getElementById('searchPage').classList.add('hidden');
  const fp=document.getElementById('forecastPage');
  fp.classList.add('show');
  // Scroll forecast page to top
  window.scrollTo(0,0);
  updateHero();
  updateSaveBtn();
  buildSelector([]);
  load();
}

function showSearch(){
  const fp=document.getElementById('forecastPage');
  fp.classList.remove('show');
  document.getElementById('app').innerHTML='<div class="status">Loading forecast...</div>';
  document.getElementById('searchPage').classList.remove('hidden');
  // Close index and clear search when returning to search page
  document.getElementById('spotIndex').classList.remove('show');
  document.getElementById('spotIndexBtn').classList.remove('open');
  document.getElementById('searchResults').classList.remove('show');
  document.getElementById('searchInput').value='';
  window.scrollTo(0,0);
  renderSavedSpots();
}

function updateHero(){
  const s=currentSpot;
  const words=s.groupName.toUpperCase().split(' ');
  const mid=Math.ceil(words.length/2);
  document.getElementById('heroName').innerHTML=words.length>1?words.slice(0,mid).join(' ')+'<br>'+words.slice(mid).join(' '):words[0];
  document.getElementById('heroRegion').textContent=s.region+' · Ireland';
  document.getElementById('heroLoc').textContent=s.lat.toFixed(4)+'° N, '+Math.abs(s.lng).toFixed(4)+'° W';
}

function switchSpot(id){
  currentSpot=ALL_SPOTS.find(s=>s.id===id)||currentSpot;
  updateHero();
  updateSaveBtn();
  load();
}

function buildSelector(dotRatings){
  const sel=document.getElementById('spotSelector');
  sel.innerHTML=currentGroup.map(function(s,i){
    const r=dotRatings[i]||'';
    const dc=r==='good'||r==='great'?'good-dot':r==='fair'?'fair-dot':r==='poor'?'poor-dot':'';
    return '<button class="spot-btn'+(s.id===currentSpot.id?' active':'')+'" onclick="switchSpot(\''+s.id+'\')">'
      +'<span class="spot-badge '+dc+'"></span>'+s.shortName+'</button>';
  }).join('');
}

// ── HELPERS ──
function windDir(d){return['N','NE','E','SE','S','SW','W','NW'][Math.round(d/45)%8];}
function arrowChar(d){return['↓','↙','←','↖','↑','↗','→','↘'][Math.round(d/45)%8];}
function dirArrowSVG(deg,color){
  return '<div class="dir-arrow"><svg viewBox="0 0 24 24" style="transform:rotate('+(deg+180)+'deg)" fill="none" stroke="'+color+'" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="6 11 12 5 18 11"/></svg></div>';
}
function waveEnergy(h,t){return Math.round((1025*9.81*9.81*h*h*t)/(32*Math.PI*1000));}
function isOffshore(wd,spot){const d=((wd-spot.beachFacing)+360)%360;return d>90&&d<270;}
function swellInWindow(sd,spot){const lo=spot.swellWindow[0],hi=spot.swellWindow[1];return lo<=hi?sd>=lo&&sd<=hi:sd>=lo||sd<=hi;}
function skillThresholds(skill){
  return{beginner:{minH:0.3,maxH:1.0,minP:6},intermediate:{minH:0.5,maxH:1.8,minP:7},advanced:{minH:0.8,maxH:3.5,minP:8},expert:{minH:1.2,maxH:99,minP:9}}[skill]||{minH:0.5,maxH:99,minP:7};
}
function rate(h,w,p,skill){
  const t=skillThresholds(skill||'advanced');
  if(h<0.3)return'flat';
  const sOk=h>=t.minH&&h<=t.maxH;
  // Base rating from height + wind
  // Wind thresholds in mph (applied to effective wind — already discounted for offshore)
  let r;
  if(sOk&&w<10)r='great';
  else if(sOk&&w<18)r='good';
  else if(sOk&&w<22)r='fair';
  else r='poor';
  // Period adjustment — soft signal, not a hard cutoff
  // >=10s: no penalty
  // 7-9s:  cap at good (great→good), still surfable
  // <7s:   drop one level (choppy wind swell)
  if(p<7){
    if(r==='great')r='fair';
    else if(r==='good')r='fair';
    else if(r==='fair')r='poor';
  } else if(p<10){
    if(r==='great')r='good';
  }
  return r;
}
function rateLabel(r){return{great:'Good',good:'Good',fair:'Fair',poor:'Poor',flat:'Flat'}[r];}
function windDesc(ws,wd,spot){
  const diff=((wd-spot.beachFacing)+360)%360;
  const wDir=windDir(wd);
  const isOff=diff>90&&diff<270;
  const isOn=diff<=90||diff>=270;
  if(ws<6)return'virtually no wind';
  if(isOff){
    if(ws<12)return'light '+wDir+' offshore';
    if(ws<18)return'moderate '+wDir+' offshore';
    if(ws<25)return'fresh '+wDir+' offshore — may get feathery';
    return'strong '+wDir+' offshore — could be too much';
  }
  if(isOn){
    if(ws<12)return'light '+wDir+' onshore — minimal impact';
    if(ws<18)return'moderate '+wDir+' onshore — expect some chop';
    if(ws<25)return'fresh '+wDir+' onshore — likely messy';
    return'strong '+wDir+' onshore — very messy, probably unsurfable';
  }
  const co=(diff>90&&diff<=135)||(diff>=225&&diff<270);
  if(co){
    if(ws<12)return wDir+' cross-offshore — light texture';
    return wDir+' cross-offshore — choppy on one side';
  }
  if(ws<12)return wDir+' cross-onshore — light';
  return wDir+' cross-onshore — choppy faces';
}
function conditionsRead(h,ws,wd,swP,spot){
  if(h<0.3)return'Waves too small to surf.';
  const parts=[];
  if(h>=2.5)parts.push('solid '+h.toFixed(1)+'m');
  else if(h>=1.2)parts.push(h.toFixed(1)+'m');
  else parts.push('small '+h.toFixed(1)+'m');
  if(swP>=14)parts.push('very long period — likely good shape');
  else if(swP>=10)parts.push(swP.toFixed(0)+'s period');
  else if(swP<7)parts.push('short period — likely choppy');
  parts.push(windDesc(ws,wd,spot));
  return parts.join('. ')+'.';
}
function getSunTimes(lat,lng,date){
  const rad=Math.PI/180,doy=Math.floor((date-new Date(date.getFullYear(),0,0))/86400000);
  const B=(360/365)*(doy-81)*rad,eq=9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B);
  const decl=23.45*Math.sin(B)*rad,HA=Math.acos(-Math.tan(lat*rad)*Math.tan(decl))/rad;
  const noon=12-(lng/15)-(eq/60),sr=noon-HA/15,ss=noon+HA/15;
  const off=(date.getMonth()>=2&&date.getMonth()<=9)?1:0;
  function fmt(h){const hh=Math.floor(h+off)%24,mm=Math.round((h+off-Math.floor(h+off))*60);return String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');}
  return{sunrise:sr+off,sunset:ss+off,sunriseStr:fmt(sr),sunsetStr:fmt(ss)};
}

// tideScore: given tide height normalised 0-1 (0=low,1=high), score it vs spot preference
function tideScore(normH, pref){
  // normH: 0=low tide, 1=high tide
  if(pref==='any') return 1;
  if(pref==='low')   return normH<=0.3?1:normH<=0.5?0.4:0;
  if(pref==='mid')   return (normH>=0.35&&normH<=0.65)?1:(normH>=0.2&&normH<=0.8)?0.4:0;
  if(pref==='low-mid') return normH<=0.55?1:normH<=0.7?0.4:0;
  if(pref==='high')  return normH>=0.7?1:normH>=0.5?0.4:0;
  return 1;
}

function tidePreferenceLabel(pref){
  return{any:'any tide',low:'low tide',mid:'mid tide','low-mid':'low to mid tide',high:'high tide'}[pref]||'any tide';
}

function buildSurfReport(slots,profile,sun,spot,currentRating,currentRead,tidePoints){
  const name=profile?profile.name:'Surfer';
  const skill=(profile&&profile.skill)||'advanced';
  const work=(profile&&profile.work)||'9to5';
  const t=skillThresholds(skill),now=new Date(),flex=work==='flexible'||work==='retired';
  // Strict daylight: sunrise to sunset-2h. No suggestions outside this range.
  const dawnHour=sun.sunrise;
  const duskCutoff=sun.sunset-2;

  // Pre-compute tide normalisation from tidePoints for time-based lookup
  let tideMin=0,tideMax=5,tideData=[];
  if(tidePoints&&tidePoints.length>2){
    const allH=tidePoints.map(p=>p.height);
    tideMin=Math.min(...allH); tideMax=Math.max(...allH);
    tideData=tidePoints;
  }
  function getTideNorm(isoTime){
    if(!tideData.length) return 0.5;
    const t=new Date(isoTime).getTime();
    // If data has type tags (sparse HIGH/LOW from MI predictions), interpolate sinusoidally
    if(tideData[0]&&(tideData[0].type==='HIGH'||tideData[0].type==='LOW')){
      // Find the two bracketing events
      const sorted=tideData.slice().sort(function(a,b){return new Date(a.time)-new Date(b.time);});
      let prev=sorted[0],next=sorted[sorted.length-1];
      for(let i=0;i<sorted.length-1;i++){
        if(new Date(sorted[i].time).getTime()<=t&&new Date(sorted[i+1].time).getTime()>=t){
          prev=sorted[i]; next=sorted[i+1]; break;
        }
      }
      const t0=new Date(prev.time).getTime(), t1=new Date(next.time).getTime();
      if(t1===t0) return prev.height/(tideMax-tideMin+0.01);
      // Cosine interpolation between adjacent HIGH and LOW
      const frac=(t-t0)/(t1-t0);
      const h=prev.height+(next.height-prev.height)*(0.5-0.5*Math.cos(frac*Math.PI));
      if(tideMax===tideMin) return 0.5;
      return(h-tideMin)/(tideMax-tideMin);
    }
    // Dense data: find closest point
    let closest=tideData[0],minDiff=Infinity;
    tideData.forEach(p=>{const d=Math.abs(new Date(p.time).getTime()-t);if(d<minDiff){minDiff=d;closest=p;}});
    if(tideMax===tideMin) return 0.5;
    return(closest.height-tideMin)/(tideMax-tideMin);
  }

  const scored=slots.map(function(s){
    const sd=new Date(s.time),hour=sd.getHours()+sd.getMinutes()/60,dow=sd.getDay();
    // HARD filter: must be daylight
    const isDaylight=hour>=dawnHour&&hour<=duskCutoff;
    if(!isDaylight) return null;
    const avail=flex||[0,6].includes(dow)||sd.getHours()<8||sd.getHours()>18;
    const offshore=isOffshore(s.wd,spot),gW=offshore||s.ws<9;
    const minSwell=spot.minSwellH||0;
    const gS=s.h>=t.minH&&s.h<=t.maxH&&s.h>=minSwell,gP=s.p>=t.minP;
    const swOk=swellInWindow(s.swDir!=null?s.swDir:s.waveDir,spot);
    const normTide=getTideNorm(s.time);
    const ts=tideScore(normTide,spot.tidePreference||'any');
    let sc=0;
    if(gS)sc+=3;if(gP)sc+=2;if(gW)sc+=2;if(offshore)sc+=1;if(avail)sc+=2;if(swOk)sc+=1;
    sc+=ts*2; // tide weight up to +2
    // Direction-adjusted wind for slot rating
      const slotWindDiff=((s.wd-spot.beachFacing)+360)%360;
      const slotOffshore=slotWindDiff>90&&slotWindDiff<270;
      const slotEffWind=slotOffshore?Math.min(s.ws*0.4,s.ws):s.ws;
      return Object.assign({},s,{sc:sc,avail:avail,gS:gS,r:rate(s.h,slotEffWind,s.p,skill),slotDate:sd,hour:sd.getHours(),tideOk:ts>0});
  }).filter(Boolean);

  const best=scored.filter(function(s){return s.sc>=5&&s.gS&&s.tideOk;}).sort(function(a,b){return b.sc-a.sc;})[0];
  let windowText='';
  const tidePrefLabel=tidePreferenceLabel(spot.tidePreference||'any');
  if(!best){
    const next=scored.filter(function(s){return s.gS;}).sort(function(a,b){return b.sc-a.sc;})[0];
    if(!next)windowText='Nothing great during daylight hours today. Check back as conditions develop.';
    else{
      const tideNote=spot.tidePreference&&spot.tidePreference!=='any'?' Tide conditions may not be ideal (best at '+tidePrefLabel+').':'';
      windowText='Best opportunity around '+fmtT(next.time)+'. '+next.h.toFixed(1)+'m at '+next.p.toFixed(0)+'s.'+tideNote;
    }
  } else {
    const dn=best.slotDate.toDateString()===now.toDateString()?'today':best.slotDate.toLocaleDateString('en-IE',{weekday:'long'});
    const unavNote=!best.avail&&work==='9to5'?' (falls during work hours)':'';
    const windNote=isOffshore(best.wd,spot)?windDir(best.wd)+' offshore':windDir(best.wd)+' wind';
    const qw=best.r==='great'||best.r==='good'?'a good':best.r==='fair'?'a fair':'a session';
    windowText='Best window: '+qw+' session around '+fmtT(best.time)+' '+dn+unavNote+'. ';
    windowText+=best.h.toFixed(1)+'m at '+best.p.toFixed(0)+'s, '+windNote+'.';
    if(spot.tidePreference&&spot.tidePreference!=='any')windowText+=' Tide looks '+tidePrefLabel+' — good for this break.';
    if(skill==='beginner'&&best.h>=1.0)windowText+=' Slightly bigger than ideal for beginners.';
    else if(skill==='expert'&&best.h>=2.0)windowText+=' Sizeable swell.';
    else if(skill==='advanced'&&best.h<0.9)windowText+=' Quieter spell — below ideal.';
  }
  const ac=currentRating==='good'||currentRating==='great'?'good-card':currentRating==='fair'?'fair-card':currentRating==='poor'?'poor-card':'flat-card';
  return'<div class="surf-report-card '+ac+'">'
    +'<div class="surf-report-label">'+name+'\'s Surf Report · '+spot.shortName+'</div>'
    +'<span class="badge badge-'+currentRating+'" style="margin-bottom:12px">'+rateLabel(currentRating)+'</span>'
    +'<div class="surf-report-body">'+currentRead+'</div>'
    +(windowText?'<div class="surf-report-window"><div class="surf-report-window-label">Next Window</div>'+windowText+'</div>':'')
    +'</div>';
}

function fmtT(iso){return new Date(iso).toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit',hour12:false});}
function fmtDay(iso){const d=new Date(iso),t=new Date(),tm=new Date();tm.setDate(tm.getDate()+1);if(d.toDateString()===t.toDateString())return'Today';if(d.toDateString()===tm.toDateString())return'Tmrw';return d.toLocaleDateString('en-IE',{weekday:'short'});}
function fmtDayFull(iso){const d=new Date(iso),t=new Date();if(d.toDateString()===t.toDateString())return'Today';return d.toLocaleDateString('en-IE',{weekday:'short'});}

// ── TIDE CARDS (simple high/low display) ──
function buildTideCards(tidePoints){
  if(!tidePoints||tidePoints.length<1){
    return'<div class="tide-simple-grid"><div class="tide-simple-card" style="grid-column:1/-1;text-align:center;color:var(--muted);font-family:\'DM Mono\',monospace;font-size:10px;letter-spacing:2px;">Tide data unavailable</div></div>';
  }
  const now=Date.now();
  const cutoff=now+96*3600000; // 4 days ahead
  console.log('[Quiver TideCards] Input:',tidePoints.length,'points, first:',tidePoints[0]);

  // If data already has HIGH/LOW type tags (from IMI predictions), use directly
  let events=[];
  if(tidePoints[0]&&tidePoints[0].type&&(tidePoints[0].type==='HIGH'||tidePoints[0].type==='LOW')){
    // Convert all points within a broad window
    const all=tidePoints.filter(function(p){
      return new Date(p.time).getTime()<=cutoff;
    }).map(function(p){
      const ts=new Date(p.time).getTime();
      return{type:p.type==='HIGH'?'high':'low',time:p.time,height:p.height,ts:ts};
    });
    // Always include: the most recent past event (context) + next 3 upcoming
    // This prevents a low tide disappearing just because it passed 2hrs ago
    const past=all.filter(function(p){return p.ts<now;}).slice(-1);
    const future=all.filter(function(p){return p.ts>=now;}).slice(0,3);
    events=past.concat(future);
  } else {
    // Dense data (synthetic): use wide-window peak detection
    const W6=6;
    for(let i=W6;i<tidePoints.length-W6;i++){
      const t=new Date(tidePoints[i].time).getTime();
      if(t<now-3600000||t>cutoff)continue;
      const curr=tidePoints[i].height;
      let isHigh=true,isLow=true;
      for(let j=1;j<=W6;j++){
        if(tidePoints[i-j].height>=curr)isHigh=false;
        if(tidePoints[i+j].height>=curr)isHigh=false;
        if(tidePoints[i-j].height<=curr)isLow=false;
        if(tidePoints[i+j].height<=curr)isLow=false;
      }
      if(isHigh||isLow)events.push({type:isHigh?'high':'low',time:tidePoints[i].time,height:tidePoints[i].height});
    }
  }

  console.log('[Quiver TideCards] Events found:',events.length, events);
  if(events.length===0){
    console.warn('[Quiver TideCards] No events in window',new Date(now).toISOString(),'→',new Date(cutoff).toISOString());
    return'<div class="tide-simple-grid"><div class="tide-simple-card" style="grid-column:1/-1;text-align:center;color:var(--muted);font-family:\'DM Mono\',monospace;font-size:10px;letter-spacing:2px;">No tides in window</div></div>';
  }

  // Show up to 4 events, sorted by time
  events.sort(function(a,b){return new Date(a.time)-new Date(b.time);});
  const cards=events.slice(0,4).map(function(e){
    const isHigh=e.type==='high';
    // Show day label if not today
    const d=new Date(e.time);
    const isToday=d.toDateString()===new Date().toDateString();
    const dayLabel=isToday?'':('<div class="tide-simple-day">'+d.toLocaleDateString('en-IE',{weekday:'short'})+'</div>');
    return'<div class="tide-simple-card'+(isHigh?' tide-high':' tide-low')+'">'
      +'<div class="tide-simple-icon">'+(isHigh?svgTideHigh():svgTideLow())+'</div>'
      +'<div class="tide-simple-type">'+(isHigh?'High':'Low')+'</div>'
      +dayLabel
      +'<div class="tide-simple-time">'+fmtT(e.time)+'</div>'
      +'<div class="tide-simple-ht">'+e.height.toFixed(1)+'m</div>'
      +'</div>';
  }).join('');
  return'<div class="tide-simple-grid">'+cards+'</div>';
}

function svgTideHigh(){return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(100,180,255,0.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="6 11 12 5 18 11"/></svg>';}
function svgTideLow(){return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(180,210,255,0.6)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="6 13 12 19 18 13"/></svg>';}

// ── GLOBE ──
let globeInterval=null;
let globeAngle=0;
const GLOBE_SPEED=0.004;
// Preload actual logo image (yellow pixels extracted from brand asset)

function getLogoImg(cb){
  if(_logoImg){cb(_logoImg);return;}
  const img=new Image();
  img.onload=function(){_logoImg=img;cb(img);};
  img.src=LOGO_B64;
}

function initGlobe(){
  const canvas=document.getElementById('globeCanvas');
  if(!canvas)return;
  const dpr=window.devicePixelRatio||1;
  const isMobile=window.innerWidth<=640;
  const S=isMobile?150:200;
  canvas.style.width=S+'px'; canvas.style.height=S+'px';
  canvas.width=S*dpr; canvas.height=S*dpr;
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const cx=S/2, cy=S/2, R=S/2-2;

  // ── VHS GLITCH state ──
  let glitchFrames=0, glitchTotal=0, glitchActive=false;
  let glitchBars=[];
  function scheduleGlitch(){
    setTimeout(function(){
      glitchBars=[];
      const n=4+Math.floor(Math.random()*6);
      for(let i=0;i<n;i++){
        glitchBars.push({
          y:Math.random()*S,
          h:2+Math.random()*Math.round(S*0.07),
          shift:(Math.random()-0.5)*Math.round(S*0.08),
          alpha:0.25+Math.random()*0.55,
          color:Math.random()>0.5?'245,200,0':'255,255,255'
        });
      }
      glitchTotal=10+Math.floor(Math.random()*14);
      glitchFrames=0;
      glitchActive=true;
      scheduleGlitch();
    }, 4000+Math.random()*5000);
  }
  scheduleGlitch();

  // ── Orthographic projection ──
  function project(latDeg,lonDeg,rotAngle){
    const lat=latDeg*Math.PI/180;
    const lon=lonDeg*Math.PI/180+rotAngle;
    const x=cx+R*Math.cos(lat)*Math.sin(lon);
    const y=cy-R*Math.sin(lat);
    const visible=Math.cos(lat)*Math.cos(lon)>0;
    return{x,y,visible};
  }

  // ── Draw actual brand logo image centred on globe ──
  function drawLogoOnGlobe(logoImg){
    ctx.save();
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.clip();

    // Semi-transparent dark wash — grid shows through subtly
    ctx.fillStyle='rgba(10,8,2,0.58)';
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fill();

    if(logoImg){
      // Logo is 1127×840px: W/H ratio ≈ 1.342
      // Fit inside the inscribed square of the circle (side = R*√2)
      const inscribed=R*Math.sqrt(2)*0.88; // use 88% so a little breathing room
      const logoAR=logoImg.naturalWidth/logoImg.naturalHeight; // ≈1.342
      let lw,lh;
      if(logoAR>1){lw=inscribed;lh=inscribed/logoAR;}
      else{lh=inscribed;lw=inscribed*logoAR;}
      ctx.drawImage(logoImg, cx-lw/2, cy-lh/2, lw, lh);
    }
    ctx.restore();
  }

  // ── VHS glitch overlay ──
  function drawGlitch(){
    if(!glitchActive)return;
    ctx.save();
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.clip();
    const progress=glitchFrames/glitchTotal;
    const fadeAlpha=progress>0.66?1-(progress-0.66)/0.34:1;
    glitchBars.forEach(function(b){
      ctx.fillStyle='rgba('+b.color+','+(b.alpha*fadeAlpha)+')';
      ctx.fillRect(b.shift, b.y, S, b.h);
      ctx.fillStyle='rgba(0,0,0,'+(0.4*fadeAlpha)+')';
      ctx.fillRect(b.shift+S*0.15, b.y+b.h*0.4, S*0.6, b.h*0.35);
    });
    const noisePts=Math.floor(60*fadeAlpha);
    for(let i=0;i<noisePts;i++){
      ctx.fillStyle='rgba(245,200,0,'+(0.3+Math.random()*0.5)+')';
      ctx.fillRect(Math.random()*S,Math.random()*S,Math.random()*3+1,1);
    }
    if(Math.random()>0.6){
      ctx.fillStyle='rgba(245,200,0,'+(0.06*fadeAlpha)+')';
      ctx.fillRect(0,Math.random()*S,S,Math.round(S*0.015));
    }
    ctx.restore();
    glitchFrames++;
    if(glitchFrames>=glitchTotal)glitchActive=false;
  }

  function drawGlobe(angle, logoImg){
    ctx.clearRect(0,0,S,S);
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2);
    ctx.fillStyle='#0e0c04'; ctx.fill();

    ctx.save();
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.clip();

    // Latitude lines
    [75,60,45,30,15,0,-15,-30,-45,-60,-75].forEach(function(lat){
      const isEquator=lat===0;
      ctx.beginPath(); let started=false;
      for(let lon=-180;lon<=180;lon+=2){
        const p=project(lat,lon,angle);
        if(!p.visible){started=false;continue;}
        if(!started){ctx.moveTo(p.x,p.y);started=true;}
        else ctx.lineTo(p.x,p.y);
      }
      ctx.strokeStyle=isEquator?'rgba(245,200,0,0.7)':'rgba(245,200,0,0.32)';
      ctx.lineWidth=isEquator?3:1.8; ctx.stroke();
    });

    // Longitude lines
    for(let lon=0;lon<360;lon+=20){
      const isPrimary=lon%60===0;
      ctx.beginPath(); let started=false;
      for(let lat=-88;lat<=88;lat+=2){
        const p=project(lat,lon,angle);
        if(!p.visible){started=false;continue;}
        if(!started){ctx.moveTo(p.x,p.y);started=true;}
        else ctx.lineTo(p.x,p.y);
      }
      ctx.strokeStyle=isPrimary?'rgba(245,200,0,0.52)':'rgba(245,200,0,0.22)';
      ctx.lineWidth=isPrimary?2.5:1.6; ctx.stroke();
    }
    ctx.restore();

    drawLogoOnGlobe(logoImg);
    drawGlitch();

    // Outer ring
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2);
    ctx.strokeStyle='rgba(245,200,0,0.75)'; ctx.lineWidth=2.5; ctx.stroke();
    ctx.beginPath(); ctx.arc(cx,cy,R+4,0,Math.PI*2);
    ctx.strokeStyle='rgba(245,200,0,0.15)'; ctx.lineWidth=1.5; ctx.stroke();
  }

  if(globeInterval)clearInterval(globeInterval);
  getLogoImg(function(logoImg){
    globeInterval=setInterval(function(){globeAngle+=GLOBE_SPEED;drawGlobe(globeAngle,logoImg);},16);
  });
}

function generateSyntheticTides(lat,lng){
  // Generate realistic-looking synthetic tide data when live data unavailable
  const now=Date.now();
  const tidal_period=44714000; // ~12.4h in ms
  const points=[];
  const startT=now-3*3600000;
  const endT=now+24*3600000;
  const lat_factor=0.3+Math.abs(lat-52)/20;
  const amplitude=1.5+lat_factor*0.8;
  const offset=amplitude*0.3;
  for(let t=startT;t<=endT;t+=600000){
    const phase=(t/tidal_period)*Math.PI*2;
    const h=offset+amplitude*Math.cos(phase);
    points.push({time:new Date(t).toISOString(),height:Math.max(0.1,h)});
  }
  return points;
}

function extractTidePoints(times,levels){
  const points=[];
  const now=Date.now();
  const startT=now-3*3600000;
  const endT=now+24*3600000;
  for(let i=0;i<times.length;i++){
    const t=new Date(times[i]).getTime();
    if(t>=startT&&t<=endT&&levels[i]!=null)points.push({time:times[i],height:levels[i]});
  }
  return points;
}

function drawGraph(canvas,times,heights,periods,skill){
  const dpr=window.devicePixelRatio||1,W=canvas.offsetWidth,H=140;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const t=skillThresholds(skill||'advanced'),maxH=Math.max(...heights.filter(Boolean),2)*1.15;
  const pad={l:36,r:12,t:16,b:28},gw=W-pad.l-pad.r,gh=H-pad.t-pad.b;
  const toX=function(i){return(i/(heights.length-1))*gw+pad.l;};
  const toY=function(v){return gh-(v/maxH)*gh+pad.t;};
  ctx.fillStyle='rgba(34,197,94,0.06)';ctx.fillRect(pad.l,toY(Math.min(t.maxH,maxH)),gw,toY(t.minH)-toY(Math.min(t.maxH,maxH)));
  ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;
  for(let v=0.5;v<=maxH;v+=0.5){
    const y=toY(v);if(y<pad.t||y>H-pad.b)continue;
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    if(v%1===0){ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='10px "DM Mono",monospace';ctx.fillText(v+'m',2,y+4);}
  }
  let lastDay='';
  times.forEach(function(tm,i){
    const d=new Date(tm),ds=d.toLocaleDateString('en-IE',{weekday:'short'});
    if(ds!==lastDay){
      const x=toX(i);ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,H-pad.b);ctx.stroke();
      ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='9px "DM Mono",monospace';ctx.fillText(ds,x+3,H-pad.b+14);
      lastDay=ds;
    }
  });
  ctx.beginPath();heights.forEach(function(v,i){if(v==null)return;const x=toX(i),y=toY(v);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.lineTo(toX(heights.length-1),H-pad.b);ctx.lineTo(pad.l,H-pad.b);ctx.closePath();
  const gr=ctx.createLinearGradient(0,pad.t,0,H-pad.b);gr.addColorStop(0,'rgba(255,255,255,0.12)');gr.addColorStop(1,'rgba(255,255,255,0.01)');ctx.fillStyle=gr;ctx.fill();
  for(let i=1;i<heights.length;i++){
    if(!heights[i]||!heights[i-1])continue;
    const r=rate(heights[i],10,periods[i]||8,skill);
    ctx.strokeStyle=r==='good'||r==='great'?'rgba(34,197,94,0.9)':r==='fair'?'rgba(245,200,0,0.9)':'rgba(239,68,68,0.7)';
    ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(toX(i-1),toY(heights[i-1]));ctx.lineTo(toX(i),toY(heights[i]));ctx.stroke();
  }
  const ni=times.findIndex(function(tm){return new Date(tm)>=new Date();});
  if(ni>0){
    const x=toX(ni);ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,H-pad.b);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='8px "DM Mono",monospace';ctx.fillText('now',x+3,pad.t+10);
  }
}

// ── SVG ICONS ──
function svgSunrise(){return '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(100,180,255,0.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M4.93 7.93l2.83 2.83M2 14h4M18 12a6 6 0 11-12 0"/><path d="M20 14h2M18.36 7.64l-1.42 1.42M5 19h14"/><polyline points="8 16 12 12 16 16"/></svg>';}
function svgSunset(){return '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(255,160,60,0.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M4.93 7.93l2.83 2.83M2 14h4M18 12a6 6 0 11-12 0"/><path d="M20 14h2M18.36 7.64l-1.42 1.42M5 19h14"/><polyline points="8 12 12 16 16 12"/></svg>';}

// ── MARINE INSTITUTE TIDE PREDICTION FETCH ──
// Uses IMI_TidePrediction_HighLow: predicted high/low tides, 2 years ahead, always populated.
// Falls back to synthetic harmonics if unavailable.
async function fetchTidePredictions(stationID){
  const LOG='[Quiver Tides]';
  try{
    const from=new Date(Date.now()-6*3600000).toISOString().slice(0,19)+'Z';
    const to=new Date(Date.now()+90*3600000).toISOString().slice(0,19)+'Z';  // 4 days ahead — ensures multiple full tidal cycles
    const url='https://erddap.marine.ie/erddap/tabledap/IMI_TidePrediction_HighLow.json'
      +'?time,Water_Level_ODM,tide_time_category'
      +'&stationID=%22'+encodeURIComponent(stationID)+'%22'
      +'&time%3E='+encodeURIComponent(from)
      +'&time%3C='+encodeURIComponent(to)
      +'&orderBy(%22time%22)';
    console.log(LOG,'Fetching:',stationID,'→',url);
    const r=await fetch(url);
    if(!r.ok){
      console.warn(LOG,'HTTP',r.status,'for station',stationID);
      return null;
    }
    const j=await r.json();
    // Log raw column names so we can see the exact field values
    const cols=(j.table&&j.table.columnNames)||[];
    console.log(LOG,'Column names:',cols);
    // Dynamically find column indices in case order varies
    const timeIdx  = cols.indexOf('time')>=0               ? cols.indexOf('time')               : 0;
    const heightIdx= cols.indexOf('Water_Level_ODM')>=0    ? cols.indexOf('Water_Level_ODM')    : 1;
    const typeIdx  = cols.indexOf('tide_time_category')>=0 ? cols.indexOf('tide_time_category') : 2;
    console.log(LOG,'Using column indices — time:'+timeIdx+' height:'+heightIdx+' type:'+typeIdx);
    const rows=(j.table&&j.table.rows)||[];
    console.log(LOG,'Row count:',rows.length);
    if(rows.length>0){
      console.log(LOG,'First 3 rows:',rows.slice(0,3));
      // Log every unique tide_time_category value we receive
      const rawTypes=[...new Set(rows.map(r=>r[typeIdx]))];
      console.log(LOG,'Unique tide_time_category values in response:',rawTypes);
    }
    if(rows.length<1){
      console.warn(LOG,'No rows returned for',stationID);
      return null;
    }
    // Normalise type: handles "High Water", "LOW", "high", "HW", "LW" etc.
    function normaliseType(raw){
      if(raw===null||raw===undefined) return null;
      const s=raw.toString().toUpperCase().trim();
      // Exact matches
      if(s==='HIGH'||s==='HIGH WATER'||s==='HW'||s==='H'||s==='1') return 'HIGH';
      if(s==='LOW' ||s==='LOW WATER' ||s==='LW'||s==='L'||s==='0') return 'LOW';
      // Contains match — catches "High Water Stand", "Low Water Slack" etc.
      if(s.includes('HIGH')) return 'HIGH';
      if(s.includes('LOW'))  return 'LOW';
      // First-letter fallback
      if(s.startsWith('H')) return 'HIGH';
      if(s.startsWith('L')) return 'LOW';
      console.warn(LOG,'Unknown tide_time_category value:',JSON.stringify(raw));
      return null;
    }
    const points=rows.map(function(row){
      const type=normaliseType(row[typeIdx]);
      return{time:row[timeIdx], height:row[heightIdx], type:type};
    }).filter(function(p){
      return p.height!=null&&p.height>-900&&p.type!==null;
    });
    console.log(LOG,'Parsed',points.length,'valid tide events:',points);
    const types=points.map(p=>p.type);
    const highs=types.filter(t=>t==='HIGH').length;
    const lows=types.filter(t=>t==='LOW').length;
    console.log(LOG,'HIGHs:',highs,'LOWs:',lows);
    return points.length>=1?points:null;
  }catch(e){
    console.error('[Quiver Tides] fetchTidePredictions error:',e);
    return null;
  }
}

// ── M2 BUOY FETCH ──
async function fetchM2Buoy(){
  try{
    const from=new Date(Date.now()-3*3600000).toISOString().slice(0,19)+'Z';
    const url='https://erddap.marine.ie/erddap/tabledap/IWBNetwork.json?time,WaveHeight,WavePeriod,WindSpeed,WindDirection&station_id=%22M2%22&time>='+encodeURIComponent(from)+'&orderByLast(%22time%22)';
    const r=await fetch(url);
    if(!r.ok)return null;
    const j=await r.json();
    const rows=j.table&&j.table.rows;
    if(!rows||!rows.length)return null;
    const last=rows[rows.length-1];
    return{time:last[0],waveHeight:last[1]!=-999?last[1]:null,wavePeriod:last[2]!=-999?last[2]:null,windSpeed:last[3]!=-999?(last[3]*1.151):null,windDirection:last[4]!=-999?last[4]:null};
  }catch(e){return null;}
}

async function fetchDotRatings(){
  const ns=new Date().toISOString().slice(0,13);
  return Promise.all(currentGroup.map(async function(s){
    try{
      const[mr,wr]=await Promise.all([
        fetch('https://marine-api.open-meteo.com/v1/marine?latitude='+s.lat+'&longitude='+s.lng+'&hourly=wave_height,wave_period&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=1'),
        fetch('https://api.open-meteo.com/v1/forecast?latitude='+s.lat+'&longitude='+s.lng+'&hourly=wind_speed_10m&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=1')
      ]);
      const m=await mr.json(),w=await wr.json();
      const ci=m.hourly.time.findIndex(function(t){return t.startsWith(ns);});
      return rate(m.hourly.wave_height[ci]||0,w.hourly.wind_speed_10m[ci]||0,m.hourly.wave_period[ci]||0,getProfile()&&getProfile().skill);
    }catch(e){return'poor';}
  }));
}

// ── MAIN LOAD ──
async function load(){
  const app=document.getElementById('app'),profile=getProfile(),skill=(profile&&profile.skill)||'advanced',spot=currentSpot;
  app.innerHTML='<div class="status">Loading forecast...</div>';
  try{
    const isDublin=spot.useBuoy;
    const[mr,wr,tideR,dots,buoy]=await Promise.all([
      fetch('https://marine-api.open-meteo.com/v1/marine?latitude='+spot.lat+'&longitude='+spot.lng+'&hourly=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period,secondary_swell_wave_height,secondary_swell_wave_direction,secondary_swell_wave_period,sea_surface_temperature&daily=wave_height_max,wave_period_max,wave_direction_dominant,swell_wave_height_max&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=7'),
      fetch('https://api.open-meteo.com/v1/forecast?latitude='+spot.lat+'&longitude='+spot.lng+'&hourly=wind_speed_10m,wind_direction_10m&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=7'),
      fetchTidePredictions(spot.tideStation||'Galway'),
      fetchDotRatings(),
      isDublin?fetchM2Buoy():Promise.resolve(null)
    ]);

    if(!mr.ok)throw new Error('Marine API '+mr.status);
    if(!wr.ok)throw new Error('Wind API '+wr.status);
    const m=await mr.json(),w=await wr.json();
    const times=m.hourly.time,wH=m.hourly.wave_height,wDir=m.hourly.wave_direction,wP=m.hourly.wave_period;
    const swD=m.hourly.swell_wave_direction,swP=m.hourly.swell_wave_period;
    const sw2H=m.hourly.secondary_swell_wave_height,sw2D=m.hourly.secondary_swell_wave_direction,sw2P=m.hourly.secondary_swell_wave_period;
    const sst=m.hourly.sea_surface_temperature,wndS=w.hourly.wind_speed_10m,wndD=w.hourly.wind_direction_10m,daily=m.daily;
    const now=new Date(),ns=now.toISOString().slice(0,13);
    let ci=times.findIndex(function(t){return t.startsWith(ns);});if(ci<0)ci=0;

    let cH,cD,cP,cWS,cWD,buoyActive=false;
    if(isDublin&&buoy&&buoy.waveHeight!==null){
      cH=buoy.waveHeight;cP=buoy.wavePeriod||wP[ci]||0;cD=wDir[ci]||0;cWS=buoy.windSpeed||wndS[ci]||0;cWD=buoy.windDirection||wndD[ci]||0;buoyActive=true;
    }else{
      cH=wH[ci]||0;cD=wDir[ci]||0;cP=wP[ci]||0;cWS=wndS[ci]||0;cWD=wndD[ci]||0;
    }
    const cSwD=swD[ci]||cD,cSwP=swP[ci]||cP;
    const cSw2H=sw2H&&sw2H[ci]||0,cSw2D=sw2D&&sw2D[ci]||0,cSw2P=sw2P&&sw2P[ci]||0;
    const cSST=sst&&sst[ci]!=null?sst[ci]:null;
    const r=rate(cH,cWS,cP,skill),energy=waveEnergy(cH,cP);
    const read=conditionsRead(cH,cWS,cWD,cSwP,spot);
    const rColor=r==='good'||r==='great'?'var(--good)':r==='fair'?'var(--fair)':r==='poor'?'var(--poor)':'var(--muted)';
    const sun=getSunTimes(spot.lat,spot.lng,now);
    const swellGood=swellInWindow(cSwD||cD,spot);
    const swellWarnHTML=(!swellGood&&cH>=0.3)?'<div class="swell-warning">Swell direction ('+windDir(cSwD||cD)+') may not be optimal for this break.</div>':'';

    const slots=[];
    for(let i=ci;i<ci+24&&i<times.length;i+=3){
      slots.push({time:times[i],h:wH[i]||0,p:wP[i]||0,waveDir:wDir[i]||0,swDir:swD[i]!=null?swD[i]:null,swP:swP[i]||0,ws:wndS[i]||0,wd:wndD[i]||0});
    }

    // Tide data — tideR is already processed [{time,height,type}] from fetchTidePredictions
    let tidePoints = tideR || [];
    if(tidePoints.length < 2){
      console.warn('[Quiver Tides] Falling back to synthetic tides (got',tidePoints.length,'points from MI)');
      tidePoints = generateSyntheticTides(spot.lat, spot.lng);
    } else {
      console.log('[Quiver Tides] Using',tidePoints.length,'MI predicted tide events');
    }

    const days=daily.time.map(function(t,i){return{time:t,h:daily.wave_height_max[i]||0,p:daily.wave_period_max[i]||0,dir:daily.wave_direction_dominant[i]||0};});
    const surfReportHTML=buildSurfReport(slots,profile,sun,spot,r,read,tidePoints);
    buildSelector(dots);

    // Table rows
    const tableRows=slots.map(function(s){
      const srWindDiff=((s.wd-spot.beachFacing)+360)%360;
      const srOffshore=srWindDiff>90&&srWindDiff<270;
      const srEffWind=srOffshore?Math.min(s.ws*0.4,s.ws):s.ws;
      const sr=rate(s.h,srEffWind,s.p,skill),dir=s.swDir!=null?s.swDir:s.waveDir,slotH=new Date(s.time).getHours();
      const isDawn=Math.abs(slotH-Math.floor(sun.sunrise))<=1,isDusk=Math.abs(slotH-Math.floor(sun.sunset))<=1;
      const isWork=profile&&profile.work==='9to5'&&![0,6].includes(new Date(s.time).getDay())&&slotH>=9&&slotH<=17;
      const tag=isDawn?'<span class="row-tag dawn">First Light</span>':isDusk?'<span class="row-tag dusk">Last Light</span>':isWork?'<span class="row-tag work">Work hours</span>':'';
      return '<tr class="forecast-row '+sr+'">'
        +'<td><div class="row-time">'+fmtT(s.time)+(tag?'<br>'+tag:'')+'</div></td>'
        +'<td><div class="row-height '+sr+'">'+displayH(s.h)+'<span class="row-unit">'+displayUnit()+'</span></div></td>'
        +'<td><div class="row-height" style="font-size:14px;color:rgba(255,255,255,0.4)">'+s.h.toFixed(1)+'<span class="row-unit">m</span></div></td>'
        +'<td><div class="row-dir">'+arrowChar(dir)+' '+windDir(dir)+'<br><span style="font-size:9px;opacity:0.5">'+(s.swP||s.p).toFixed(0)+'s</span></div></td>'
        +'<td><div class="row-wind">'+arrowChar(s.wd)+' '+windDir(s.wd)+'<br><span style="font-size:9px;opacity:0.5">'+s.ws.toFixed(0)+'mph</span></div></td>'
        +'<td><div class="row-period">'+s.p.toFixed(0)+'s</div></td>'
        +'</tr>';
    }).join('');

    // Mobile forecast cards
    const mobileCards=slots.map(function(s){
      const sr2WindDiff=((s.wd-spot.beachFacing)+360)%360;
      const sr2Offshore=sr2WindDiff>90&&sr2WindDiff<270;
      const sr2EffWind=sr2Offshore?Math.min(s.ws*0.4,s.ws):s.ws;
      const sr=rate(s.h,sr2EffWind,s.p,skill);
      const dir=s.swDir!=null?s.swDir:s.waveDir;
      return '<div class="fc-card '+sr+'">'
        +'<div class="fc-time">'+fmtT(s.time)+'</div>'
        +'<div class="fc-height '+sr+'">'+displayH(s.h)+'<span style="font-size:10px;opacity:0.4">'+displayUnit()+'</span></div>'
        +'<div class="fc-meta">'
          +arrowChar(dir)+' '+windDir(dir)+' '+s.p.toFixed(0)+'s<br>'
          +arrowChar(s.wd)+' '+windDir(s.wd)+' '+s.ws.toFixed(0)+'mph'
        +'</div>'
        +'</div>';
    }).join('');

    // Enhanced 7-day cards — includes wind speed
    const today=new Date().toDateString();
    const dayCards=days.map(function(d,i){
      const isToday=new Date(d.time).toDateString()===today;
      const dayWindIdx=Math.min(i*24+12,wndS.length-1);
      const dayWindS=wndS[dayWindIdx]||0;
      const dayWindD=wndD[dayWindIdx]||0;
      const windDiff=((dayWindD-spot.beachFacing)+360)%360;
      const isOffshoreDay=windDiff>90&&windDiff<270;
      const effectiveWind=isOffshoreDay?Math.min(dayWindS*0.4,dayWindS):dayWindS;
      const dr=rate(d.h,effectiveWind,d.p,skill);
      const windLabel=isOffshoreDay?'Offshore':'Onshore';
      // encode data into onclick
      const dataStr=encodeURIComponent(JSON.stringify({
        time:d.time,h:d.h,p:d.p,dir:d.dir,
        windS:dayWindS,windD:dayWindD,
        rating:dr,isToday:isToday,windLabel:windLabel
      }));
      return '<div class="day-card '+dr+(isToday?' today':'')+' expday" data-day="'+dataStr+'" onclick="openDayExpand(this)">'
        +'<div class="day-name">'+(isToday?'<span style="color:rgba(245,200,0,0.8)">Today</span>':fmtDayFull(d.time))+'</div>'
        +'<div class="day-height">'+displayH(d.h)+'<span class="day-unit">'+displayUnit()+'</span></div>'
        +'<span class="day-badge">'+rateLabel(dr)+'</span>'
        +'<div class="day-detail">'+arrowChar(d.dir)+' '+windDir(d.dir)+'<br>'+d.p.toFixed(0)+'s<br>'
          +'<span style="color:rgba(255,255,255,0.5)">'+arrowChar(dayWindD)+' '+dayWindS.toFixed(0)+'mph</span>'
        +'</div>'
        +'</div>';
    }).join('');

    // Secondary swell
    const sw2Block=cSw2H>0.2
      ?'<div class="swell-secondary">'
        +'<div style="font-family:\'DM Mono\',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-right:8px;">Secondary Swell</div>'
        +'<div class="swell-sec-item"><div class="swell-sec-label">Height</div><div class="swell-sec-val">'+cSw2H.toFixed(1)+'<span style="font-size:11px;opacity:0.4">m</span></div></div>'
        +'<div class="swell-sec-item"><div class="swell-sec-label">Period</div><div class="swell-sec-val">'+cSw2P.toFixed(0)+'<span style="font-size:11px;opacity:0.4">s</span></div></div>'
        +'<div class="swell-sec-item"><div class="swell-sec-label">Direction</div><div class="swell-sec-val">'+arrowChar(cSw2D)+' '+windDir(cSw2D)+'</div></div>'
        +'</div>'
      :'';

    const buoyBadge=buoyActive?'&nbsp;<span class="buoy-tag">M2 Buoy</span>':'';
    const buoyDataNote=buoyActive?' · M2 Buoy data':'';
    const buoyInfoItem=spot.useBuoy?'<div class="spot-info-item"><div class="spot-info-label">Live Data</div><div class="spot-info-val">M2 Buoy · Irish Sea</div></div>':'';
    const waveDisplay=displayH(cH);
    const waveU=displayUnit();
    const waveSub=currentUnit==='ft'?'Est. face height':'Significant height (Hs)';

    // Water temp item — clean, consistent
    const sstBlock=cSST!==null
      ?'<div><div class="c-val" style="font-size:clamp(20px,2.5vw,28px);">'+cSST.toFixed(1)+'<span class="c-unit">°C</span></div><div class="c-lbl">Water Temp</div><div class="c-sub">Sea surface</div></div>'
      :'';

    app.innerHTML=
      swellWarnHTML
      +surfReportHTML

      +'<div class="current-card">'
        +'<div class="card-label">Now · '+now.toLocaleDateString('en-IE',{weekday:'long'})+' '+fmtT(now.toISOString())+buoyDataNote+'</div>'
        +'<div class="current-grid">'
          +'<div><div class="c-val">'+waveDisplay+'<span class="c-unit">'+waveU+'</span></div><div class="c-lbl">Wave Height</div><div class="c-sub">'+waveSub+'</div></div>'
          +'<div><div class="c-val">'+cH.toFixed(1)+'<span class="c-unit">m</span></div><div class="c-lbl">Swell Height</div><div class="c-sub">Hs open ocean</div></div>'
          +'<div><div class="c-val">'+cP.toFixed(0)+'<span class="c-unit">s</span></div><div class="c-lbl">Period</div><div class="c-sub">Wave period</div></div>'
          +'<div><div class="c-val">'+energy+'<span class="c-unit">kW/m</span></div><div class="c-lbl">Wave Energy</div><div class="c-sub">Wave power flux</div></div>'
        +'</div>'
        +'<div class="current-grid-bottom">'
          +'<div><div class="dir-display">'+dirArrowSVG(cSwD,'var(--fair)')+'<div><div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">'+windDir(cSwD)+'</div><div class="c-lbl">Swell Dir</div></div></div></div>'
          +'<div><div class="dir-display">'+dirArrowSVG(cWD,'rgba(255,255,255,0.6)')+'<div><div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">'+cWS.toFixed(0)+'<span class="c-unit">mph</span> '+windDir(cWD)+'</div><div class="c-lbl">Wind</div></div></div></div>'
          +'<div><div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">'+cSwP.toFixed(0)+'<span class="c-unit">s</span></div><div class="c-lbl">Swell Period</div><div class="c-sub">Primary swell</div></div>'
          +sstBlock
        +'</div>'
      +'</div>'

      +sw2Block

      +'<div class="sec-label">7 Day Swell Arrival</div>'
      +'<div class="graph-wrap"><canvas class="graph-canvas" id="swellGraph"></canvas></div>'

      +'<div class="sec-label">Next 24 Hours</div>'
      +'<div class="forecast-table-wrap"><table class="forecast-table">'
        +'<thead><tr><th>Time</th><th>Wave</th><th>Hs</th><th>Swell</th><th>Wind</th><th>Period</th></tr></thead>'
        +'<tbody>'+tableRows+'</tbody>'
      +'</table></div>'
      +'<div class="forecast-cards">'+mobileCards+'</div>'

      +'<div class="sec-label">Tides · Today</div>'
      +buildTideCards(tidePoints)

      +'<div class="sec-label">First &amp; Last Light</div>'
      +'<div class="light-grid">'
        +'<div class="light-card"><div class="light-icon">'+svgSunrise()+'</div><div><div class="light-label">First Light</div><div class="light-time">'+sun.sunriseStr+'</div><div class="light-sub">Sunrise</div></div></div>'
        +'<div class="light-card"><div class="light-icon">'+svgSunset()+'</div><div><div class="light-label">Last Light</div><div class="light-time">'+sun.sunsetStr+'</div><div class="light-sub">Sunset</div></div></div>'
      +'</div>'

      +'<div class="sec-label">7 Day Outlook</div>'
      +'<div class="seven-grid">'+dayCards+'</div>'

      +'<div class="sec-label">About This Break</div>'
      +'<div class="spot-info">'
        +'<div class="spot-info-item"><div class="spot-info-label">Wave Type</div><div class="spot-info-val">'+spot.waveType+'</div></div>'
        +'<div class="spot-info-item"><div class="spot-info-label">Level</div><div class="spot-info-val">'+spot.level+'</div></div>'
        +buoyInfoItem
      +'</div>'

      +'<div style="text-align:center;margin-top:32px;">'
        +'<button class="change-spot-btn" onclick="showSearch()">'
          +'<svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>'
          +'Change Spot'
        +'</button>'
      +'</div>'

      +'<div class="disclaimer">In forecasting we don\'t deal in definites. Quiver Surf Forecast should be used in tandem with your own local knowledge of this wave.</div>';

    requestAnimationFrame(function(){
      const sg=document.getElementById('swellGraph');
      if(sg)drawGraph(sg,times,wH,wP,skill);
    });
  }catch(e){
    app.innerHTML='<div class="status error">Couldn\'t load — '+e.message+'</div>';
  }
}

// ── DAY EXPAND ──
function openDayExpand(el){
  var dataStr=el.dataset.day;
  const d=JSON.parse(decodeURIComponent(dataStr));
  const rColors={great:'var(--good)',good:'var(--good)',fair:'var(--fair)',poor:'var(--poor)',flat:'rgba(255,255,255,0.4)'};
  const date=new Date(d.time);
  const dateLabel=d.isToday?'Today — '+date.toLocaleDateString('en-IE',{weekday:'long',day:'numeric',month:'long'}):date.toLocaleDateString('en-IE',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('dex-date').textContent=dateLabel;
  document.getElementById('dex-rating').innerHTML='<span style="color:'+rColors[d.rating]+'">'+rateLabel(d.rating).toUpperCase()+'</span>';
  document.getElementById('dex-h').innerHTML=displayH(d.h)+'<span class="dei-unit">'+displayUnit()+'</span>';
  document.getElementById('dex-hsub').textContent=d.h.toFixed(1)+'m significant height';
  document.getElementById('dex-p').innerHTML=d.p.toFixed(0)+'<span class="dei-unit">s</span>';
  document.getElementById('dex-dir').textContent=arrowChar(d.dir)+' '+windDir(d.dir);
  document.getElementById('dex-wind').innerHTML=d.windS.toFixed(0)+'<span class="dei-unit">mph</span>';
  document.getElementById('dex-windlbl').textContent=arrowChar(d.windD)+' '+windDir(d.windD)+' · '+d.windLabel;
  document.getElementById('dayExpand').classList.add('open');
}
function closeDayExpand(e){
  if(e.target===document.getElementById('dayExpand'))
    document.getElementById('dayExpand').classList.remove('open');
}

// ── INIT ──
renderSavedSpots();
// Init globe after fonts have loaded (slight delay so Archivo Black is ready)
setTimeout(initGlobe, 200);
(function(){
  const params=new URLSearchParams(window.location.search);
  const sid=params.get('spot');
  if(sid&&ALL_SPOTS.find(function(s){return s.id===sid;})){
    selectSpot(sid);
  }
})();
</script>

<div class="day-expand" id="dayExpand" onclick="closeDayExpand(event)">
  <div class="day-expand-card">
    <button class="day-expand-close" onclick="document.getElementById('dayExpand').classList.remove('open')">✕ Close</button>
    <div class="day-expand-date" id="dex-date"></div>
    <div class="day-expand-rating" id="dex-rating"></div>
    <div class="day-expand-grid">
      <div class="day-expand-item"><div class="dei-label">Wave Height</div><div class="dei-val" id="dex-h"></div><div class="dei-sub" id="dex-hsub"></div></div>
      <div class="day-expand-item"><div class="dei-label">Period</div><div class="dei-val" id="dex-p"></div><div class="dei-sub">seconds</div></div>
      <div class="day-expand-item"><div class="dei-label">Swell Direction</div><div class="dei-val" id="dex-dir"></div></div>
      <div class="day-expand-item"><div class="dei-label">Wind</div><div class="dei-val" id="dex-wind"></div><div class="dei-sub" id="dex-windlbl"></div></div>
    </div>
  </div>
</div>
<nav class="bottom-nav">
  <a href="index.html" class="bottom-nav-item active">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h2M20 12h2M12 2v2M12 20v2"/><circle cx="12" cy="12" r="5"/><path d="M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
    <span>Forecast</span>
  </a>
  <a href="workshop.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    <span>Workshop</span>
  </a>
  <a href="trip.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>
    <span>Trip</span>
  </a>
</nav>
</body>
</html>
