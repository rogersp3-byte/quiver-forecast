<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiver — Forecast</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f0f0f;--surface:#1a1a1a;--surface2:#222;
  --white:#fff;--muted:rgba(255,255,255,0.35);--faint:rgba(255,255,255,0.1);
  --good:#22c55e;--fair:#f5c800;--poor:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--white);font-family:'Archivo Black',sans-serif;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.07;mix-blend-mode:overlay;}

/* MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:1000;display:flex;align-items:center;justify-content:center;padding:24px;}
.modal-backdrop.hidden{display:none;}
.modal{background:var(--surface);max-width:480px;width:100%;padding:36px;border:1px solid rgba(255,255,255,0.1);}
.modal-title{font-size:22px;letter-spacing:-0.5px;margin-bottom:6px;}
.modal-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:32px;}
.field{margin-bottom:22px;}
.field-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:10px;display:block;}
.field select,.field input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.15);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:12px 14px;outline:none;appearance:none;transition:border-color 0.2s;}
.field select:focus,.field input:focus{border-color:rgba(255,255,255,0.4);}
.modal-btn{width:100%;background:var(--white);color:#0f0f0f;border:none;font-family:'Archivo Black',sans-serif;font-size:13px;letter-spacing:1px;padding:16px;cursor:pointer;transition:opacity 0.15s;}
.modal-btn:hover{opacity:0.9;}

/* HEADER */
header{padding:18px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--faint);}
.logo{font-size:18px;letter-spacing:2px;}
.logo-tag{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.main-nav{display:flex;gap:0;border:1px solid rgba(255,255,255,0.12);flex:1;margin:0 32px;}
.nav-link{flex:1;text-align:center;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:11px 20px;color:var(--muted);text-decoration:none;border-right:1px solid rgba(255,255,255,0.12);transition:all 0.15s;}
.nav-link:last-child{border-right:none;}
.nav-link:hover{color:var(--white);background:rgba(255,255,255,0.06);}
.nav-link.active{color:var(--white);background:rgba(255,255,255,0.08);}
.profile-btn{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid rgba(255,255,255,0.15);padding:7px 14px;cursor:pointer;}
.profile-btn:hover{border-color:rgba(255,255,255,0.35);color:rgba(255,255,255,0.7);}

/* SEARCH LANDING */
#searchPage{min-height:calc(100vh - 65px);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;}
#searchPage.hidden{display:none;}
.search-title{font-size:clamp(52px,11vw,100px);letter-spacing:-2px;line-height:0.9;text-align:center;margin-bottom:8px;}
.search-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:4px;text-transform:uppercase;color:var(--muted);text-align:center;margin-bottom:44px;}
.globe-wrap{position:relative;width:180px;height:180px;margin:0 auto 44px;}
.globe-canvas{width:180px;height:180px;display:block;border-radius:50%;}
.search-box-wrap{width:100%;max-width:520px;position:relative;}
.search-input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.18);color:var(--white);font-family:'DM Mono',monospace;font-size:14px;padding:18px 22px;outline:none;letter-spacing:1px;transition:border-color 0.2s;}
.search-input:focus{border-color:rgba(255,255,255,0.45);}
.search-input::placeholder{color:rgba(255,255,255,0.25);}
.search-results{position:absolute;top:100%;left:0;right:0;background:#111;border:1px solid rgba(255,255,255,0.15);border-top:none;z-index:20;display:none;}
.search-results.show{display:block;}
.search-result-item{padding:14px 22px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.06);transition:background 0.12s;}
.search-result-item:last-child{border-bottom:none;}
.search-result-item:hover{background:rgba(255,255,255,0.06);}
.sri-name{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;color:var(--white);}
.sri-region{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--muted);margin-top:3px;}
.search-hint{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.2);text-align:center;margin-top:16px;}

/* FORECAST PAGE */
#forecastPage{display:none;}
#forecastPage.show{display:block;}

/* HERO */
.hero{padding:32px 28px 0;border-bottom:1px solid var(--faint);}
.hero-inner{max-width:900px;margin:0 auto;display:flex;align-items:flex-end;justify-content:space-between;gap:20px;flex-wrap:wrap;}
.area-name{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:4px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.break-name{font-size:clamp(36px,9vw,84px);letter-spacing:-2px;line-height:0.9;}
.break-loc{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:10px;}
.coastline-map{flex-shrink:0;opacity:0.8;}

/* SPOT SELECTOR */
.spot-selector{display:flex;gap:0;margin-top:24px;border-top:1px solid var(--faint);}
.spot-btn{flex:1;padding:12px 6px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;background:none;border:none;border-right:1px solid var(--faint);color:var(--muted);cursor:pointer;transition:all 0.15s;text-align:center;position:relative;white-space:nowrap;}
.spot-btn:last-child{border-right:none;}
.spot-btn:hover{color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.03);}
.spot-btn.active{color:var(--white);background:rgba(255,255,255,0.05);}
.spot-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--white);}
.spot-btn .spot-badge{display:block;width:7px;height:7px;border-radius:50%;margin:0 auto 5px;background:var(--muted);}
.spot-btn.active .spot-badge{background:var(--white);}
.spot-badge.good-dot{background:var(--good)!important;}
.spot-badge.fair-dot{background:var(--fair)!important;}
.spot-badge.poor-dot{background:var(--poor)!important;}

.main{max-width:900px;margin:0 auto;padding:36px 24px 80px;}

/* SPOT INFO */
.spot-info{background:var(--surface);padding:16px 20px;margin-bottom:20px;display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start;border-left:3px solid rgba(255,255,255,0.15);}
.spot-info-item{min-width:100px;}
.spot-info-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.spot-info-val{font-family:'DM Mono',monospace;font-size:11px;color:rgba(255,255,255,0.8);line-height:1.5;}

/* SWELL WARNING */
.swell-warning{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.5px;color:rgba(255,165,0,0.85);background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.2);padding:10px 14px;margin-bottom:16px;font-style:italic;}

/* WINDOW ALERT */
.window-alert{border:1px solid rgba(255,255,255,0.12);padding:20px 24px;margin-bottom:28px;position:relative;overflow:hidden;}
.window-alert::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.window-alert.good-window::before{background:var(--good);}
.window-alert.fair-window::before{background:var(--fair);}
.window-alert.poor-window::before{background:var(--poor);}
.window-eyebrow{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.window-text{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:0.5px;color:rgba(255,255,255,0.85);line-height:1.7;font-style:italic;}

/* BADGE */
.badge{display:inline-block;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;padding:7px 18px;border:1.5px solid;white-space:nowrap;}
.badge-epic,.badge-good{color:var(--good);border-color:var(--good);}
.badge-fair{color:var(--fair);border-color:var(--fair);}
.badge-poor{color:var(--poor);border-color:var(--poor);}
.badge-flat{color:var(--muted);border-color:var(--muted);}
.conditions-read{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.5px;color:rgba(255,255,255,0.65);line-height:1.7;padding:7px 0 7px 16px;border-left:2px solid rgba(255,255,255,0.15);font-style:italic;}

/* TWO COL */
.top-two-col{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:20px;}
.top-col{background:var(--surface);padding:22px 20px;}
.top-col-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.top-col .badge{margin-bottom:12px;display:inline-block;}
.top-col .conditions-read{border-left:none;padding-left:0;margin-top:8px;font-size:10px;}
.top-col .window-alert{margin-bottom:0;border:none;padding:0;background:none;}
.top-col .window-alert::before{display:none;}
.top-col .window-eyebrow{margin-bottom:10px;}
.top-col .window-text{font-size:11px;}

/* CURRENT CARD */
.current-card{background:var(--surface);padding:28px;margin-bottom:4px;}
.card-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:22px;}
.current-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;}
.current-grid-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:24px;padding-top:24px;border-top:1px solid var(--faint);}
.c-val{font-size:clamp(26px,4vw,42px);letter-spacing:-1px;line-height:1;}
.c-unit{font-size:0.42em;opacity:0.4;letter-spacing:0;}
.c-lbl{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.7);margin-top:7px;}
.dir-display{display:flex;align-items:center;gap:12px;}
.dir-arrow{width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,0.2);border-radius:50%;flex-shrink:0;}
.dir-arrow svg{width:18px;height:18px;}

/* SECONDARY SWELL */
.swell-secondary{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:14px 20px;margin-top:4px;display:flex;gap:24px;align-items:center;flex-wrap:wrap;}
.swell-sec-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:4px;}
.swell-sec-val{font-family:'Archivo Black',sans-serif;font-size:16px;letter-spacing:-0.5px;}
.swell-sec-item{min-width:80px;}

/* SECTION LABEL */
.sec-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.65);margin:28px 0 8px;display:flex;align-items:center;gap:10px;}
.sec-label::before{content:'';width:16px;height:1px;background:rgba(255,255,255,0.4);}

/* GRAPH */
.graph-wrap{background:var(--surface);padding:24px 20px 16px;margin-bottom:4px;overflow:hidden;}
.graph-canvas{width:100%;height:140px;display:block;}

/* TABLE */
.forecast-table{width:100%;border-collapse:collapse;}
.forecast-table th{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:8px 12px;text-align:left;border-bottom:1px solid var(--faint);}
.forecast-table th:not(:first-child){text-align:center;}
.forecast-row{border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s;border-left:3px solid transparent;}
.forecast-row:hover{background:var(--surface2);}
.forecast-row.good,.forecast-row.epic{border-left-color:var(--good);}
.forecast-row.fair{border-left-color:var(--fair);}
.forecast-row.poor{border-left-color:var(--poor);}
.forecast-row td{padding:12px 12px;vertical-align:middle;}
.row-time{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;color:rgba(255,255,255,0.5);white-space:nowrap;}
.row-height{font-size:19px;letter-spacing:-0.5px;text-align:center;}
.row-height.good,.row-height.epic{color:var(--good);}
.row-height.fair{color:var(--fair);}
.row-height.poor{color:var(--poor);}
.row-unit{font-size:10px;opacity:0.4;}
.row-dir,.row-wind{font-family:'DM Mono',monospace;font-size:10px;text-align:center;color:rgba(255,255,255,0.7);line-height:1.6;}
.row-period,.row-energy{font-family:'DM Mono',monospace;font-size:11px;text-align:center;color:rgba(255,255,255,0.6);}
.row-tag{display:inline-block;font-family:'DM Mono',monospace;font-size:7px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 6px;margin-top:2px;}
.row-tag.dawn{background:rgba(100,150,255,0.15);color:rgba(100,180,255,0.8);}
.row-tag.dusk{background:rgba(255,160,60,0.15);color:rgba(255,180,80,0.8);}
.row-tag.work{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.4);}

/* TIDES */
.tide-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:3px;}
.tide-card{background:var(--surface);padding:16px 18px;display:flex;align-items:center;gap:14px;}
.tide-icon{font-size:20px;flex-shrink:0;}
.tide-type{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.tide-time{font-size:20px;letter-spacing:-0.5px;}
.tide-ht{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:2px;}

/* 7 DAY */
.seven-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:3px;}
.day-card{background:var(--surface);padding:16px 14px;text-align:center;border-top:2px solid transparent;}
.day-card.epic,.day-card.good{border-top-color:var(--good);}
.day-card.fair{border-top-color:var(--fair);}
.day-card.poor{border-top-color:var(--poor);}
.day-name{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:8px;}
.day-height{font-size:24px;letter-spacing:-1px;}
.day-card.epic .day-height,.day-card.good .day-height{color:var(--good);}
.day-card.fair .day-height{color:var(--fair);}
.day-card.poor .day-height{color:var(--poor);}
.day-detail{font-family:'DM Mono',monospace;font-size:8px;color:rgba(255,255,255,0.5);margin-top:5px;line-height:1.7;text-transform:uppercase;}

.status{text-align:center;padding:80px 24px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.status.error{color:var(--poor);}
.disclaimer{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.5px;color:rgba(255,255,255,0.25);text-align:center;padding:24px 20px;border-top:1px solid var(--faint);margin-top:28px;line-height:1.8;font-style:italic;}

/* MOBILE BOTTOM NAV */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,10,0.97);border-top:1px solid rgba(255,255,255,0.1);z-index:500;padding:10px 0 max(10px,env(safe-area-inset-bottom));backdrop-filter:blur(12px);}
.bottom-nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;color:rgba(255,255,255,0.35);text-decoration:none;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;transition:color 0.15s;padding:4px 0;}
.bottom-nav-item svg{width:20px;height:20px;}
.bottom-nav-item:hover,.bottom-nav-item.active{color:#fff;}
.bottom-nav-item.active svg{stroke:#f5c800;}

@media(max-width:640px){
  .bottom-nav{display:flex;}
  .main-nav{display:none!important;}
  body{padding-bottom:72px;}
  .current-grid,.current-grid-bottom{grid-template-columns:repeat(2,1fr);}
  header{padding:14px 18px;}
  .hero{padding:20px 18px 0;}
  .main{padding:24px 16px 60px;}
  .current-card{padding:20px;}
  .forecast-table th:nth-child(6),.forecast-table td:nth-child(6){display:none;}
  .spot-btn{font-size:8px;padding:10px 3px;}
  .top-two-col{grid-template-columns:1fr;}
  .hero-inner{flex-direction:column;align-items:flex-start;gap:12px;}
  .coastline-map{display:none;}
  #searchPage{padding:28px 18px;}
  .globe-wrap{width:130px;height:130px;margin-bottom:32px;}
  .globe-canvas{width:130px;height:130px;}
}
</style>
</head>
<body>

<div class="modal-backdrop hidden" id="modal">
  <div class="modal">
    <div class="modal-title">Edit Profile</div>
    <div class="modal-sub">Updates across the whole app</div>
    <div class="field"><label class="field-label">Your Name</label><input type="text" id="p-name" placeholder="e.g. Conor"/></div>
    <div class="field">
      <label class="field-label">Skill Level</label>
      <select id="p-skill">
        <option value="beginner">Beginner — still learning to stand up</option>
        <option value="intermediate">Intermediate — comfortable on green waves</option>
        <option value="advanced" selected>Advanced — surfing most conditions</option>
        <option value="expert">Expert — I'm a hell man and will charge anything</option>
      </select>
    </div>
    <div class="field">
      <label class="field-label">Work Schedule</label>
      <select id="p-work">
        <option value="9to5" selected>9–5 weekdays (weekends free)</option>
        <option value="flexible">Flexible / remote</option>
        <option value="shift">Shift work — varies</option>
        <option value="retired">Retired / student</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveProfile()">Save →</button>
  </div>
</div>

<header>
  <div><div class="logo">QUIVER</div><div class="logo-tag">Surf Guide</div></div>
  <nav class="main-nav">
    <a href="index.html" class="nav-link active">Forecast</a>
    <a href="workshop.html" class="nav-link">Workshop</a>
    <a href="trip.html" class="nav-link">Trip</a>
  </nav>
  <button class="profile-btn" onclick="openModal()">Edit Profile</button>
</header>

<!-- SEARCH LANDING -->
<div id="searchPage">
  <div class="search-title">WHERE<br>TO?</div>
  <div class="search-sub">Select a surf spot</div>
  <div class="globe-wrap"><canvas class="globe-canvas" id="globeCanvas"></canvas></div>
  <div class="search-box-wrap">
    <input class="search-input" id="searchInput" placeholder="Search — Lahinch, Bundoran, Dublin..."
      autocomplete="off" oninput="onSearch(this.value)" onfocus="onSearch(this.value)" onblur="setTimeout(()=>document.getElementById('searchResults').classList.remove('show'),200)"/>
    <div class="search-results" id="searchResults"></div>
  </div>
  <div class="search-hint" id="searchHint">7 spots available</div>
</div>

<!-- FORECAST PAGE -->
<div id="forecastPage">
  <div class="hero">
    <div class="hero-inner">
      <div class="hero-text">
        <div class="area-name" id="heroRegion">Ireland</div>
        <div class="break-name" id="heroName">—</div>
        <div class="break-loc" id="heroLoc"></div>
      </div>
      <div class="coastline-map" id="coastlineMap"></div>
    </div>
    <div style="max-width:900px;margin:0 auto;">
      <div class="spot-selector" id="spotSelector"></div>
    </div>
  </div>
  <main class="main">
    <div id="app"><div class="status">Loading forecast...</div></div>
  </main>
</div>

<script>
// ── COASTLINE SVGs ──
// Slightly detailed line drawings per coastal region
// viewBox 0 0 130 100, coast path + headland hints + pin marker
const COASTLINE = {
  clare:`<svg viewBox="0 0 130 100" width="130" height="95" xmlns="http://www.w3.org/2000/svg">
    <!-- Liscannor Bay / Spanish Point / Lahinch coast -->
    <path d="M8,92 Q14,80 16,68 Q18,56 12,46 Q8,38 14,28 Q20,18 32,12 Q44,6 56,10 Q68,14 74,24 Q80,34 78,46 Q74,58 80,68 Q86,78 94,82 Q104,86 110,80 Q118,74 120,64" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    <!-- Liscannor headland -->
    <path d="M12,46 Q4,44 2,36 Q2,28 10,26" stroke="rgba(255,255,255,0.28)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- Mutton Island suggestion -->
    <path d="M86,44 Q92,40 96,44 Q98,50 92,52 Q86,52 86,44" stroke="rgba(255,255,255,0.2)" stroke-width="1" fill="none"/>
    <!-- Hag's Head -->
    <path d="M78,46 Q84,42 88,48" stroke="rgba(255,255,255,0.22)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- Pin -->
    <circle cx="18" cy="62" r="4.5" fill="none" stroke="#f5c800" stroke-width="1.5"/>
    <circle cx="18" cy="62" r="1.8" fill="#f5c800"/>
    <line x1="18" y1="57.5" x2="18" y2="48" stroke="#f5c800" stroke-width="1.2"/>
  </svg>`,

  donegal:`<svg viewBox="0 0 130 100" width="130" height="95" xmlns="http://www.w3.org/2000/svg">
    <!-- Donegal Bay coastline — Bundoran area -->
    <path d="M6,88 Q10,76 8,64 Q6,52 12,42 Q18,32 14,22 Q12,14 20,8 Q30,2 42,6 Q52,10 56,20 Q60,30 56,40 Q52,50 58,58 Q66,66 76,62 Q86,58 94,64 Q102,70 104,80 Q106,88 114,90" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    <!-- Donegal Bay inner -->
    <path d="M56,40 Q62,36 68,40 Q72,46 68,52 Q62,56 58,52" stroke="rgba(255,255,255,0.22)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- Tullan strand suggestion -->
    <path d="M12,42 Q6,38 4,30 Q4,22 12,20" stroke="rgba(255,255,255,0.22)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- St John's Point suggestion -->
    <path d="M94,64 Q100,58 106,62" stroke="rgba(255,255,255,0.18)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- Pin at Bundoran -->
    <circle cx="13" cy="50" r="4.5" fill="none" stroke="#f5c800" stroke-width="1.5"/>
    <circle cx="13" cy="50" r="1.8" fill="#f5c800"/>
    <line x1="13" y1="45.5" x2="13" y2="36" stroke="#f5c800" stroke-width="1.2"/>
  </svg>`,

  dublin:`<svg viewBox="0 0 130 100" width="130" height="95" xmlns="http://www.w3.org/2000/svg">
    <!-- Dublin Bay / Wicklow coast, east-facing -->
    <path d="M20,8 Q26,14 30,24 Q34,34 30,46 Q26,56 30,66 Q36,76 42,82 Q50,90 60,90 Q70,90 78,84 Q86,78 84,68 Q82,58 88,50 Q94,42 100,36 Q108,28 112,20" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    <!-- Howth Head -->
    <path d="M20,8 Q10,10 6,18 Q6,26 16,28 Q26,28 30,24" stroke="rgba(255,255,255,0.28)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- Bray Head suggestion -->
    <path d="M60,90 Q58,98 52,98 Q46,96 46,90" stroke="rgba(255,255,255,0.2)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- Dalkey Island hint -->
    <path d="M74,84 Q80,88 82,84 Q82,80 78,80" stroke="rgba(255,255,255,0.18)" stroke-width="1" fill="none"/>
    <!-- Dublin Bay sweep -->
    <path d="M30,46 Q22,50 16,44 Q12,36 18,30" stroke="rgba(255,255,255,0.22)" stroke-width="1" fill="none" stroke-linecap="round"/>
    <!-- Pin at White Rock / Killiney area -->
    <circle cx="34" cy="64" r="4.5" fill="none" stroke="#f5c800" stroke-width="1.5"/>
    <circle cx="34" cy="64" r="1.8" fill="#f5c800"/>
    <line x1="34" y1="59.5" x2="34" y2="50" stroke="#f5c800" stroke-width="1.2"/>
    <!-- Second pin for Killiney (slightly south) -->
    <circle cx="40" cy="74" r="3" fill="none" stroke="rgba(245,200,0,0.45)" stroke-width="1.2"/>
    <circle cx="40" cy="74" r="1.2" fill="rgba(245,200,0,0.45)"/>
  </svg>`
};

// ── ALL SPOTS ──
const ALL_SPOTS = [
  {id:'beach',    name:'Spanish Point Beach', shortName:'Beach',       region:'Co. Clare',   country:'Ireland', group:'spanish-point', groupName:'Spanish Point',   lat:52.841486, lng:-9.435728,  beachFacing:270, swellWindow:[247,315], level:'Beginner to intermediate', waveType:'Beach break',  coastline:'clare'},
  {id:'inner',    name:'Inner Reef',          shortName:'Inner Reef',  region:'Co. Clare',   country:'Ireland', group:'spanish-point', groupName:'Spanish Point',   lat:52.844650, lng:-9.443633,  beachFacing:225, swellWindow:[202,292], level:'Intermediate and above',   waveType:'A-frame',      coastline:'clare'},
  {id:'middle',   name:'Middle Reef',         shortName:'Middle Reef', region:'Co. Clare',   country:'Ireland', group:'spanish-point', groupName:'Spanish Point',   lat:52.845419, lng:-9.449256,  beachFacing:225, swellWindow:[202,292], level:'Intermediate and above',   waveType:'Right hander', coastline:'clare'},
  {id:'lahinch',  name:'Lahinch Beach',       shortName:'Lahinch',     region:'Co. Clare',   country:'Ireland', group:'lahinch',       groupName:'Lahinch',         lat:52.933056, lng:-9.344167,  beachFacing:270, swellWindow:[225,315], level:'All levels',               waveType:'Beach break',  coastline:'clare'},
  {id:'bundoran', name:'Bundoran Peak',       shortName:'The Peak',    region:'Co. Donegal', country:'Ireland', group:'bundoran',      groupName:'Bundoran',        lat:54.477222, lng:-8.277778,  beachFacing:247, swellWindow:[225,315], level:'Intermediate and above',   waveType:'Reef break',   coastline:'donegal'},
  {id:'whiterock',name:'White Rock',          shortName:'White Rock',  region:'Co. Dublin',  country:'Ireland', group:'dublin-south',  groupName:'Dublin South',    lat:53.266083, lng:-6.105183,  beachFacing:90,  swellWindow:[45,135],  level:'All levels',               waveType:'Beach break',  coastline:'dublin'},
  {id:'killiney', name:'Killiney',            shortName:'Killiney',    region:'Co. Dublin',  country:'Ireland', group:'dublin-south',  groupName:'Dublin South',    lat:53.256386, lng:-6.111353,  beachFacing:90,  swellWindow:[45,135],  level:'All levels',               waveType:'Beach break',  coastline:'dublin'},
];

function getSpotsInGroup(g){return ALL_SPOTS.filter(s=>s.group===g);}

let currentSpot = ALL_SPOTS[0];
let currentGroup = getSpotsInGroup('spanish-point');
let globeInterval = null;
let globeAngle = 0;
let globeSpinSpeed = 0.003;
let globeTargetSpeed = 0.003;

// ── PROFILE ──
function getProfile(){try{const p=JSON.parse(localStorage.getItem('quiver_profile'));return p&&p.skill?p:null;}catch(e){return null;}}
function saveProfile(){
  try{
    const name=document.getElementById('p-name').value.trim()||'Surfer';
    const skill=document.getElementById('p-skill').value;
    const work=document.getElementById('p-work').value;
    localStorage.setItem('quiver_profile',JSON.stringify({name,skill,work}));
  }catch(e){}
  document.getElementById('modal').classList.add('hidden');
}
function openModal(){
  const p=getProfile();
  if(p){
    document.getElementById('p-name').value=p.name||'';
    ['p-skill','p-work'].forEach(id=>{const s=document.getElementById(id);[...s.options].forEach(o=>o.selected=o.value===p[id.replace('p-','')]);});
  }
  document.getElementById('modal').classList.remove('hidden');
}
document.getElementById('modal').addEventListener('click',function(e){if(e.target===this)this.classList.add('hidden');});

// ── GLOBE ──
function initGlobe(){
  const canvas=document.getElementById('globeCanvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const S=canvas.offsetWidth||180;
  canvas.width=S*dpr;canvas.height=S*dpr;
  ctx.scale(dpr,dpr);
  const R=S/2-2,cx=S/2,cy=S/2;

  // Ireland-ish green dots
  const ireDots=[[53,-8],[54,-8],[53,-6],[52,-9],[55,-7],[54,-6]];

  function draw(angle){
    ctx.clearRect(0,0,S,S);
    const g=ctx.createRadialGradient(cx-R*.3,cy-R*.3,R*.05,cx,cy,R);
    g.addColorStop(0,'#152015');g.addColorStop(.6,'#0a120a');g.addColorStop(1,'#050805');
    ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.07)';ctx.lineWidth=0.8;
    for(let lat=-60;lat<=60;lat+=30){
      const y=cy-R*Math.sin(lat*Math.PI/180),rL=R*Math.cos(lat*Math.PI/180);
      if(rL>0){ctx.beginPath();ctx.ellipse(cx,y,rL,rL*0.15,0,0,Math.PI*2);ctx.stroke();}
    }
    for(let lon=0;lon<360;lon+=30){
      const a=lon*Math.PI/180+angle;
      ctx.beginPath();
      for(let lat=-90;lat<=90;lat+=5){
        const phi=lat*Math.PI/180;
        const x=cx+R*Math.cos(phi)*Math.sin(a),y=cy-R*Math.sin(phi);
        const vis=Math.cos(phi)*Math.cos(a)>-0.1;
        if(vis)lat===-90?ctx.moveTo(x,y):ctx.lineTo(x,y);else ctx.moveTo(x,y);
      }
      ctx.strokeStyle='rgba(255,255,255,0.07)';ctx.stroke();
    }
    ireDots.forEach(([lat,lon])=>{
      const phi=lat*Math.PI/180,lam=lon*Math.PI/180+angle;
      if(Math.cos(phi)*Math.cos(lam)>0){
        const x=cx+R*Math.cos(phi)*Math.sin(lam),y=cy-R*Math.sin(phi);
        ctx.beginPath();ctx.arc(x,y,2.5,0,Math.PI*2);
        ctx.fillStyle='rgba(34,197,94,0.75)';ctx.fill();
      }
    });
    ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=1;ctx.stroke();
    const sh=ctx.createRadialGradient(cx-R*.35,cy-R*.35,R*.02,cx-R*.2,cy-R*.2,R*.6);
    sh.addColorStop(0,'rgba(255,255,255,0.07)');sh.addColorStop(1,'rgba(255,255,255,0)');
    ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=sh;ctx.fill();
  }

  if(globeInterval)clearInterval(globeInterval);
  globeInterval=setInterval(()=>{
    globeSpinSpeed+=(globeTargetSpeed-globeSpinSpeed)*0.06;
    globeAngle+=globeSpinSpeed;
    draw(globeAngle);
  },16);
}

// ── SEARCH ──
function onSearch(val){
  const q=val.trim().toLowerCase();
  globeTargetSpeed=q.length>0?0.05:0.004;
  const res=document.getElementById('searchResults');
  const seen={};
  const matches=ALL_SPOTS.filter(s=>{
    const str=(s.groupName+' '+s.region+' '+s.name).toLowerCase();
    if((!q||str.includes(q))&&!seen[s.group]){seen[s.group]=true;return true;}
    return false;
  });
  if(matches.length===0){
    res.innerHTML='<div class="search-result-item"><div class="sri-name" style="color:var(--muted)">No spots found</div></div>';
  }else{
    res.innerHTML=matches.map(s=>{
      const gs=getSpotsInGroup(s.group);
      const sub=gs.length>1?`${gs.length} breaks · `:'';
      return`<div class="search-result-item" onmousedown="selectSpot('${s.id}')">
        <div class="sri-name">${s.groupName}</div>
        <div class="sri-region">${sub}${s.region} · ${s.country}</div>
      </div>`;
    }).join('');
  }
  res.classList.add('show');
}

function selectSpot(id){
  const spot=ALL_SPOTS.find(s=>s.id===id)||ALL_SPOTS[0];
  currentSpot=spot;
  currentGroup=getSpotsInGroup(spot.group);
  globeTargetSpeed=0.14;
  setTimeout(()=>{globeTargetSpeed=0;},700);
  document.getElementById('searchResults').classList.remove('show');
  document.getElementById('searchInput').value='';
  setTimeout(showForecast,500);
}

function showForecast(){
  document.getElementById('searchPage').classList.add('hidden');
  document.getElementById('forecastPage').classList.add('show');
  updateHero();
  buildSelector([]);
  load();
}

function showSearch(){
  document.getElementById('forecastPage').classList.remove('show');
  document.getElementById('searchPage').classList.remove('hidden');
  globeTargetSpeed=0.004;
  onSearch('');
}

function updateHero(){
  const s=currentSpot;
  const words=s.groupName.toUpperCase().split(' ');
  const mid=Math.ceil(words.length/2);
  document.getElementById('heroName').innerHTML=words.length>1?`${words.slice(0,mid).join(' ')}<br>${words.slice(mid).join(' ')}`:words[0];
  document.getElementById('heroRegion').textContent=`${s.region} · Ireland`;
  document.getElementById('heroLoc').textContent=`${s.lat.toFixed(4)}° N, ${Math.abs(s.lng).toFixed(4)}° W`;
  document.getElementById('coastlineMap').innerHTML=COASTLINE[s.coastline]||'';
}

function switchSpot(id){
  currentSpot=ALL_SPOTS.find(s=>s.id===id)||currentSpot;
  updateHero();
  load();
}

function buildSelector(dotRatings){
  const sel=document.getElementById('spotSelector');
  sel.innerHTML=currentGroup.map((s,i)=>{
    const r=dotRatings[i]||'';
    const dc=r==='good'||r==='epic'?'good-dot':r==='fair'?'fair-dot':r==='poor'?'poor-dot':'';
    return`<button class="spot-btn${s.id===currentSpot.id?' active':''}" onclick="switchSpot('${s.id}')"><span class="spot-badge ${dc}"></span>${s.shortName}</button>`;
  }).join('');
}

// ── HELPERS ──
function windDir(d){return['N','NE','E','SE','S','SW','W','NW'][Math.round(d/45)%8];}
function arrowChar(d){return['↓','↙','←','↖','↑','↗','→','↘'][Math.round(d/45)%8];}
function dirArrowSVG(deg,color){return`<div class="dir-arrow"><svg viewBox="0 0 24 24" style="transform:rotate(${deg+180}deg)" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="6 11 12 5 18 11"/></svg></div>`;}
function waveEnergy(h,t){return Math.round(0.5*h*h*t);}
function isOffshore(wd,spot){const d=((wd-spot.beachFacing)+360)%360;return d>90&&d<270;}
function swellInWindow(sd,spot){const[lo,hi]=spot.swellWindow;return lo<=hi?sd>=lo&&sd<=hi:sd>=lo||sd<=hi;}
function skillThresholds(skill){return{beginner:{minH:0.3,maxH:1.0,minP:5},intermediate:{minH:0.5,maxH:1.8,minP:7},advanced:{minH:0.8,maxH:3.5,minP:9},expert:{minH:1.2,maxH:99,minP:10}}[skill]||{minH:0.5,maxH:99,minP:7};}
function rate(h,w,p,skill){const t=skillThresholds(skill||'advanced');if(h<0.3)return'flat';const sOk=h>=t.minH&&h<=t.maxH,pOk=p>=t.minP;if(sOk&&pOk&&w<6)return'epic';if(sOk&&pOk&&w<12)return'good';if(sOk&&w<17)return'fair';return'poor';}
function rateLabel(r){return{epic:'Epic',good:'Good conditions',fair:'Fair conditions',poor:'Poor conditions',flat:'Flat'}[r];}

function conditionsRead(h,ws,wd,swP,swD,wD,spot){
  const wDir=windDir(wd),bf=spot.beachFacing,parts=[];
  if(h<0.3)return"Waves too small to surf.";
  const ft=(h*3.281).toFixed(0);
  if(h>=2.5)parts.push(`solid ${ft}ft of swell in the water`);
  else if(h>=1.2)parts.push(`${ft}ft of swell running`);
  else parts.push(`small ${ft}ft waves`);
  if(swP>=14)parts.push("very long period — likely to have good shape");
  else if(swP>=10)parts.push("decent period on the swell");
  else if(swP<7)parts.push("short period — likely to be choppy");
  const diff=((wd-bf)+360)%360;
  if(ws<6)parts.push("virtually no wind");
  else if(diff>90&&diff<270&&ws<17)parts.push(`${wDir} offshore — could clean up the faces`);
  else if(diff>90&&diff<270&&ws>=17)parts.push(`strong ${wDir} offshore — may be too much`);
  else if((diff<=90||diff>=270)&&ws>=17)parts.push(`strong ${wDir} onshore — likely messy`);
  else if((diff<=90||diff>=270)&&ws>=9)parts.push(`${wDir} onshore — expect some chop on the face`);
  else if((diff<=90||diff>=270)&&ws<9)parts.push(`light ${wDir} onshore`);
  else{
    const co=(diff>90&&diff<=135)||(diff>=225&&diff<270),cn=(diff>45&&diff<=90)||(diff>=270&&diff<315);
    if(co&&ws<14)parts.push(`${wDir} cross-offshore — light texture, probably manageable`);
    else if(co&&ws>=14)parts.push(`${wDir} cross-offshore — getting strong, likely choppy on one side`);
    else if(cn&&ws<14)parts.push(`${wDir} cross-onshore — light but may ruffle the faces`);
    else if(cn&&ws>=14)parts.push(`${wDir} cross-onshore — expect messy conditions`);
    else parts.push(`${wDir} sideshore at ${ws.toFixed(0)}mph`);
  }
  return parts.join(". ")+".";
}

function getSunTimes(lat,lng,date){
  const rad=Math.PI/180,doy=Math.floor((date-new Date(date.getFullYear(),0,0))/86400000);
  const B=(360/365)*(doy-81)*rad,eq=9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B);
  const decl=23.45*Math.sin(B)*rad,HA=Math.acos(-Math.tan(lat*rad)*Math.tan(decl))/rad;
  const noon=12-(lng/15)-(eq/60),sr=noon-HA/15,ss=noon+HA/15;
  const off=(date.getMonth()>=2&&date.getMonth()<=9)?1:0;
  const fmt=h=>{const hh=Math.floor(h+off)%24,mm=Math.round((h+off-Math.floor(h+off))*60);return`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;};
  return{sunrise:sr+off,sunset:ss+off,sunriseStr:fmt(sr),sunsetStr:fmt(ss)};
}

function buildWindowAlert(slots,profile,sun,spot){
  if(!profile)return'';
  const{name,skill,work}=profile,t=skillThresholds(skill),now=new Date(),flex=work==='flexible'||work==='retired';
  const scored=slots.map(s=>{
    const sd=new Date(s.time),hour=sd.getHours(),dow=sd.getDay();
    const avail=flex||[0,6].includes(dow)||hour<8||hour>18;
    const offshore=isOffshore(s.wd,spot),gW=offshore||s.ws<9;
    const gS=s.h>=t.minH&&s.h<=t.maxH,gP=s.p>=t.minP;
    const daylight=hour>=Math.floor(sun.sunrise)&&hour<=Math.floor(sun.sunset);
    const swOk=swellInWindow(s.swDir??s.waveDir,spot);
    let sc=0;if(gS)sc+=3;if(gP)sc+=2;if(gW)sc+=2;if(offshore)sc+=1;if(avail)sc+=2;if(daylight)sc+=1;if(swOk)sc+=1;
    return{...s,sc,avail,gS,r:rate(s.h,s.ws,s.p,skill),slotDate:sd,hour};
  });
  const best=scored.filter(s=>s.sc>=5&&s.gS).sort((a,b)=>b.sc-a.sc)[0];
  if(!best){
    const next=scored.filter(s=>s.gS).sort((a,b)=>b.sc-a.sc)[0];
    if(!next)return`<div class="window-alert poor-window"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">Nothing great in the next 24 hours. Check back as conditions develop.</div></div>`;
    return`<div class="window-alert fair-window"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">Best of a quieter spell around ${fmtT(next.time)}. ${next.h.toFixed(1)}m, ${next.p.toFixed(0)}s — one to keep an eye on.</div></div>`;
  }
  const dn=best.slotDate.toDateString()===now.toDateString()?'today':best.slotDate.toLocaleDateString('en-IE',{weekday:'long'});
  const unavNote=!best.avail&&work==='9to5'?' — falls during work hours':'';
  const windNote=isOffshore(best.wd,spot)?`${windDir(best.wd)} offshore wind`:`light ${windDir(best.wd)} wind`;
  const qw=best.r==='epic'?'an epic':best.r==='good'?'a good':'a fair';
  let msg=`Looks like ${qw} window around ${fmtT(best.time)} ${dn}${unavNote}. `;
  msg+=`${best.h.toFixed(1)}m at ${best.p.toFixed(0)}s with ${windNote}.`;
  if(skill==='beginner'&&best.h<1.0)msg+=` A manageable size for developing surfers.`;
  else if(skill==='beginner'&&best.h>=1.0)msg+=` Slightly bigger than ideal for beginners — one to watch.`;
  else if(skill==='expert'&&best.h>=2.0)msg+=` Sizeable swell on the way.`;
  else if(skill==='expert'&&best.h<1.0)msg+=` On the smaller side for the time being.`;
  else if(skill==='advanced'&&best.h<0.9)msg+=` A quieter spell — smaller than ideal.`;
  const ac=best.r==='good'||best.r==='epic'?'good-window':'fair-window';
  return`<div class="window-alert ${ac}"><div class="window-eyebrow">Surf Window · ${name} · ${spot.shortName}</div><div class="window-text">${msg}</div></div>`;
}

function fmtT(iso){return new Date(iso).toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit',hour12:false});}
function fmtDay(iso){const d=new Date(iso),t=new Date(),tm=new Date();tm.setDate(tm.getDate()+1);if(d.toDateString()===t.toDateString())return'Today';if(d.toDateString()===tm.toDateString())return'Tmrw';return d.toLocaleDateString('en-IE',{weekday:'short'});}

function extractTides(times,levels){
  const tides=[],today=new Date();
  for(let i=1;i<levels.length-1;i++){
    if(levels[i]==null)continue;
    const isH=levels[i]>levels[i-1]&&levels[i]>levels[i+1],isL=levels[i]<levels[i-1]&&levels[i]<levels[i+1];
    if(isH||isL){const d=new Date(times[i]);if(d.toDateString()===today.toDateString()||(d>today&&tides.length<6))tides.push({type:isH?'high':'low',time:times[i],height:levels[i]});}
    if(tides.length>=6)break;
  }
  return tides;
}

function drawGraph(canvas,times,heights,periods,skill){
  const dpr=window.devicePixelRatio||1,W=canvas.offsetWidth,H=140;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const t=skillThresholds(skill||'advanced'),maxH=Math.max(...heights.filter(Boolean),2)*1.15;
  const pad={l:36,r:12,t:16,b:28},gw=W-pad.l-pad.r,gh=H-pad.t-pad.b;
  const toX=i=>(i/(heights.length-1))*gw+pad.l,toY=v=>gh-(v/maxH)*gh+pad.t;
  ctx.fillStyle='rgba(34,197,94,0.06)';ctx.fillRect(pad.l,toY(Math.min(t.maxH,maxH)),gw,toY(t.minH)-toY(Math.min(t.maxH,maxH)));
  ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;
  for(let v=0.5;v<=maxH;v+=0.5){const y=toY(v);if(y<pad.t||y>H-pad.b)continue;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();if(v%1===0){ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='10px "DM Mono",monospace';ctx.fillText(v+'m',2,y+4);}}
  let lastDay='';
  times.forEach((tm,i)=>{const d=new Date(tm),ds=d.toLocaleDateString('en-IE',{weekday:'short'});if(ds!==lastDay){const x=toX(i);ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,H-pad.b);ctx.stroke();ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='9px "DM Mono",monospace';ctx.fillText(ds,x+3,H-pad.b+14);lastDay=ds;}});
  ctx.beginPath();heights.forEach((v,i)=>{if(v==null)return;const x=toX(i),y=toY(v);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.lineTo(toX(heights.length-1),H-pad.b);ctx.lineTo(pad.l,H-pad.b);ctx.closePath();
  const gr=ctx.createLinearGradient(0,pad.t,0,H-pad.b);gr.addColorStop(0,'rgba(255,255,255,0.12)');gr.addColorStop(1,'rgba(255,255,255,0.01)');ctx.fillStyle=gr;ctx.fill();
  for(let i=1;i<heights.length;i++){if(!heights[i]||!heights[i-1])continue;const r=rate(heights[i],10,periods[i]||8,skill);ctx.strokeStyle=r==='good'||r==='epic'?'rgba(34,197,94,0.9)':r==='fair'?'rgba(245,200,0,0.9)':'rgba(239,68,68,0.7)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(toX(i-1),toY(heights[i-1]));ctx.lineTo(toX(i),toY(heights[i]));ctx.stroke();}
  const now=new Date(),ni=times.findIndex(tm=>new Date(tm)>=now);
  if(ni>0){const x=toX(ni);ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,H-pad.b);ctx.stroke();ctx.setLineDash([]);ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='8px "DM Mono",monospace';ctx.fillText('now',x+3,pad.t+10);}
}

async function fetchDotRatings(){
  const now=new Date(),ns=now.toISOString().slice(0,13);
  return Promise.all(currentGroup.map(async s=>{
    try{
      const[mr,wr]=await Promise.all([fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${s.lat}&longitude=${s.lng}&hourly=wave_height,wave_period&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=1`),fetch(`https://api.open-meteo.com/v1/forecast?latitude=${s.lat}&longitude=${s.lng}&hourly=wind_speed_10m&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=1`)]);
      const m=await mr.json(),w=await wr.json();
      const ci=m.hourly.time.findIndex(t=>t.startsWith(ns));
      return rate(m.hourly.wave_height[ci]??0,w.hourly.wind_speed_10m[ci]??0,m.hourly.wave_period[ci]??0,getProfile()?.skill);
    }catch(e){return'poor';}
  }));
}

async function load(){
  const app=document.getElementById('app'),profile=getProfile(),skill=profile?.skill||'advanced',spot=currentSpot;
  app.innerHTML='<div class="status">Loading forecast...</div>';
  try{
    const[mr,wr,tideR,dots]=await Promise.all([
      fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${spot.lat}&longitude=${spot.lng}&hourly=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period,secondary_swell_wave_height,secondary_swell_wave_direction,secondary_swell_wave_period,sea_surface_temperature&daily=wave_height_max,wave_period_max,wave_direction_dominant,swell_wave_height_max&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=7`),
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${spot.lat}&longitude=${spot.lng}&hourly=wind_speed_10m,wind_direction_10m&wind_speed_unit=mph&timezone=Europe%2FDublin&forecast_days=7`),
      fetch(`https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.json?time,Water_Level_LAT&time>=${new Date(Date.now()-7200000).toISOString().slice(0,19)}Z&time<=${new Date(Date.now()+172800000).toISOString().slice(0,19)}Z&station_id=%22Galway%20Port%22&orderBy(%22time%22)`).catch(()=>null),
      fetchDotRatings()
    ]);
    if(!mr.ok)throw new Error('Marine API '+mr.status);
    if(!wr.ok)throw new Error('Wind API '+wr.status);
    const m=await mr.json(),w=await wr.json();
    const times=m.hourly.time,wH=m.hourly.wave_height,wDir=m.hourly.wave_direction,wP=m.hourly.wave_period;
    const swD=m.hourly.swell_wave_direction,swP=m.hourly.swell_wave_period;
    const sw2H=m.hourly.secondary_swell_wave_height,sw2D=m.hourly.secondary_swell_wave_direction,sw2P=m.hourly.secondary_swell_wave_period;
    const sst=m.hourly.sea_surface_temperature,wndS=w.hourly.wind_speed_10m,wndD=w.hourly.wind_direction_10m,daily=m.daily;
    const now=new Date(),ns=now.toISOString().slice(0,13);
    let ci=times.findIndex(t=>t.startsWith(ns));if(ci<0)ci=0;
    const cH=wH[ci]??0,cD=wDir[ci]??0,cP=wP[ci]??0,cSwD=swD[ci]??cD,cSwP=swP[ci]??cP;
    const cSw2H=sw2H?.[ci]??0,cSw2D=sw2D?.[ci]??0,cSw2P=sw2P?.[ci]??0,cSST=sst?.[ci]??null;
    const cWS=wndS[ci]??0,cWD=wndD[ci]??0;
    const r=rate(cH,cWS,cP,skill),energy=waveEnergy(cH,cP),read=conditionsRead(cH,cWS,cWD,cSwP,cSwD,cD,spot);
    const rColor=r==='good'||r==='epic'?'var(--good)':r==='fair'?'var(--fair)':r==='poor'?'var(--poor)':'var(--muted)';
    const sun=getSunTimes(spot.lat,spot.lng,now);
    const swellGood=swellInWindow(cSwD||cD,spot);
    const swellWarnHTML=!swellGood&&cH>=0.3?`<div class="swell-warning">⚠ Swell direction (${windDir(cSwD||cD)}) may not be optimal for this break — ${spot.shortName} works best on ${windDir(spot.swellWindow[0])}–${windDir(spot.swellWindow[1])} swell.</div>`:'';
    const slots=[];
    for(let i=ci;i<ci+24&&i<times.length;i+=3)slots.push({time:times[i],h:wH[i]??0,p:wP[i]??0,waveDir:wDir[i]??0,swDir:swD[i]??null,swP:swP[i]??0,ws:wndS[i]??0,wd:wndD[i]??0});
    let tides=[];
    if(tideR&&tideR.ok){try{const tj=await tideR.json();const rows=tj.table?.rows||[];tides=extractTides(rows.map(r=>r[0]),rows.map(r=>r[1]));}catch(e){}}
    const days=daily.time.map((t,i)=>({time:t,h:daily.wave_height_max[i]??0,p:daily.wave_period_max[i]??0,dir:daily.wave_direction_dominant[i]??0}));
    const windowHTML=buildWindowAlert(slots,profile,sun,spot);
    buildSelector(dots);

    app.innerHTML=`
      ${swellWarnHTML}
      <div class="top-two-col">
        <div class="top-col"><div class="top-col-label">Live</div><span class="badge badge-${r}">${rateLabel(r)}</span><div class="conditions-read">${read}</div></div>
        <div class="top-col">${windowHTML}</div>
      </div>
      <div class="current-card">
        <div class="card-label">Now · ${now.toLocaleDateString('en-IE',{weekday:'long'})} ${fmtT(now.toISOString())}</div>
        <div class="current-grid">
          <div><div class="c-val">${cH.toFixed(1)}<span class="c-unit">m</span></div><div class="c-lbl">Wave Height</div></div>
          <div><div class="c-val">${cP.toFixed(0)}<span class="c-unit">s</span></div><div class="c-lbl">Period</div></div>
          <div><div class="c-val">${(cH*3.281).toFixed(1)}<span class="c-unit">ft</span></div><div class="c-lbl">In Feet</div></div>
        </div>
        <div class="current-grid-bottom">
          <div><div class="dir-display">${dirArrowSVG(cSwD,'var(--fair)')}<div><div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">${windDir(cSwD)}</div><div class="c-lbl">Swell Dir</div></div></div></div>
          <div><div class="dir-display">${dirArrowSVG(cWD,'rgba(255,255,255,0.6)')}<div><div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">${cWS.toFixed(0)}<span class="c-unit">mph</span> ${windDir(cWD)}</div><div class="c-lbl">Wind</div></div></div></div>
          <div><div class="c-val" style="color:${rColor}">${energy}<span class="c-unit">kJ/m</span></div><div class="c-lbl">Wave Energy</div>${cSST!==null?`<div style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(255,255,255,0.45);margin-top:8px;">${cSST.toFixed(1)}°C water</div>`:''}</div>
        </div>
      </div>
      ${cSw2H>0.2?`<div class="swell-secondary"><div style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-right:8px;">Secondary Swell</div><div class="swell-sec-item"><div class="swell-sec-label">Height</div><div class="swell-sec-val">${cSw2H.toFixed(1)}<span style="font-size:11px;opacity:0.4">m</span></div></div><div class="swell-sec-item"><div class="swell-sec-label">Period</div><div class="swell-sec-val">${cSw2P.toFixed(0)}<span style="font-size:11px;opacity:0.4">s</span></div></div><div class="swell-sec-item"><div class="swell-sec-label">Direction</div><div class="swell-sec-val">${arrowChar(cSw2D)} ${windDir(cSw2D)}</div></div></div>`:''}
      <div class="sec-label">7 Day Swell Arrival</div>
      <div class="graph-wrap"><canvas class="graph-canvas" id="swellGraph"></canvas></div>
      <div class="sec-label">Next 24 Hours</div>
      <table class="forecast-table">
        <thead><tr><th>Time</th><th>Height</th><th>Swell</th><th>Wind</th><th>Period</th><th>Energy</th></tr></thead>
        <tbody>${slots.map(s=>{
          const sr=rate(s.h,s.ws,s.p,skill),dir=s.swDir??s.waveDir,slotH=new Date(s.time).getHours();
          const isDawn=Math.abs(slotH-Math.floor(sun.sunrise))<=1,isDusk=Math.abs(slotH-Math.floor(sun.sunset))<=1;
          const isWork=profile?.work==='9to5'&&![0,6].includes(new Date(s.time).getDay())&&slotH>=9&&slotH<=17;
          const tag=isDawn?'<span class="row-tag dawn">First Light</span>':isDusk?'<span class="row-tag dusk">Last Light</span>':isWork?'<span class="row-tag work">Work hours</span>':'';
          return`<tr class="forecast-row ${sr}"><td><div class="row-time">${fmtT(s.time)}${tag?'<br>'+tag:''}</div></td><td><div class="row-height ${sr}">${s.h.toFixed(1)}<span class="row-unit">m</span></div></td><td><div class="row-dir">${arrowChar(dir)} ${windDir(dir)}<br><span style="font-size:9px;opacity:0.5">${(s.swP||s.p).toFixed(0)}s</span></div></td><td><div class="row-wind">${arrowChar(s.wd)} ${windDir(s.wd)}<br><span style="font-size:9px;opacity:0.5">${s.ws.toFixed(0)}mph</span></div></td><td><div class="row-period">${s.p.toFixed(0)}s</div></td><td><div class="row-energy">${waveEnergy(s.h,s.p)}</div></td></tr>`;
        }).join('')}</tbody>
      </table>
      ${tides.length>0?`<div class="sec-label">Tides · Today</div><div class="tide-grid">${tides.map(t=>`<div class="tide-card"><div class="tide-icon">${t.type==='high'?'↑':'↓'}</div><div><div class="tide-type">${t.type==='high'?'High':'Low'} Tide</div><div class="tide-time">${fmtT(t.time)}</div><div class="tide-ht">${t.height!=null?t.height.toFixed(2)+'m':''}</div></div></div>`).join('')}</div>`:''}
      <div class="sec-label">First &amp; Last Light</div>
      <div class="tide-grid">
        <div class="tide-card"><div class="tide-icon" style="color:rgba(100,180,255,0.8)">☀</div><div><div class="tide-type">First Light</div><div class="tide-time">${sun.sunriseStr}</div><div class="tide-ht">Sunrise</div></div></div>
        <div class="tide-card"><div class="tide-icon" style="color:rgba(255,160,60,0.8)">☀</div><div><div class="tide-type">Last Light</div><div class="tide-time">${sun.sunsetStr}</div><div class="tide-ht">Sunset</div></div></div>
      </div>
      <div class="sec-label">7 Day Outlook</div>
      <div class="seven-grid">${days.map(d=>{const dr=rate(d.h,10,d.p,skill);return`<div class="day-card ${dr}"><div class="day-name">${fmtDay(d.time)}</div><div class="day-height">${d.h.toFixed(1)}<span style="font-size:11px;opacity:0.4;letter-spacing:0">m</span></div><div class="day-detail">${arrowChar(d.dir)} ${windDir(d.dir)}<br>${d.p.toFixed(0)}s period</div></div>`;}).join('')}</div>
      <div class="sec-label">About This Break</div>
      <div class="spot-info">
        <div class="spot-info-item"><div class="spot-info-label">Wave Type</div><div class="spot-info-val">${spot.waveType}</div></div>
        <div class="spot-info-item"><div class="spot-info-label">Level</div><div class="spot-info-val">${spot.level}</div></div>
        <div class="spot-info-item"><div class="spot-info-label">Optimal Swell</div><div class="spot-info-val">${windDir(spot.swellWindow[0])}–${windDir(spot.swellWindow[1])}</div></div>
        <div class="spot-info-item"><div class="spot-info-label"><button onclick="showSearch()" style="background:none;border:none;font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.35);cursor:pointer;padding:0;transition:color 0.15s;" onmouseover="this.style.color='rgba(255,255,255,0.7)'" onmouseout="this.style.color='rgba(255,255,255,0.35)'">← Change spot</button></div></div>
      </div>
      <div class="disclaimer">In forecasting we don't deal in definites. Quiver Surf Forecast should be used in tandem with your own local knowledge of this wave.</div>
    `;
    requestAnimationFrame(()=>{const canvas=document.getElementById('swellGraph');if(canvas)drawGraph(canvas,times,wH,wP,skill);});
  }catch(e){
    app.innerHTML=`<div class="status error">Couldn't load — ${e.message}</div>`;
  }
}

// ── INIT ──
initGlobe();
onSearch('');
</script>

<nav class="bottom-nav">
  <a href="index.html" class="bottom-nav-item active">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h2M20 12h2M12 2v2M12 20v2"/><circle cx="12" cy="12" r="5"/><path d="M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
    <span>Forecast</span>
  </a>
  <a href="workshop.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    <span>Workshop</span>
  </a>
  <a href="trip.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>
    <span>Trip</span>
  </a>
</nav>
</body>
</html>
