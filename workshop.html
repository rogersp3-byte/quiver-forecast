<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiver — Workshop</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f0f0f;--surface:rgba(15,15,15,0.82);--surface2:rgba(30,30,30,0.9);
  --white:#fff;--muted:rgba(255,255,255,0.4);--faint:rgba(255,255,255,0.1);
  --good:#22c55e;--fair:#f5c800;--poor:#ef4444;
  --accent:#f5c800;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{
  font-family:'Archivo Black',sans-serif;color:var(--white);
  background:#0f0f0f;overflow-x:hidden;min-height:100vh;
}

/* BG */
.bg-photo{position:fixed;inset:0;z-index:0;}
.bg-overlay{
  position:fixed;inset:0;z-index:1;
  background:#0f0f0f;
}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.06;mix-blend-mode:overlay;}

/* HEADER */
header{position:relative;z-index:10;padding:18px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.3);backdrop-filter:blur(8px);}
.logo-wrap{}
.logo{font-size:18px;letter-spacing:2px;}
.logo-tag{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.main-nav{display:flex;gap:0;border:1px solid rgba(255,255,255,0.12);flex:1;margin:0 32px;}
.nav-link{flex:1;text-align:center;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:11px 20px;color:var(--muted);text-decoration:none;border-right:1px solid rgba(255,255,255,0.12);transition:all 0.15s;}
.nav-link:last-child{border-right:none;}
.nav-link:hover{color:var(--white);background:rgba(255,255,255,0.06);}
.nav-link.active{color:var(--white);background:rgba(255,255,255,0.08);}
.profile-btn{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid rgba(255,255,255,0.15);padding:7px 14px;cursor:pointer;}
.profile-btn:hover{border-color:rgba(255,255,255,0.35);color:rgba(255,255,255,0.7);}

/* MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:1000;display:none;align-items:center;justify-content:center;padding:24px;}
.modal-backdrop.show{display:flex;}
.modal{background:#1a1a1a;max-width:480px;width:100%;padding:36px;border:1px solid rgba(255,255,255,0.1);}
.modal-title{font-size:22px;letter-spacing:-0.5px;margin-bottom:6px;}
.modal-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:32px;}
.field{margin-bottom:22px;}
.field-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:10px;display:block;}
.field select,.field input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.15);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:12px 14px;outline:none;appearance:none;}
.modal-btn{width:100%;background:var(--white);color:#0f0f0f;border:none;font-family:'Archivo Black',sans-serif;font-size:13px;letter-spacing:1px;padding:16px;cursor:pointer;}

/* LAYOUT */
.page{position:relative;z-index:5;min-height:calc(100vh - 65px);display:flex;flex-direction:column;}

/* ONBOARDING (first time setup for workshop) */
.onboard-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 24px;}
.onboard-card{background:rgba(10,10,10,0.88);border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(12px);max-width:520px;width:100%;padding:40px;}
.onboard-title{font-size:clamp(28px,6vw,48px);letter-spacing:-1px;line-height:0.95;margin-bottom:8px;}
.onboard-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:36px;}
.q-field{margin-bottom:20px;}
.q-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.5);margin-bottom:10px;display:block;}
.q-select,.q-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:13px 16px;outline:none;appearance:none;transition:border-color 0.2s;}
.q-select:focus,.q-input:focus{border-color:rgba(255,255,255,0.35);}
.q-input::placeholder{color:rgba(255,255,255,0.25);}
.q-textarea{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:13px 16px;outline:none;resize:none;height:80px;transition:border-color 0.2s;}
.q-textarea:focus{border-color:rgba(255,255,255,0.35);}
.q-textarea::placeholder{color:rgba(255,255,255,0.25);}
.start-btn{width:100%;background:var(--accent);color:#0f0f0f;border:none;font-family:'Archivo Black',sans-serif;font-size:13px;letter-spacing:1px;padding:18px;cursor:pointer;margin-top:8px;transition:opacity 0.15s;}
.start-btn:hover{opacity:0.9;}
.start-btn:disabled{opacity:0.4;cursor:not-allowed;}

/* CHAT */
.chat-wrap{flex:1;display:flex;flex-direction:column;max-width:760px;width:100%;margin:0 auto;padding:28px 24px 0;}
.chat-header{margin-bottom:20px;}
.chat-title{font-size:clamp(22px,4vw,36px);letter-spacing:-0.5px;}
.chat-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:6px;}
.chat-messages{flex:1;overflow-y:auto;padding-bottom:16px;display:flex;flex-direction:column;gap:16px;max-height:calc(100vh - 340px);}
.chat-messages::-webkit-scrollbar{width:3px;}
.chat-messages::-webkit-scrollbar-track{background:transparent;}
.chat-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);}
.msg{max-width:88%;}
.msg.user{align-self:flex-end;}
.msg.assistant{align-self:flex-start;}
.msg-bubble{padding:14px 18px;font-family:'DM Mono',monospace;font-size:12px;line-height:1.7;}
.msg.user .msg-bubble{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.9);}
.msg.assistant .msg-bubble{background:rgba(245,200,0,0.08);border:1px solid rgba(245,200,0,0.2);color:rgba(255,255,255,0.88);}
.msg-label{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.msg.user .msg-label{text-align:right;}
.typing{display:flex;gap:4px;align-items:center;padding:14px 18px;background:rgba(245,200,0,0.06);border:1px solid rgba(245,200,0,0.15);width:fit-content;}
.typing span{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:bounce 1.2s infinite;}
.typing span:nth-child(2){animation-delay:0.2s;}
.typing span:nth-child(3){animation-delay:0.4s;}
@keyframes bounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-6px);}}
.chat-input-wrap{position:sticky;bottom:0;padding:16px 0 28px;background:linear-gradient(to bottom,transparent,rgba(0,0,0,0.9) 40%);}
.chat-input-row{display:flex;gap:0;border:1px solid rgba(255,255,255,0.15);background:rgba(10,10,10,0.9);backdrop-filter:blur(8px);}
.chat-input{flex:1;background:none;border:none;color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:16px 18px;outline:none;}
.chat-input::placeholder{color:rgba(255,255,255,0.25);}
.send-btn{background:var(--accent);border:none;color:#0f0f0f;font-family:'Archivo Black',sans-serif;font-size:11px;letter-spacing:1px;padding:0 22px;cursor:pointer;transition:opacity 0.15s;white-space:nowrap;}
.send-btn:hover{opacity:0.85;}
.send-btn:disabled{opacity:0.3;cursor:not-allowed;}
.reset-btn{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:none;border:none;cursor:pointer;padding:6px 0;margin-top:8px;}
.reset-btn:hover{color:rgba(255,255,255,0.6);}

@media(max-width:640px){
  header{padding:14px 18px;}
  .main-nav{display:none;}
  .chat-messages{max-height:calc(100vh - 300px);}
}

/* MOBILE BOTTOM NAV */
.bottom-nav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: rgba(10,10,10,0.97);
  border-top: 1px solid rgba(255,255,255,0.1);
  z-index: 500;
  padding: 10px 0 max(10px, env(safe-area-inset-bottom));
  backdrop-filter: blur(12px);
}
.bottom-nav-item {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; gap: 4px;
  color: rgba(255,255,255,0.35);
  text-decoration: none;
  font-family: 'DM Mono', monospace;
  font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase;
  transition: color 0.15s;
  padding: 4px 0;
}
.bottom-nav-item svg { width: 20px; height: 20px; }
.bottom-nav-item:hover,
.bottom-nav-item.active { color: #ffffff; }
.bottom-nav-item.active svg { stroke: #f5c800; }
@media (max-width: 640px) {
  .bottom-nav { display: flex; }
  .main-nav { display: none !important; }
  body { padding-bottom: 72px; }
}

</style>
</head>
<body>

<div class="bg-photo"></div>
<div class="bg-overlay"></div>

<!-- PROFILE MODAL -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <div class="modal-title">Edit Profile</div>
    <div class="modal-sub">Updates across the whole app</div>
    <div class="field"><label class="field-label">Your Name</label><input type="text" id="p-name" placeholder="e.g. Conor"/></div>
    <div class="field">
      <label class="field-label">Skill Level</label>
      <select id="p-skill">
        <option value="beginner">Beginner — still learning to stand up</option>
        <option value="intermediate">Intermediate — comfortable on green waves</option>
        <option value="advanced">Advanced — surfing most conditions</option>
        <option value="expert">Expert — I'm a hell man and will charge anything</option>
      </select>
    </div>
    <div class="field">
      <label class="field-label">Work Schedule</label>
      <select id="p-work">
        <option value="9to5">9–5 weekdays (weekends free)</option>
        <option value="flexible">Flexible / remote</option>
        <option value="shift">Shift work — varies</option>
        <option value="retired">Retired / student</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveProfile()">Save →</button>
  </div>
</div>

<header>
  <div class="logo-wrap"><div class="logo">QUIVER</div><div class="logo-tag">Surf Guide</div></div>
  <nav class="main-nav">
    <a href="index.html" class="nav-link">Forecast</a>
    <a href="workshop.html" class="nav-link active">Workshop</a>
    <a href="trip.html" class="nav-link">Trip</a>
  </nav>
  <button class="profile-btn" onclick="document.getElementById('modal').classList.add('show')">Edit Profile</button>
</header>

<div class="page" id="page">
  <!-- Onboarding or chat injected here -->
</div>

<script>
const ANTHROPIC_MODEL = 'claude-haiku-4-5-20251001';

// ── PROFILE ──
function getProfile(){try{const p=JSON.parse(localStorage.getItem('quiver_profile'));return p&&p.skill?p:null;}catch(e){return null;}}
function saveProfile(){
  try{
    const name=document.getElementById('p-name').value.trim()||'Surfer';
    const skill=document.getElementById('p-skill').value;
    const work=document.getElementById('p-work').value;
    localStorage.setItem('quiver_profile',JSON.stringify({name,skill,work}));
  }catch(e){}
  document.getElementById('modal').classList.remove('show');
}

// ── WORKSHOP STATE ──
function getWS(){try{return JSON.parse(localStorage.getItem('quiver_workshop'))||null;}catch(e){return null;}}
function saveWS(ws){try{localStorage.setItem('quiver_workshop',JSON.stringify(ws));}catch(e){}}
function clearWS(){try{localStorage.removeItem('quiver_workshop');}catch(e){}}

let messages = []; // conversation history

// ── ONBOARDING ──
function showOnboarding(){
  const profile = getProfile();
  const skillVal = profile?.skill || 'intermediate';
  document.getElementById('page').innerHTML = `
    <div class="onboard-wrap">
      <div class="onboard-card">
        <div class="onboard-title">YOUR<br>WORKSHOP</div>
        <div class="onboard-sub">Personalised surf coaching</div>

        <div class="q-field">
          <label class="q-label">What's your name?</label>
          <input class="q-input" id="q-name" placeholder="e.g. Conor" value="${profile?.name||''}" />
        </div>
        <div class="q-field">
          <label class="q-label">Skill level</label>
          <select class="q-select" id="q-skill">
            <option value="beginner" ${skillVal==='beginner'?'selected':''}>Beginner — still learning to stand up</option>
            <option value="intermediate" ${skillVal==='intermediate'?'selected':''}>Intermediate — comfortable on green waves</option>
            <option value="advanced" ${skillVal==='advanced'?'selected':''}>Advanced — surfing most conditions</option>
            <option value="expert" ${skillVal==='expert'?'selected':''}>Expert — I'm a hell man and will charge anything</option>
          </select>
        </div>
        <div class="q-field">
          <label class="q-label">What board are you riding?</label>
          <select class="q-select" id="q-board">
            <option value="foamie">Foamie / Softboard</option>
            <option value="longboard">Longboard</option>
            <option value="midlength">Mid-length</option>
            <option value="fish">Fish</option>
            <option value="shortboard" selected>Shortboard</option>
          </select>
        </div>
        <div class="q-field">
          <label class="q-label">How often do you surf?</label>
          <select class="q-select" id="q-freq">
            <option value="rarely">A few times a year</option>
            <option value="monthly">Once or twice a month</option>
            <option value="weekly" selected>Most weekends</option>
            <option value="frequent">A few times a week</option>
            <option value="daily">Nearly every day</option>
          </select>
        </div>
        <div class="q-field">
          <label class="q-label">What's the main thing you want to work on?</label>
          <textarea class="q-textarea" id="q-goal" placeholder="e.g. my backhand turns are weak, I struggle to read waves, I can't generate speed on small waves..."></textarea>
        </div>

        <button class="start-btn" onclick="startWorkshop()">Start My Workshop →</button>
      </div>
    </div>
  `;
}

// ── START WORKSHOP ──
async function startWorkshop(){
  const name = document.getElementById('q-name').value.trim() || 'Surfer';
  const skill = document.getElementById('q-skill').value;
  const board = document.getElementById('q-board').value;
  const freq  = document.getElementById('q-freq').value;
  const goal  = document.getElementById('q-goal').value.trim();

  if(!goal){ document.getElementById('q-goal').focus(); return; }

  // Save to profile too
  try{
    const existing = getProfile()||{};
    localStorage.setItem('quiver_profile', JSON.stringify({...existing, name, skill}));
  }catch(e){}

  // Save workshop state
  const ws = { name, skill, board, freq, goal, started: Date.now() };
  saveWS(ws);

  // Build system prompt
  const systemPrompt = buildSystemPrompt(ws);

  // First message from "user" to kick off the coaching plan
  const firstMsg = `Hi, I'm ${name}. I'm a ${skill} level surfer riding a ${board}, surfing ${freq}. The main thing I want to work on is: ${goal}`;

  messages = [];
  showChat(ws);
  await sendMessage(firstMsg, systemPrompt, true);
}

function buildSystemPrompt(ws){
  return `You are a knowledgeable and encouraging surf coach inside the Quiver surf app. You give personalised, practical coaching advice.

Surfer profile:
- Name: ${ws.name}
- Skill level: ${ws.skill}
- Board: ${ws.board}
- Surf frequency: ${ws.freq}
- Main goal: ${ws.goal}

Your coaching style:
- Be direct and specific — no fluff
- Give concrete drills and techniques the surfer can actually use
- Tailor advice to their board (longboard advice is very different from shortboard)
- Match the tone to their level — encouraging for beginners, technical for advanced/expert
- Keep responses focused — don't overload them with information at once
- Never tell them whether to go surfing or not — that's their call
- Use surf terminology naturally but explain it if they're a beginner
- You can ask follow-up questions to give better advice
- Format responses clearly — use short paragraphs, not walls of text
- If they ask about something outside surf coaching, gently redirect`;
}

// ── SHOW CHAT ──
function showChat(ws){
  document.getElementById('page').innerHTML = `
    <div class="chat-wrap">
      <div class="chat-header">
        <div class="chat-title">YOUR WORKSHOP</div>
        <div class="chat-sub">${ws.name} · ${ws.skill} · ${ws.board}</div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-wrap">
        <div class="chat-input-row">
          <input class="chat-input" id="chatInput" placeholder="Ask your coach anything..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendUserMessage();}"/>
          <button class="send-btn" id="sendBtn" onclick="sendUserMessage()">Send →</button>
        </div>
        <button class="reset-btn" onclick="resetWorkshop()">↺ Start a new session</button>
      </div>
    </div>
  `;
}

// ── SEND MESSAGE ──
async function sendUserMessage(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  const ws = getWS();
  await sendMessage(text, buildSystemPrompt(ws), false);
}

async function sendMessage(text, systemPrompt, isAuto){
  const messagesEl = document.getElementById('chatMessages');
  if(!messagesEl) return;

  // Add user message to history and UI (unless it's the auto first message)
  messages.push({ role:'user', content:text });
  if(!isAuto){
    messagesEl.innerHTML += `
      <div class="msg user">
        <div class="msg-label">You</div>
        <div class="msg-bubble">${text}</div>
      </div>`;
  }

  // Show typing indicator
  const typingId = 'typing-' + Date.now();
  messagesEl.innerHTML += `
    <div class="msg assistant" id="${typingId}">
      <div class="msg-label">Coach</div>
      <div class="typing"><span></span><span></span><span></span></div>
    </div>`;
  messagesEl.scrollTop = messagesEl.scrollHeight;

  // Disable input
  const sendBtn = document.getElementById('sendBtn');
  const chatInput = document.getElementById('chatInput');
  if(sendBtn) sendBtn.disabled = true;
  if(chatInput) chatInput.disabled = true;

  try{
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model: ANTHROPIC_MODEL,
        max_tokens: 1000,
        system: systemPrompt,
        messages: messages
      })
    });

    const data = await response.json();
    const reply = data.content?.find(b=>b.type==='text')?.text || "Sorry, I couldn't get a response. Try again.";

    // Add to history
    messages.push({ role:'assistant', content:reply });

    // Replace typing with response
    const typingEl = document.getElementById(typingId);
    if(typingEl){
      typingEl.innerHTML = `
        <div class="msg-label">Coach</div>
        <div class="msg-bubble">${reply.replace(/\n/g,'<br>')}</div>`;
    }
  } catch(e) {
    const typingEl = document.getElementById(typingId);
    if(typingEl) typingEl.innerHTML = `<div class="msg-label">Coach</div><div class="msg-bubble" style="color:var(--poor)">Couldn't connect. Check your connection and try again.</div>`;
  }

  // Re-enable
  if(sendBtn) sendBtn.disabled = false;
  if(chatInput){ chatInput.disabled = false; chatInput.focus(); }
  if(messagesEl) messagesEl.scrollTop = messagesEl.scrollHeight;
}

function resetWorkshop(){
  clearWS();
  messages = [];
  showOnboarding();
}

// ── INIT ──
const ws = getWS();
if(ws) { showChat(ws); } else { showOnboarding(); }
</script>

<nav class="bottom-nav">
  <a href="index.html" class="bottom-nav-item" id="bn-forecast">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h2M20 12h2M12 2v2M12 20v2"/><circle cx="12" cy="12" r="5"/><path d="M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
    <span>Forecast</span>
  </a>
  <a href="workshop.html" class="bottom-nav-item active" id="bn-workshop">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    <span>Workshop</span>
  </a>
  <a href="trip.html" class="bottom-nav-item" id="bn-trip">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>
    <span>Trip</span>
  </a>
</nav>
</body>
</html>
