<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiver — Spanish Point</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f0f; --surface:#1a1a1a; --surface2:#222;
  --white:#fff; --muted:rgba(255,255,255,0.35); --faint:rgba(255,255,255,0.1);
  --good:#22c55e; --fair:#f5c800; --poor:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--white);font-family:'Archivo Black',sans-serif;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.07;mix-blend-mode:overlay;}

/* MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:1000;display:flex;align-items:center;justify-content:center;padding:24px;}
.modal{background:var(--surface);max-width:480px;width:100%;padding:36px;border:1px solid rgba(255,255,255,0.1);}
.modal-title{font-size:22px;letter-spacing:-0.5px;margin-bottom:6px;}
.modal-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:32px;}
.field{margin-bottom:22px;}
.field-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:10px;display:block;}
.field select,.field input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.15);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:12px 14px;outline:none;appearance:none;transition:border-color 0.2s;}
.field select:focus,.field input:focus{border-color:rgba(255,255,255,0.4);}
.modal-btn{width:100%;background:var(--white);color:#0f0f0f;border:none;font-family:'Archivo Black',sans-serif;font-size:13px;letter-spacing:1px;padding:16px;cursor:pointer;transition:opacity 0.15s;}
.modal-btn:hover{opacity:0.9;}

/* HEADER */
header{padding:18px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--faint);}
.logo{font-size:18px;letter-spacing:2px;}
.logo-tag{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.profile-btn{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid rgba(255,255,255,0.15);padding:7px 14px;cursor:pointer;}
.profile-btn:hover{border-color:rgba(255,255,255,0.35);color:rgba(255,255,255,0.7);}

/* HERO */
.hero{padding:52px 28px 48px;text-align:center;border-bottom:1px solid var(--faint);}
.break-name{font-size:clamp(52px,13vw,120px);letter-spacing:-2px;line-height:0.9;}
.break-loc{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:14px;}
.main{max-width:900px;margin:0 auto;padding:36px 24px 80px;}

/* WINDOW ALERT */
.window-alert{border:1px solid rgba(255,255,255,0.12);padding:20px 24px;margin-bottom:28px;position:relative;overflow:hidden;}
.window-alert::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.window-alert.good-window::before{background:var(--good);}
.window-alert.fair-window::before{background:var(--fair);}
.window-alert.poor-window::before{background:var(--poor);}
.window-eyebrow{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.window-text{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:0.5px;color:rgba(255,255,255,0.85);line-height:1.7;font-style:italic;}

/* BADGE */
.badge-row{display:flex;align-items:flex-start;gap:20px;margin-bottom:24px;flex-wrap:wrap;}
.badge{display:inline-block;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;padding:7px 18px;border:1.5px solid;white-space:nowrap;}
.badge-epic,.badge-good{color:var(--good);border-color:var(--good);}
.badge-fair{color:var(--fair);border-color:var(--fair);}
.badge-poor{color:var(--poor);border-color:var(--poor);}
.badge-flat{color:var(--muted);border-color:var(--muted);}
.conditions-read{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.5px;color:rgba(255,255,255,0.65);line-height:1.7;padding:7px 0 7px 16px;border-left:2px solid rgba(255,255,255,0.15);font-style:italic;}

/* CURRENT CARD */
.current-card{background:var(--surface);padding:28px;margin-bottom:4px;}
.card-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:22px;}
.current-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;}
.current-grid-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:24px;padding-top:24px;border-top:1px solid var(--faint);}
.c-val{font-size:clamp(26px,4vw,42px);letter-spacing:-1px;line-height:1;}
.c-unit{font-size:0.42em;opacity:0.4;letter-spacing:0;}
.c-lbl{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.7);margin-top:7px;}
.dir-display{display:flex;align-items:center;gap:12px;}
.dir-arrow{width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,0.2);border-radius:50%;flex-shrink:0;}
.dir-arrow svg{width:18px;height:18px;}

/* SECONDARY SWELL */
.swell-secondary{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:14px 20px;margin-top:4px;display:flex;gap:24px;align-items:center;flex-wrap:wrap;}
.swell-sec-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:4px;}
.swell-sec-val{font-family:'Archivo Black',sans-serif;font-size:16px;letter-spacing:-0.5px;}
.swell-sec-item{min-width:80px;}

/* SECTION LABEL */
.sec-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.65);margin:28px 0 8px;display:flex;align-items:center;gap:10px;}
.sec-label::before{content:'';width:16px;height:1px;background:rgba(255,255,255,0.4);}

/* SWELL GRAPH */
.graph-wrap{background:var(--surface);padding:24px 20px 16px;margin-bottom:4px;overflow:hidden;}
.graph-canvas{width:100%;height:140px;display:block;}

/* 24HR TABLE */
.forecast-table{width:100%;border-collapse:collapse;}
.forecast-table th{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:8px 12px;text-align:left;border-bottom:1px solid var(--faint);}
.forecast-table th:not(:first-child){text-align:center;}
.forecast-row{border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s;border-left:3px solid transparent;}
.forecast-row:hover{background:var(--surface2);}
.forecast-row.good,.forecast-row.epic{border-left-color:var(--good);}
.forecast-row.fair{border-left-color:var(--fair);}
.forecast-row.poor{border-left-color:var(--poor);}
.forecast-row td{padding:12px 12px;vertical-align:middle;}
.row-time{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;color:rgba(255,255,255,0.5);white-space:nowrap;}
.row-height{font-size:19px;letter-spacing:-0.5px;text-align:center;}
.row-height.good,.row-height.epic{color:var(--good);}
.row-height.fair{color:var(--fair);}
.row-height.poor{color:var(--poor);}
.row-unit{font-size:10px;opacity:0.4;}
.row-dir,.row-wind{font-family:'DM Mono',monospace;font-size:10px;text-align:center;color:rgba(255,255,255,0.7);line-height:1.6;}
.row-period,.row-energy{font-family:'DM Mono',monospace;font-size:11px;text-align:center;color:rgba(255,255,255,0.6);}
.row-tag{display:inline-block;font-family:'DM Mono',monospace;font-size:7px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 6px;margin-top:2px;}
.row-tag.dawn{background:rgba(100,150,255,0.15);color:rgba(100,180,255,0.8);}
.row-tag.dusk{background:rgba(255,160,60,0.15);color:rgba(255,180,80,0.8);}
.row-tag.work{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.4);}

/* TIDES */
.tide-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:3px;}
.tide-card{background:var(--surface);padding:16px 18px;display:flex;align-items:center;gap:14px;}
.tide-icon{font-size:20px;flex-shrink:0;}
.tide-type{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.tide-time{font-size:20px;letter-spacing:-0.5px;}
.tide-ht{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:2px;}

/* 7 DAY */
.seven-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:3px;}
.day-card{background:var(--surface);padding:16px 14px;text-align:center;border-top:2px solid transparent;}
.day-card.epic,.day-card.good{border-top-color:var(--good);}
.day-card.fair{border-top-color:var(--fair);}
.day-card.poor{border-top-color:var(--poor);}
.day-name{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:8px;}
.day-height{font-size:24px;letter-spacing:-1px;}
.day-card.epic .day-height,.day-card.good .day-height{color:var(--good);}
.day-card.fair .day-height{color:var(--fair);}
.day-card.poor .day-height{color:var(--poor);}
.day-detail{font-family:'DM Mono',monospace;font-size:8px;color:rgba(255,255,255,0.5);margin-top:5px;line-height:1.7;text-transform:uppercase;}

.status{text-align:center;padding:80px 24px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.status.error{color:var(--poor);}

@media(max-width:640px){
  .current-grid,.current-grid-bottom{grid-template-columns:repeat(2,1fr);}
  header{padding:14px 18px;} .hero{padding:36px 18px 36px;}
  .main{padding:24px 16px 60px;} .current-card{padding:20px;}
  .badge-row{flex-direction:column;gap:12px;}
  .forecast-table th:nth-child(6),.forecast-table td:nth-child(6){display:none;}
}
</style>
</head>
<body>

<div class="modal-backdrop" id="modal">
  <div class="modal">
    <div class="modal-title">Set Up Your Profile</div>
    <div class="modal-sub">Takes 30 seconds · helps us read the forecast for you</div>
    <div class="field"><label class="field-label">Your Name</label><input type="text" id="p-name" placeholder="e.g. Conor"/></div>
    <div class="field">
      <label class="field-label">Skill Level</label>
      <select id="p-skill">
        <option value="beginner">Beginner — still learning to stand up</option>
        <option value="intermediate">Intermediate — comfortable on green waves</option>
        <option value="advanced" selected>Advanced — surfing most conditions</option>
        <option value="expert">Expert — I'm a hell man and will charge anything</option>
      </select>
    </div>
    <div class="field">
      <label class="field-label">Work Schedule</label>
      <select id="p-work">
        <option value="9to5" selected>9–5 weekdays (weekends free)</option>
        <option value="flexible">Flexible / remote</option>
        <option value="shift">Shift work — varies</option>
        <option value="retired">Retired / student</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveProfile()">Save &amp; Load Forecast →</button>
  </div>
</div>

<header>
  <div><div class="logo">QUIVER</div><div class="logo-tag">Surf Guide</div></div>
  <button class="profile-btn" onclick="document.getElementById('modal').style.display='flex'">Edit Profile</button>
</header>

<div class="hero">
  <div class="break-name">SPANISH<br>POINT</div>
  <div class="break-loc">Co. Clare · Ireland · 52.8441° N, 9.4747° W</div>
</div>

<main class="main">
  <div id="app"><div class="status">Loading forecast...</div></div>
</main>

<script>
const LAT=52.8441, LNG=-9.4747, BEACH_FACING=285;

function getProfile(){try{return JSON.parse(localStorage.getItem('quiver_profile'));}catch(e){return null;}}
function saveProfile(){
  const name=document.getElementById('p-name').value.trim()||'Surfer';
  const skill=document.getElementById('p-skill').value;
  const work=document.getElementById('p-work').value;
  localStorage.setItem('quiver_profile',JSON.stringify({name,skill,work}));
  document.getElementById('modal').style.display='none';
  load();
}
if(getProfile()) document.getElementById('modal').style.display='none';

function windDir(d){return['N','NE','E','SE','S','SW','W','NW'][Math.round(d/45)%8];}
function arrowChar(d){return['↑','↗','→','↘','↓','↙','←','↖'][Math.round(d/45)%8];}
function dirArrowSVG(deg,color){
  return `<div class="dir-arrow"><svg viewBox="0 0 24 24" style="transform:rotate(${deg}deg)" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="6 11 12 5 18 11"/></svg></div>`;
}
function waveEnergy(h,t){return Math.round(0.5*h*h*t);}

function isOnshore(wd){const d=((wd-BEACH_FACING)+360)%360;return d<=90||d>=270;}
function isOffshore(wd){const d=((wd-BEACH_FACING)+360)%360;return d>90&&d<270;}

// Skill thresholds — affects colour coding
function skillThresholds(skill){
  return {
    beginner:   {minH:0.3, maxH:1.0, minP:5,  col:'good'},
    intermediate:{minH:0.5, maxH:1.8, minP:7,  col:'good'},
    advanced:   {minH:0.8, maxH:3.5, minP:9,  col:'good'},
    expert:     {minH:1.2, maxH:99,  minP:10, col:'good'},
  }[skill] || {minH:0.5,maxH:99,minP:7};
}

function rate(h,w,p,skill){
  const t=skillThresholds(skill||'advanced');
  if(h<0.3) return 'flat';
  const sizeOk=h>=t.minH&&h<=t.maxH;
  const periodOk=p>=t.minP;
  if(sizeOk&&periodOk&&w<5)  return 'epic';
  if(sizeOk&&periodOk&&w<10) return 'good';
  if(sizeOk&&w<15)            return 'fair';
  if(!sizeOk||w>=15)          return 'poor';
  return 'fair';
}
function rateLabel(r){return{epic:'Epic',good:'Good conditions',fair:'Fair conditions',poor:'Poor conditions',flat:'Flat'}[r];}

function conditionsRead(h,ws,wd,swP,swD,wD){
  const wDir=windDir(wd);
  const parts=[];
  if(h<0.3) return "Waves too small to surf.";
  const ft=(h*3.281).toFixed(0);
  if(h>=2.5) parts.push(`solid ${ft}ft of swell in the water`);
  else if(h>=1.2) parts.push(`${ft}ft of swell running`);
  else parts.push(`small ${ft}ft waves`);
  if(swP>=14) parts.push("very long period — likely to have good shape");
  else if(swP>=10) parts.push("decent period on the swell");
  else if(swP<7) parts.push("short period — likely to be choppy");
  if(ws<5) parts.push("virtually no wind");
  else if(isOffshore(wd)&&ws<15) parts.push(`${wDir} offshore wind — could clean up the faces`);
  else if(isOffshore(wd)&&ws>=15) parts.push(`strong ${wDir} offshore — may be blown out`);
  else if(isOnshore(wd)&&ws>=15) parts.push(`strong ${wDir} onshore — likely messy`);
  else if(isOnshore(wd)&&ws>=8) parts.push(`${wDir} onshore — expect some chop on the face`);
  else if(isOnshore(wd)) parts.push(`light ${wDir} onshore`);
  else parts.push(`${wDir} sideshore at ${ws.toFixed(0)}kn`);
  return parts.join(". ")+".";
}

function getSunTimes(lat,lng,date){
  const rad=Math.PI/180;
  const dayOfYear=Math.floor((date-new Date(date.getFullYear(),0,0))/86400000);
  const B=(360/365)*(dayOfYear-81)*rad;
  const eqTime=9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B);
  const decl=23.45*Math.sin(B)*rad;
  const HA=Math.acos(-Math.tan(lat*rad)*Math.tan(decl))/rad;
  const noon=12-(lng/15)-(eqTime/60);
  const sunrise=noon-HA/15, sunset=noon+HA/15;
  const isDST=date.getMonth()>=2&&date.getMonth()<=9;
  const offset=isDST?1:0;
  const toHHMM=h=>{const hh=Math.floor(h+offset)%24,mm=Math.round((h+offset-Math.floor(h+offset))*60);return`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;};
  return{sunrise:sunrise+offset,sunset:sunset+offset,sunriseStr:toHHMM(sunrise),sunsetStr:toHHMM(sunset)};
}

function buildWindowAlert(slots,profile,sun){
  if(!profile) return '';
  const{name,skill,work}=profile;
  const t=skillThresholds(skill);
  const now=new Date();
  const isFlexible=work==='flexible'||work==='retired';
  const scored=slots.map(s=>{
    const slotDate=new Date(s.time);
    const hour=slotDate.getHours();
    const dow=slotDate.getDay();
    const isAvail=isFlexible||[0,6].includes(dow)||hour<8||hour>18;
    const r=rate(s.h,s.ws,s.p,skill);
    const offshore=isOffshore(s.wd);
    const goodWind=offshore||s.ws<8;
    const goodSize=s.h>=t.minH&&s.h<=t.maxH;
    const goodPeriod=s.p>=t.minP;
    const daylight=hour>=Math.floor(sun.sunrise)&&hour<=Math.floor(sun.sunset);
    let score=0;
    if(goodSize) score+=3; if(goodPeriod) score+=2; if(goodWind) score+=2;
    if(offshore) score+=1; if(isAvail) score+=2; if(daylight) score+=1;
    return{...s,score,isAvail,r,goodWind,goodSize,goodPeriod,daylight,slotDate,hour,dow};
  });
  const best=scored.filter(s=>s.score>=5&&s.goodSize).sort((a,b)=>b.score-a.score)[0];
  if(!best){
    const next=scored.filter(s=>s.goodSize).sort((a,b)=>b.score-a.score)[0];
    if(!next) return `<div class="window-alert poor-window"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">Nothing great in the next 24 hours. Check back as conditions develop.</div></div>`;
    const dn=best?.slotDate.toDateString()===now.toDateString()?'today':best?.slotDate.toLocaleDateString('en-IE',{weekday:'long'});
    return `<div class="window-alert fair-window"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">Best of a quieter spell around ${fmtT(next.time)}. ${next.h.toFixed(1)}m, ${next.p.toFixed(0)}s — one to keep an eye on.</div></div>`;
  }
  const dn=best.slotDate.toDateString()===now.toDateString()?'today':best.slotDate.toLocaleDateString('en-IE',{weekday:'long'});
  const unavNote=!best.isAvail&&work==='9to5'?' — falls during work hours':'';
  const windNote=isOffshore(best.wd)?`${windDir(best.wd)} offshore wind`:`light ${windDir(best.wd)} wind`;
  const qw=best.r==='epic'?'an epic':best.r==='good'?'a good':'a fair';
  let msg=`Looks like ${qw} window around ${fmtT(best.time)} ${dn}${unavNote}. `;
  msg+=`${best.h.toFixed(1)}m at ${best.p.toFixed(0)}s with ${windNote}.`;
  if(skill==='beginner'&&best.h<1.0) msg+=` A manageable size for developing surfers.`;
  else if(skill==='beginner'&&best.h>=1.0) msg+=` Slightly bigger than ideal for beginners — one to watch.`;
  else if(skill==='expert'&&best.h>=2.0) msg+=` Sizeable swell on the way.`;
  else if(skill==='expert'&&best.h<1.0) msg+=` On the smaller side for the time being.`;
  else if(skill==='advanced'&&best.h<0.9) msg+=` A quieter spell — smaller than ideal.`;
  const ac=best.r==='good'||best.r==='epic'?'good-window':'fair-window';
  return `<div class="window-alert ${ac}"><div class="window-eyebrow">Surf Window · ${name}</div><div class="window-text">${msg}</div></div>`;
}

function fmtT(iso){return new Date(iso).toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit',hour12:false});}
function fmtDay(iso){
  const d=new Date(iso),t=new Date(),tm=new Date();tm.setDate(tm.getDate()+1);
  if(d.toDateString()===t.toDateString()) return 'Today';
  if(d.toDateString()===tm.toDateString()) return 'Tmrw';
  return d.toLocaleDateString('en-IE',{weekday:'short'});
}

// Extract tide highs/lows from sea level height array
function extractTides(times, levels){
  const tides=[];
  for(let i=1;i<levels.length-1;i++){
    if(levels[i]==null) continue;
    const isHigh=levels[i]>levels[i-1]&&levels[i]>levels[i+1];
    const isLow=levels[i]<levels[i-1]&&levels[i]<levels[i+1];
    if(isHigh||isLow){
      const d=new Date(times[i]);
      const today=new Date();
      if(d.toDateString()===today.toDateString()||
        (d>today&&tides.length<6)){
        tides.push({type:isHigh?'high':'low',time:times[i],height:levels[i]});
      }
    }
    if(tides.length>=6) break;
  }
  return tides;
}

// Draw swell arrival graph on canvas
function drawGraph(canvas, times, heights, periods, skill){
  const ctx=canvas.getContext('2d');
  const W=canvas.width=canvas.offsetWidth*window.devicePixelRatio||canvas.offsetWidth;
  const H=canvas.height=140*window.devicePixelRatio||140;
  canvas.style.height='140px';
  ctx.scale(window.devicePixelRatio||1,window.devicePixelRatio||1);
  const w=canvas.offsetWidth, h=140;
  ctx.clearRect(0,0,w,h);
  const t=skillThresholds(skill||'advanced');
  const maxH=Math.max(...heights.filter(Boolean),2)*1.15;
  const pad={l:36,r:12,t:16,b:28};
  const gw=w-pad.l-pad.r, gh=h-pad.t-pad.b;
  const toX=i=>(i/(heights.length-1))*gw+pad.l;
  const toY=v=>gh-(v/maxH)*gh+pad.t;

  // Good zone band
  const goodY1=toY(Math.min(t.maxH,maxH));
  const goodY2=toY(t.minH);
  ctx.fillStyle='rgba(34,197,94,0.06)';
  ctx.fillRect(pad.l,goodY1,gw,goodY2-goodY1);

  // Grid lines
  ctx.strokeStyle='rgba(255,255,255,0.06)';
  ctx.lineWidth=1;
  for(let v=0.5;v<=maxH;v+=0.5){
    const y=toY(v);
    if(y<pad.t||y>h-pad.b) continue;
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(w-pad.r,y);ctx.stroke();
    if(v%1===0){
      ctx.fillStyle='rgba(255,255,255,0.25)';
      ctx.font=`${10*1}px "DM Mono", monospace`;
      ctx.fillText(v+'m',2,y+4);
    }
  }

  // Day separators + labels
  let lastDay='';
  times.forEach((t,i)=>{
    const d=new Date(t);
    const dayStr=d.toLocaleDateString('en-IE',{weekday:'short'});
    if(dayStr!==lastDay){
      const x=toX(i);
      ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,h-pad.b);ctx.stroke();
      ctx.fillStyle='rgba(255,255,255,0.3)';
      ctx.font=`${9}px "DM Mono", monospace`;
      ctx.fillText(dayStr,x+3,h-pad.b+14);
      lastDay=dayStr;
    }
  });

  // Fill under curve
  ctx.beginPath();
  heights.forEach((v,i)=>{if(v==null)return;const x=toX(i),y=toY(v);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.lineTo(toX(heights.length-1),h-pad.b);
  ctx.lineTo(pad.l,h-pad.b);ctx.closePath();
  const grad=ctx.createLinearGradient(0,pad.t,0,h-pad.b);
  grad.addColorStop(0,'rgba(255,255,255,0.12)');
  grad.addColorStop(1,'rgba(255,255,255,0.01)');
  ctx.fillStyle=grad;ctx.fill();

  // Line — colour segments by rating
  for(let i=1;i<heights.length;i++){
    if(heights[i]==null||heights[i-1]==null) continue;
    const r=rate(heights[i],10,periods[i]||8,skill);
    ctx.strokeStyle=r==='good'||r==='epic'?'rgba(34,197,94,0.9)':r==='fair'?'rgba(245,200,0,0.9)':'rgba(239,68,68,0.7)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(toX(i-1),toY(heights[i-1]));
    ctx.lineTo(toX(i),toY(heights[i]));
    ctx.stroke();
  }

  // Now marker
  const now=new Date();
  const nowIdx=times.findIndex(t=>new Date(t)>=now);
  if(nowIdx>0){
    const x=toX(nowIdx);
    ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,h-pad.b);ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font=`8px "DM Mono",monospace`;
    ctx.fillText('now',x+3,pad.t+10);
  }
}

async function load(){
  const app=document.getElementById('app');
  const profile=getProfile();
  if(!profile) return;
  const skill=profile.skill||'advanced';

  try{
    const[mr,wr,tideR]=await Promise.all([
      fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${LAT}&longitude=${LNG}`
        +`&hourly=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period,secondary_swell_wave_height,secondary_swell_wave_direction,secondary_swell_wave_period,sea_surface_temperature,sea_level_height`
        +`&daily=wave_height_max,wave_period_max,wave_direction_dominant,swell_wave_height_max`
        +`&wind_speed_unit=kn&timezone=Europe%2FDublin&forecast_days=7`),
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LNG}`
        +`&hourly=wind_speed_10m,wind_direction_10m`
        +`&wind_speed_unit=kn&timezone=Europe%2FDublin&forecast_days=7`),
      // INTGN Galway Port — nearest tide gauge, real observed levels
      fetch(`https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.json?time,Water_Level_LAT&time>=${new Date(Date.now()-3600000*2).toISOString().slice(0,19)}Z&time<=${new Date(Date.now()+86400000*2).toISOString().slice(0,19)}Z&station_id=%22Galway%20Port%22&orderBy(%22time%22)`)
        .catch(()=>null)
    ]);

    if(!mr.ok) throw new Error('Marine API '+mr.status);
    if(!wr.ok) throw new Error('Wind API '+wr.status);

    const m=await mr.json(), w=await wr.json();
    const times=m.hourly.time;
    const wH=m.hourly.wave_height, wDir=m.hourly.wave_direction, wP=m.hourly.wave_period;
    const swH=m.hourly.swell_wave_height, swD=m.hourly.swell_wave_direction, swP=m.hourly.swell_wave_period;
    const sw2H=m.hourly.secondary_swell_wave_height, sw2D=m.hourly.secondary_swell_wave_direction, sw2P=m.hourly.secondary_swell_wave_period;
    const sst=m.hourly.sea_surface_temperature;
    const seaLevel=m.hourly.sea_level_height;
    const wndS=w.hourly.wind_speed_10m, wndD=w.hourly.wind_direction_10m;
    const daily=m.daily;

    const now=new Date();
    const ns=now.toISOString().slice(0,13);
    let ci=times.findIndex(t=>t.startsWith(ns));if(ci<0)ci=0;

    const cH=wH[ci]??0,cD=wDir[ci]??0,cP=wP[ci]??0;
    const cSwD=swD[ci]??cD,cSwP=swP[ci]??cP;
    const cSw2H=sw2H[ci]??0,cSw2D=sw2D[ci]??0,cSw2P=sw2P[ci]??0;
    const cSST=sst[ci]??null;
    const cWS=wndS[ci]??0,cWD=wndD[ci]??0;
    const r=rate(cH,cWS,cP,skill);
    const energy=waveEnergy(cH,cP);
    const read=conditionsRead(cH,cWS,cWD,cSwP,cSwD,cD);
    const rColor=r==='good'||r==='epic'?'var(--good)':r==='fair'?'var(--fair)':r==='poor'?'var(--poor)':'var(--muted)';

    const sun=getSunTimes(LAT,LNG,now);

    // Slots 24hr
    const slots=[];
    for(let i=ci;i<ci+24&&i<times.length;i+=3){
      slots.push({time:times[i],h:wH[i]??0,p:wP[i]??0,waveDir:wDir[i]??0,swDir:swD[i]??null,swP:swP[i]??0,ws:wndS[i]??0,wd:wndD[i]??0});
    }

    // Tides — try INTGN first, fall back to Open-Meteo sea level
    let tides=[];
    if(tideR&&tideR.ok){
      try{
        const tj=await tideR.json();
        const rows=tj.table?.rows||[];
        const tideTimes=rows.map(r=>r[0]);
        const tideLevels=rows.map(r=>r[1]);
        tides=extractTides(tideTimes,tideLevels);
      }catch(e){}
    }
    if(tides.length===0&&seaLevel){
      tides=extractTides(times,seaLevel);
    }

    // 7 day
    const days=daily.time.map((t,i)=>({time:t,h:daily.wave_height_max[i]??0,p:daily.wave_period_max[i]??0,dir:daily.wave_direction_dominant[i]??0}));

    // Window alert
    const windowHTML=buildWindowAlert(slots,profile,sun);

    app.innerHTML=`
      ${windowHTML}

      <div class="badge-row">
        <span class="badge badge-${r}">${rateLabel(r)}</span>
        <div class="conditions-read">${read}</div>
      </div>

      <div class="current-card">
        <div class="card-label">Now · ${now.toLocaleDateString('en-IE',{weekday:'long'})} ${fmtT(now.toISOString())}</div>
        <div class="current-grid">
          <div><div class="c-val">${cH.toFixed(1)}<span class="c-unit">m</span></div><div class="c-lbl">Wave Height</div></div>
          <div><div class="c-val">${cP.toFixed(0)}<span class="c-unit">s</span></div><div class="c-lbl">Period</div></div>
          <div><div class="c-val">${(cH*3.281).toFixed(1)}<span class="c-unit">ft</span></div><div class="c-lbl">In Feet</div></div>
        </div>
        <div class="current-grid-bottom">
          <div>
            <div class="dir-display">
              ${dirArrowSVG(cSwD,'var(--fair)')}
              <div><div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">${windDir(cSwD)}</div><div class="c-lbl">Swell Dir</div></div>
            </div>
          </div>
          <div>
            <div class="dir-display">
              ${dirArrowSVG(cWD,'rgba(255,255,255,0.6)')}
              <div><div class="c-val" style="font-size:clamp(16px,2.5vw,22px)">${cWS.toFixed(0)}<span class="c-unit">kn</span> ${windDir(cWD)}</div><div class="c-lbl">Wind</div></div>
            </div>
          </div>
          <div>
            <div class="c-val" style="color:${rColor}">${energy}<span class="c-unit">kJ/m</span></div>
            <div class="c-lbl">Wave Energy</div>
            ${cSST!==null?`<div style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(255,255,255,0.45);margin-top:8px;">${cSST.toFixed(1)}°C water</div>`:''}
          </div>
        </div>
      </div>

      ${cSw2H>0.2?`
      <div class="swell-secondary">
        <div style="font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-right:8px;">Secondary Swell</div>
        <div class="swell-sec-item"><div class="swell-sec-label">Height</div><div class="swell-sec-val">${cSw2H.toFixed(1)}<span style="font-size:11px;opacity:0.4">m</span></div></div>
        <div class="swell-sec-item"><div class="swell-sec-label">Period</div><div class="swell-sec-val">${cSw2P.toFixed(0)}<span style="font-size:11px;opacity:0.4">s</span></div></div>
        <div class="swell-sec-item"><div class="swell-sec-label">Direction</div><div class="swell-sec-val">${arrowChar(cSw2D)} ${windDir(cSw2D)}</div></div>
      </div>`:``}

      <div class="sec-label">7 Day Swell Arrival</div>
      <div class="graph-wrap"><canvas class="graph-canvas" id="swellGraph"></canvas></div>

      <div class="sec-label">Next 24 Hours</div>
      <table class="forecast-table">
        <thead><tr>
          <th>Time</th><th>Height</th><th>Swell</th><th>Wind</th><th>Period</th><th>Energy</th>
        </tr></thead>
        <tbody>
          ${slots.map(s=>{
            const sr=rate(s.h,s.ws,s.p,skill);
            const dir=s.swDir??s.waveDir;
            const slotH=new Date(s.time).getHours();
            const isDawn=Math.abs(slotH-Math.floor(sun.sunrise))<=1;
            const isDusk=Math.abs(slotH-Math.floor(sun.sunset))<=1;
            const isWork=profile.work==='9to5'&&![0,6].includes(new Date(s.time).getDay())&&slotH>=9&&slotH<=17;
            const en=waveEnergy(s.h,s.p);
            const tag=isDawn?'<span class="row-tag dawn">First Light</span>':isDusk?'<span class="row-tag dusk">Last Light</span>':isWork?'<span class="row-tag work">Work hours</span>':'';
            return`<tr class="forecast-row ${sr}">
              <td><div class="row-time">${fmtT(s.time)}${tag?'<br>'+tag:''}</div></td>
              <td><div class="row-height ${sr}">${s.h.toFixed(1)}<span class="row-unit">m</span></div></td>
              <td><div class="row-dir">${arrowChar(dir)} ${windDir(dir)}<br><span style="font-size:9px;opacity:0.5">${(s.swP||s.p).toFixed(0)}s</span></div></td>
              <td><div class="row-wind">${arrowChar(s.wd)} ${windDir(s.wd)}<br><span style="font-size:9px;opacity:0.5">${s.ws.toFixed(0)}kn</span></div></td>
              <td><div class="row-period">${s.p.toFixed(0)}s</div></td>
              <td><div class="row-energy">${en}</div></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>

      ${tides.length>0?`
      <div class="sec-label">Tides · Today</div>
      <div class="tide-grid">
        ${tides.map(t=>`
          <div class="tide-card">
            <div class="tide-icon">${t.type==='high'?'↑':'↓'}</div>
            <div>
              <div class="tide-type">${t.type==='high'?'High':'Low'} Tide</div>
              <div class="tide-time">${fmtT(t.time)}</div>
              <div class="tide-ht">${t.height!=null?t.height.toFixed(2)+'m':''}</div>
            </div>
          </div>`).join('')}
      </div>`:''}

      <div class="sec-label">First &amp; Last Light</div>
      <div class="tide-grid">
        <div class="tide-card">
          <div class="tide-icon" style="color:rgba(100,180,255,0.8)">☀</div>
          <div><div class="tide-type">First Light</div><div class="tide-time">${sun.sunriseStr}</div><div class="tide-ht">Sunrise</div></div>
        </div>
        <div class="tide-card">
          <div class="tide-icon" style="color:rgba(255,160,60,0.8)">☀</div>
          <div><div class="tide-type">Last Light</div><div class="tide-time">${sun.sunsetStr}</div><div class="tide-ht">Sunset</div></div>
        </div>
      </div>

      <div class="sec-label">7 Day Outlook</div>
      <div class="seven-grid">
        ${days.map(d=>{const dr=rate(d.h,10,d.p,skill);return`
          <div class="day-card ${dr}">
            <div class="day-name">${fmtDay(d.time)}</div>
            <div class="day-height">${d.h.toFixed(1)}<span style="font-size:11px;opacity:0.4;letter-spacing:0">m</span></div>
            <div class="day-detail">${arrowChar(d.dir)} ${windDir(d.dir)}<br>${d.p.toFixed(0)}s period</div>
          </div>`;}).join('')}
      </div>
    `;

    // Draw graph after DOM rendered
    requestAnimationFrame(()=>{
      const canvas=document.getElementById('swellGraph');
      if(canvas) drawGraph(canvas,times,wH,wP,skill);
    });

  }catch(e){
    app.innerHTML=`<div class="status error">Couldn't load — ${e.message}</div>`;
  }
}

load();
</script>
</body>
</html>
