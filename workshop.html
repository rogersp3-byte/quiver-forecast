<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiver — Workshop</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0a;--surface:#141414;--white:#fff;
  --muted:rgba(255,255,255,0.38);--faint:rgba(255,255,255,0.08);
  --accent:#f5c800;--accent-dim:rgba(245,200,0,0.1);--accent-border:rgba(245,200,0,0.22);
  --good:#22c55e;--poor:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{
  font-family:'Archivo Black',sans-serif;color:var(--white);
  background:var(--bg);overflow-x:hidden;min-height:100vh;
}

/* grain overlay */
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.055;mix-blend-mode:overlay;
}

/* ── HEADER ── */
header{
  position:relative;z-index:10;padding:18px 28px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--faint);
}
.logo{font-size:18px;letter-spacing:2px;}
.logo-tag{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.main-nav{display:flex;gap:0;border:1px solid rgba(255,255,255,0.12);flex:1;margin:0 32px;}
.nav-link{flex:1;text-align:center;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:11px 20px;color:var(--muted);text-decoration:none;border-right:1px solid rgba(255,255,255,0.12);transition:all 0.15s;}
.nav-link:last-child{border-right:none;}
.nav-link:hover{color:var(--white);background:rgba(255,255,255,0.05);}
.nav-link.active{color:var(--white);background:rgba(255,255,255,0.07);}
.profile-btn{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid rgba(255,255,255,0.15);padding:7px 14px;cursor:pointer;transition:all 0.15s;}
.profile-btn:hover{border-color:rgba(255,255,255,0.35);color:rgba(255,255,255,0.7);}

/* ── MODAL ── */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:1000;display:none;align-items:center;justify-content:center;padding:24px;}
.modal-backdrop.show{display:flex;}
.modal{background:#1a1a1a;max-width:480px;width:100%;padding:36px;border:1px solid rgba(255,255,255,0.1);}
.modal-title{font-size:22px;letter-spacing:-0.5px;margin-bottom:6px;}
.modal-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:32px;}
.field{margin-bottom:22px;}
.field-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:10px;display:block;}
.field select,.field input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.15);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:12px 14px;outline:none;appearance:none;}
.modal-btn{width:100%;background:var(--white);color:#0f0f0f;border:none;font-family:'Archivo Black',sans-serif;font-size:13px;letter-spacing:1px;padding:16px;cursor:pointer;}

/* ── PAGE WRAPPER ── */
.page{position:relative;z-index:5;min-height:calc(100vh - 65px);display:flex;flex-direction:column;}

/* ═══════════════════════════════
   LANDING — CORE LORD INTRO
═══════════════════════════════ */
.landing{
  flex:1;display:flex;flex-direction:column;
  max-width:640px;width:100%;margin:0 auto;
  padding:clamp(32px,5vh,60px) 28px 60px;
}

/* Hero block */
.cl-hero{
  display:flex;align-items:flex-start;gap:24px;
  margin-bottom:36px;
}

/* Avatar */
.cl-avatar-wrap{position:relative;flex-shrink:0;}
.cl-avatar{
  width:88px;height:88px;border-radius:50%;
  background:radial-gradient(circle at 38% 32%, #221c00, #080600);
  border:1.5px solid rgba(245,200,0,0.35);
  display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
  box-shadow:0 0 0 6px rgba(245,200,0,0.06), 0 0 32px rgba(245,200,0,0.1);
}
.cl-avatar::after{
  content:'';position:absolute;inset:0;border-radius:50%;
  background:linear-gradient(180deg,transparent 0%,rgba(245,200,0,0.06) 50%,transparent 100%);
  animation:scan 3s ease-in-out infinite;
}
@keyframes scan{
  0%{transform:translateY(-100%);}
  100%{transform:translateY(100%);}
}
.cl-avatar-pulse{
  position:absolute;inset:-10px;border-radius:50%;
  border:1px solid rgba(245,200,0,0.18);
  animation:cl-pulse 3.5s ease-in-out infinite;
}
.cl-avatar-pulse2{
  position:absolute;inset:-20px;border-radius:50%;
  border:1px solid rgba(245,200,0,0.08);
  animation:cl-pulse 3.5s ease-in-out infinite 0.7s;
}
@keyframes cl-pulse{
  0%,100%{opacity:0.5;transform:scale(1);}
  50%{opacity:1;transform:scale(1.05);}
}
.cl-status{
  position:absolute;bottom:4px;right:4px;
  width:12px;height:12px;border-radius:50%;
  background:var(--good);border:2px solid var(--bg);
  animation:status-blink 2.5s ease-in-out infinite;
}
@keyframes status-blink{
  0%,100%{opacity:1;}50%{opacity:0.4;}
}

/* Hero text */
.cl-intro{}
.cl-eyebrow{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:4px;
  text-transform:uppercase;color:rgba(245,200,0,0.55);
  margin-bottom:6px;
}
.cl-name{
  font-size:clamp(36px,8vw,58px);letter-spacing:-2px;line-height:0.9;
  margin-bottom:10px;
}
.cl-name em{color:var(--accent);font-style:normal;}
.cl-bio{
  font-family:'DM Mono',monospace;font-size:11px;line-height:1.7;
  color:rgba(255,255,255,0.6);max-width:360px;
}

/* Pitch tags */
.cl-tags{
  display:flex;flex-wrap:wrap;gap:7px;
  margin-bottom:32px;
}
.cl-tag{
  font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;
  text-transform:uppercase;padding:8px 13px;
  background:transparent;border:1px solid rgba(255,255,255,0.1);
  color:rgba(255,255,255,0.45);
  transition:all 0.2s;cursor:default;
}
.cl-tag:hover{
  background:var(--accent-dim);border-color:var(--accent-border);
  color:rgba(255,255,255,0.8);
}
.cl-tag-accent{
  border-color:var(--accent-border);
  color:rgba(245,200,0,0.7);background:var(--accent-dim);
}

/* Divider */
.cl-divider{
  width:100%;height:1px;background:rgba(255,255,255,0.07);
  margin-bottom:28px;position:relative;
}
.cl-divider::before{
  content:'Your details';
  position:absolute;left:0;top:50%;transform:translateY(-50%);
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;
  text-transform:uppercase;color:var(--muted);
  background:var(--bg);padding-right:14px;
}

/* Form fields */
.q-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
@media(max-width:480px){.q-grid{grid-template-columns:1fr;}}
.q-field{margin-bottom:14px;}
.q-label{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2.5px;
  text-transform:uppercase;color:rgba(255,255,255,0.4);
  margin-bottom:8px;display:block;
}
.q-input,.q-select,.q-textarea{
  width:100%;background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--white);font-family:'DM Mono',monospace;
  font-size:12px;padding:12px 15px;outline:none;appearance:none;
  transition:border-color 0.2s, background 0.2s;
}
.q-input:focus,.q-select:focus,.q-textarea:focus{
  border-color:rgba(245,200,0,0.35);
  background:rgba(245,200,0,0.03);
}
.q-input::placeholder,.q-textarea::placeholder{color:rgba(255,255,255,0.18);}
.q-textarea{resize:none;height:80px;line-height:1.65;}

.cl-cta{
  width:100%;background:var(--accent);color:#0a0a0a;border:none;
  font-family:'Archivo Black',sans-serif;font-size:13px;
  letter-spacing:1.5px;text-transform:uppercase;
  padding:19px;cursor:pointer;margin-top:6px;
  transition:opacity 0.15s;position:relative;overflow:hidden;
}
.cl-cta::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);
  transform:translateX(-100%);transition:transform 0.45s;
}
.cl-cta:hover{opacity:0.9;}
.cl-cta:hover::before{transform:translateX(100%);}

/* ═══════════════════════════════
   CHAT
═══════════════════════════════ */
.chat-wrap{
  flex:1;display:flex;flex-direction:column;
  max-width:720px;width:100%;margin:0 auto;
  padding:22px 28px 0;
}

/* Chat header */
.chat-hdr{
  display:flex;align-items:center;gap:14px;
  padding-bottom:18px;
  border-bottom:1px solid var(--faint);
  margin-bottom:18px;
}
.chat-hdr-avatar{
  width:42px;height:42px;border-radius:50%;flex-shrink:0;
  background:radial-gradient(circle at 38% 32%,#1e1800,#080600);
  border:1.5px solid rgba(245,200,0,0.35);
  display:flex;align-items:center;justify-content:center;
  font-size:19px;
  box-shadow:0 0 14px rgba(245,200,0,0.1);
}
.chat-hdr-info{flex:1;}
.chat-hdr-name{font-size:17px;letter-spacing:-0.3px;}
.chat-hdr-sub{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;
  text-transform:uppercase;color:var(--muted);margin-top:2px;
}
.chat-hdr-live{
  display:flex;align-items:center;gap:6px;
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;
  text-transform:uppercase;color:var(--good);
}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--good);animation:status-blink 2.5s ease-in-out infinite;}
.new-sesh-btn{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;
  text-transform:uppercase;color:var(--muted);background:none;
  border:1px solid rgba(255,255,255,0.1);padding:7px 11px;cursor:pointer;
  transition:all 0.15s;
}
.new-sesh-btn:hover{border-color:rgba(255,255,255,0.28);color:rgba(255,255,255,0.65);}

/* Messages */
.chat-msgs{
  flex:1;overflow-y:auto;padding-bottom:12px;
  display:flex;flex-direction:column;gap:14px;
  max-height:calc(100vh - 310px);
}
.chat-msgs::-webkit-scrollbar{width:2px;}
.chat-msgs::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);}
.chat-msgs::-webkit-scrollbar-track{background:transparent;}

.msg{max-width:84%;}
.msg.user{align-self:flex-end;}
.msg.assistant{align-self:flex-start;}

.msg-lbl{
  font-family:'DM Mono',monospace;font-size:7px;letter-spacing:2px;
  text-transform:uppercase;color:var(--muted);
  margin-bottom:5px;display:flex;align-items:center;gap:5px;
}
.msg.user .msg-lbl{flex-direction:row-reverse;}
.lbl-pip{width:5px;height:5px;border-radius:50%;background:var(--accent);display:inline-block;}

.msg-bub{
  padding:13px 17px;
  font-family:'DM Mono',monospace;font-size:12px;line-height:1.78;
}
.msg.user .msg-bub{
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
}
.msg.assistant .msg-bub{
  background:rgba(245,200,0,0.06);
  border:1px solid rgba(245,200,0,0.16);
  border-left:2px solid var(--accent);
}

/* Typing */
.typing-row{align-self:flex-start;}
.typing-bub{
  display:inline-flex;gap:5px;align-items:center;
  padding:14px 18px;
  background:rgba(245,200,0,0.05);
  border:1px solid rgba(245,200,0,0.14);
  border-left:2px solid var(--accent);
}
.typing-bub span{
  width:6px;height:6px;border-radius:50%;background:var(--accent);
  animation:tdot 1.3s ease-in-out infinite;
}
.typing-bub span:nth-child(2){animation-delay:0.2s;}
.typing-bub span:nth-child(3){animation-delay:0.4s;}
@keyframes tdot{
  0%,60%,100%{transform:translateY(0);opacity:0.5;}
  30%{transform:translateY(-7px);opacity:1;}
}

/* Input */
.chat-input-area{
  position:sticky;bottom:0;
  padding:12px 0 28px;
  background:linear-gradient(to bottom,transparent,var(--bg) 32%);
}
.sug-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.sug-chip{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1.5px;
  text-transform:uppercase;padding:7px 12px;
  background:var(--accent-dim);border:1px solid var(--accent-border);
  color:rgba(245,200,0,0.75);cursor:pointer;transition:all 0.15s;
}
.sug-chip:hover{background:rgba(245,200,0,0.15);color:rgba(245,200,0,1);}

.input-row{
  display:flex;
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(6,6,6,0.98);
}
.chat-input{
  flex:1;background:none;border:none;color:var(--white);
  font-family:'DM Mono',monospace;font-size:12px;
  padding:16px 18px;outline:none;letter-spacing:0.3px;
}
.chat-input::placeholder{color:rgba(255,255,255,0.18);}
.chat-input:focus{caret-color:var(--accent);}
.send-btn{
  background:var(--accent);border:none;color:#0a0a0a;
  font-family:'Archivo Black',sans-serif;font-size:11px;
  letter-spacing:1px;padding:0 22px;cursor:pointer;
  transition:opacity 0.15s;white-space:nowrap;
}
.send-btn:hover{opacity:0.85;}
.send-btn:disabled{opacity:0.22;cursor:not-allowed;}
.input-hint{
  font-family:'DM Mono',monospace;font-size:7.5px;letter-spacing:1.5px;
  text-transform:uppercase;color:rgba(255,255,255,0.12);
  margin-top:8px;text-align:center;
}

/* ── MOBILE BOTTOM NAV ── */
.bottom-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;
  background:rgba(8,8,8,0.97);border-top:1px solid rgba(255,255,255,0.08);
  z-index:500;padding:10px 0 max(10px,env(safe-area-inset-bottom));
  backdrop-filter:blur(12px);
}
.bottom-nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;
  color:rgba(255,255,255,0.3);text-decoration:none;
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1.5px;
  text-transform:uppercase;padding:4px 0;transition:color 0.15s;
}
.bottom-nav-item svg{width:20px;height:20px;}
.bottom-nav-item:hover,.bottom-nav-item.active{color:#fff;}
.bottom-nav-item.active svg{stroke:#f5c800;}

@media(max-width:640px){
  .bottom-nav{display:flex;}
  .main-nav{display:none!important;}
  body{padding-bottom:72px;}
  .chat-msgs{max-height:calc(100vh - 290px);}
  .cl-hero{flex-direction:column;gap:16px;}
  .chat-wrap,.landing{padding-left:18px;padding-right:18px;}
}

/* Staggered entrance */
.landing > *{opacity:0;transform:translateY(14px);animation:fadeup 0.4s forwards;}
.landing > *:nth-child(1){animation-delay:0.05s;}
.landing > *:nth-child(2){animation-delay:0.12s;}
.landing > *:nth-child(3){animation-delay:0.2s;}
.landing > *:nth-child(4){animation-delay:0.28s;}
.landing > *:nth-child(5){animation-delay:0.34s;}
@keyframes fadeup{to{opacity:1;transform:none;}}



/* ── MESSAGE STAGGER-IN ── */
@keyframes msg-appear{
  0%{opacity:0;transform:translateY(8px);}
  100%{opacity:1;transform:translateY(0);}
}
.msg-animate{
  animation:msg-appear 0.32s cubic-bezier(0.22,1,0.36,1) forwards;
}
/* typewriter cursor */
.typing-cursor{
  display:inline-block;width:2px;height:1em;
  background:rgba(245,200,0,0.7);
  margin-left:2px;vertical-align:text-bottom;
  animation:cursor-blink 0.7s steps(1) infinite;
}
@keyframes cursor-blink{0%,100%{opacity:1;}50%{opacity:0;}}
</style>
</head>
<body>

<!-- PROFILE MODAL -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <div class="modal-title">Edit Profile</div>
    <div class="modal-sub">Updates across the whole app</div>
    <div class="field"><label class="field-label">Your Name</label><input type="text" id="p-name" placeholder="e.g. Conor"/></div>
    <div class="field">
      <label class="field-label">Skill Level</label>
      <select id="p-skill">
        <option value="beginner">Beginner — still learning to stand up</option>
        <option value="intermediate">Intermediate — comfortable on green waves</option>
        <option value="advanced">Advanced — surfing most conditions</option>
        <option value="expert">Expert — charging anything</option>
      </select>
    </div>
    <div class="field">
      <label class="field-label">Work Schedule</label>
      <select id="p-work">
        <option value="9to5">9–5 weekdays</option>
        <option value="flexible">Flexible / remote</option>
        <option value="shift">Shift work</option>
        <option value="retired">Retired / student</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveProfile()">Save →</button>
  </div>
</div>

<header>
  <div><div class="logo">QUIVER</div><div class="logo-tag">Surf Guide</div></div>
  <nav class="main-nav">
    <a href="index.html" class="nav-link">Forecast</a>
    <a href="workshop.html" class="nav-link active">Workshop</a>
    <a href="trip.html" class="nav-link">Trip</a>
  </nav>
  <button class="profile-btn" onclick="document.getElementById('modal').classList.add('show')">Edit Profile</button>
</header>

<div class="page" id="page"></div>

<nav class="bottom-nav">
  <a href="index.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h2M20 12h2M12 2v2M12 20v2"/><circle cx="12" cy="12" r="5"/></svg>
    <span>Forecast</span>
  </a>
  <a href="workshop.html" class="bottom-nav-item active">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    <span>Workshop</span>
  </a>
  <a href="trip.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>
    <span>Trip</span>
  </a>
</nav>

<script>
const MODEL = 'claude-haiku-4-5-20251001';

// ── PROFILE ──
function getProfile(){
  try{const p=JSON.parse(localStorage.getItem('quiver_profile'));return p&&p.skill?p:null;}
  catch(e){return null;}
}
function saveProfile(){
  try{
    const name=document.getElementById('p-name').value.trim()||'Surfer';
    const skill=document.getElementById('p-skill').value;
    const work=document.getElementById('p-work').value;
    localStorage.setItem('quiver_profile',JSON.stringify({name,skill,work}));
  }catch(e){}
  document.getElementById('modal').classList.remove('show');
}

// ── SESSION STATE ──
function getWS(){try{return JSON.parse(localStorage.getItem('quiver_workshop'))||null;}catch(e){return null;}}
function saveWS(d){try{localStorage.setItem('quiver_workshop',JSON.stringify(d));}catch(e){}}
function clearWS(){try{localStorage.removeItem('quiver_workshop');}catch(e){}}

let msgs = [];  // live conversation history

// ── SYSTEM PROMPT ──
function buildPrompt(ws){
  const lvlDesc={
    beginner:'still learning the basics — popping up, catching whitewash',
    intermediate:'comfortable on green waves, building their turns and wave reading',
    advanced:'surfing most conditions with intention, working on power and variety',
    expert:'high-performance surfing, comfortable in serious waves'
  }[ws.skill]||ws.skill;

  return `You are Core Lord — the in-house surf coach for the Quiver app. You are knowledgeable, dry, and direct. You've spent your life in the water. You don't do cheerleading or filler — you give real, specific, actionable coaching.

Your voice:
- Dry wit, never at the surfer's expense
- Direct and specific — cut the waffle
- Genuine care about helping them improve
- Use surf terminology naturally; explain it if they're a beginner
- Short focused paragraphs. Never walls of text.
- Ask a sharp follow-up when you need more context
- Occasionally use their name, not every reply
- If asked about shapers, boards, or gear — give a real informed opinion
- Never tell someone whether or not to paddle out — that's their call
- If asked something completely off-topic, redirect with dry humour

Surfer:
- Name: ${ws.name}
- Level: ${ws.skill} (${lvlDesc})
- Board: ${ws.board}
- Surfs: ${ws.freq}
- Working on: ${ws.goal}

Match your technical depth to their level. A beginner gets things explained clearly. An expert gets talked to like a peer. Keep it real.`;
}

// ── LANDING ──
function showLanding(){
  const profile=getProfile();
  const sv=profile?.skill||'intermediate';

  document.getElementById('page').innerHTML=`
    <div class="landing">

      <div class="cl-hero">
        <div class="cl-avatar-wrap">
          <div class="cl-avatar-pulse2"></div>
          <div class="cl-avatar-pulse"></div>
          <div class="cl-avatar">
<svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg" width="54" height="54">
              <path d="M24 30 Q20 38 18 50 L42 50 Q40 38 36 30 Q33 26 30 26 Q27 26 24 30Z" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.05)" stroke-linejoin="round"/>
              <ellipse cx="30" cy="22" rx="6" ry="7" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.05)"/>
              <path d="M30 15 L24 22 L36 22 Z" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.08)" stroke-linejoin="round"/>
              <line x1="24" y1="22" x2="36" y2="22" stroke="#f5c800" stroke-width="1.3"/>
              <path d="M25 27 Q22 33 23 40 Q26 44 30 44 Q34 44 37 40 Q38 33 35 27" stroke="rgba(245,200,0,0.5)" stroke-width="1.1" fill="none" stroke-linecap="round"/>
              <line x1="40" y1="18" x2="38" y2="50" stroke="#f5c800" stroke-width="1.3" stroke-linecap="round"/>
              <circle cx="40.5" cy="17" r="2.5" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.2)"/>
              <circle cx="28" cy="21" r="1" fill="#f5c800" opacity="0.8"/>
              <circle cx="32" cy="21" r="1" fill="#f5c800" opacity="0.8"/>
            </svg>
            <div class="cl-status"></div>
          </div>
        </div>
        <div class="cl-intro">
          <div class="cl-eyebrow">Quiver Workshop</div>
          <div class="cl-name">CORE<br><em>LORD</em></div>
          <div class="cl-bio">Your in-house surf coach. Bogging your rail on turns? Paddle power letting you down? Can't read a lineup? Want to find a local shaper? Ask Core Lord.</div>
        </div>
      </div>

      <div class="cl-tags">
        <span class="cl-tag cl-tag-accent">Online now</span>
        <span class="cl-tag">Backhand repairs</span>
        <span class="cl-tag">Bottom turns</span>
        <span class="cl-tag">Paddle fitness</span>
        <span class="cl-tag">Reading lineups</span>
        <span class="cl-tag">Board advice</span>
        <span class="cl-tag">Duck diving</span>
        <span class="cl-tag">Finding shapers</span>
        <span class="cl-tag">Wipeout recovery</span>
      </div>

      <div class="cl-divider"></div>

      <div class="q-grid">
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">Your name</label>
          <input class="q-input" id="q-name" placeholder="e.g. Conor" value="${profile?.name||''}"/>
        </div>
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">Skill level</label>
          <select class="q-select" id="q-skill">
            <option value="beginner" ${sv==='beginner'?'selected':''}>Beginner</option>
            <option value="intermediate" ${sv==='intermediate'?'selected':''}>Intermediate</option>
            <option value="advanced" ${sv==='advanced'?'selected':''}>Advanced</option>
            <option value="expert" ${sv==='expert'?'selected':''}>Expert</option>
          </select>
        </div>
      </div>

      <div class="q-grid">
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">Your board</label>
          <select class="q-select" id="q-board">
            <option value="foamie">Foamie / Softboard</option>
            <option value="longboard">Longboard</option>
            <option value="mid-length">Mid-length</option>
            <option value="fish">Fish</option>
            <option value="shortboard" selected>Shortboard</option>
            <option value="step-up">Step-up</option>
          </select>
        </div>
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">How often?</label>
          <select class="q-select" id="q-freq">
            <option value="a few times a year">A few times a year</option>
            <option value="once or twice a month">Once or twice a month</option>
            <option value="most weekends" selected>Most weekends</option>
            <option value="a few times a week">A few times a week</option>
            <option value="nearly every day">Nearly every day</option>
          </select>
        </div>
      </div>

      <div class="q-field">
        <label class="q-label">What do you want to work on?</label>
        <textarea class="q-textarea" id="q-goal" placeholder="e.g. my backhand is weak, I can't generate speed on small waves, I keep getting caught inside..."></textarea>
      </div>

      <button class="cl-cta" id="ctaBtn" onclick="startSession()" onmouseenter="this.textContent='Drop In →'" onmouseleave="this.textContent='Talk to Core Lord →'">Talk to Core Lord →</button>

    </div>
  `;

  // autofocus goal if name already known
  if(profile?.name) setTimeout(()=>{const g=document.getElementById('q-goal');if(g)g.focus();},200);
}

// ── START SESSION ──
function startSession(){
  const name =(document.getElementById('q-name').value.trim())||'Surfer';
  const skill= document.getElementById('q-skill').value;
  const board= document.getElementById('q-board').value;
  const freq = document.getElementById('q-freq').value;
  const goal = document.getElementById('q-goal').value.trim();

  if(!goal){
    const g=document.getElementById('q-goal');
    g.style.borderColor='rgba(245,200,0,0.5)';
    g.placeholder='Tell Core Lord what you\'re working on...';
    g.focus();
    return;
  }

  // persist name + skill to main profile
  try{
    const ex=getProfile()||{};
    localStorage.setItem('quiver_profile',JSON.stringify({...ex,name,skill}));
  }catch(e){}

  const ws={name,skill,board,freq,goal,started:Date.now()};
  saveWS(ws);
  msgs=[];

  renderChat(ws);
  // Core Lord's opener — no API call, just sets the tone immediately
  const opener=buildOpener(ws);
  appendMsg('assistant',opener);
  msgs.push({role:'assistant',content:opener});
}

function buildOpener(ws){
  const openers={
    beginner:`Right, ${ws.name}. ${ws.goal} — that's a very fixable problem. Before I give you anything to work on, tell me: when you're out there and it goes wrong, what does it feel like? What are you aware of in that moment?`,
    intermediate:`${ws.name}. ${ws.goal} — classic one, and I hear it a lot. Let me ask you something first: is this happening on both your forehand and backhand, or is it worse on one side?`,
    advanced:`${ws.goal} — alright. A few things can cause that depending on where exactly it's breaking down. Walk me through what's happening: is it early in the turn, at the apex, or when you're trying to come out of it?`,
    expert:`${ws.goal}. Yeah, tell me more. Happening in specific conditions or across the board? And are we talking contest-level performance or just something that's been nagging at you?`
  };
  return openers[ws.skill]||openers.intermediate;
}

// ── RENDER CHAT ──
function renderChat(ws){
  document.getElementById('page').innerHTML=`
    <div class="chat-wrap">
      <div class="chat-hdr">
        <div class="chat-hdr-avatar">
<svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:28px;height:28px">
            <path d="M24 30 Q20 38 18 50 L42 50 Q40 38 36 30 Q33 26 30 26 Q27 26 24 30Z" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.05)" stroke-linejoin="round"/>
            <ellipse cx="30" cy="22" rx="6" ry="7" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.05)"/>
            <path d="M30 15 L24 22 L36 22 Z" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.08)" stroke-linejoin="round"/>
            <line x1="24" y1="22" x2="36" y2="22" stroke="#f5c800" stroke-width="1.3"/>
            <path d="M25 27 Q22 33 23 40 Q26 44 30 44 Q34 44 37 40 Q38 33 35 27" stroke="rgba(245,200,0,0.5)" stroke-width="1.1" fill="none" stroke-linecap="round"/>
            <line x1="40" y1="18" x2="38" y2="50" stroke="#f5c800" stroke-width="1.3" stroke-linecap="round"/>
            <circle cx="40.5" cy="17" r="2.5" stroke="#f5c800" stroke-width="1.3" fill="rgba(245,200,0,0.2)"/>
            <circle cx="28" cy="21" r="1" fill="#f5c800" opacity="0.8"/>
            <circle cx="32" cy="21" r="1" fill="#f5c800" opacity="0.8"/>
          </svg>
        </div>
        <div class="chat-hdr-info">
          <div class="chat-hdr-name">CHAT WITH CORE LORD</div>
          <div class="chat-hdr-sub">${ws.name} · ${ws.skill} · ${ws.board}</div>
        </div>
        <div class="chat-hdr-live"><span class="live-dot"></span>Online</div>
        <button class="new-sesh-btn" onclick="confirmReset()">↺ New session</button>
      </div>

      <div class="chat-msgs" id="chatMsgs"></div>

      <div class="chat-input-area">
        <div class="sug-chips" id="sugChips">
          <div class="sug-chip" onclick="useSug(this)">What drills can I do on land?</div>
          <div class="sug-chip" onclick="useSug(this)">Is my board right for me?</div>
          <div class="sug-chip" onclick="useSug(this)">How do I read a lineup?</div>
          <div class="sug-chip" onclick="useSug(this)">Find me a shaper in Ireland</div>
        </div>
        <div class="input-row">
          <input class="chat-input" id="chatInput"
            placeholder="Ask Core Lord anything..."
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"/>
          <button class="send-btn" id="sendBtn" onclick="sendMsg()">Send →</button>
        </div>
        <div class="input-hint">Enter to send · session saved in browser</div>
      </div>
    </div>
  `;
}



function useSug(el){
  document.getElementById('sugChips').style.display='none';
  const inp=document.getElementById('chatInput');
  if(inp){inp.value=el.textContent.trim();inp.focus();}
}

// ── SEND ──
async function sendMsg(){
  const inp=document.getElementById('chatInput');
  const text=inp?.value.trim();
  if(!text)return;
  inp.value='';

  // hide chips once they start typing
  const chips=document.getElementById('sugChips');
  if(chips)chips.style.display='none';

  msgs.push({role:'user',content:text});
  appendMsg('user',text);
  await fetchReply();
}

// ── API proxy — swap this URL after deploying your Cloudflare Worker ──
const PROXY_URL = 'https://quiver-proxyquiver-proxy.quiver-ie.workers.dev/chat';

async function fetchReply(){
  const ws=getWS();
  if(!ws)return;

  // typing indicator
  const tid='t'+Date.now();
  const msgsEl=document.getElementById('chatMsgs');
  if(msgsEl){
    msgsEl.innerHTML+=`
      <div class="msg assistant typing-row" id="${tid}">
        <div class="msg-lbl"><span class="lbl-pip"></span>Core Lord</div>
        <div class="typing-bub"><span></span><span></span><span></span></div>
      </div>`;
    msgsEl.scrollTop=msgsEl.scrollHeight;
  }

  const btn=document.getElementById('sendBtn');
  const inp=document.getElementById('chatInput');
  if(btn)btn.disabled=true;
  if(inp)inp.disabled=true;

  try{
    const res=await fetch(PROXY_URL,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
      },
      body:JSON.stringify({
        model:MODEL,
        max_tokens:700,
        system:buildPrompt(ws),
        messages:msgs
      })
    });
    const data=await res.json();
    console.log('[CoreLord] API response:', res.status, JSON.stringify(data).slice(0,300));

    // Surface API errors clearly rather than swallowing them
    if(!res.ok || data.error){
      const errType = data.error?.type||'unknown';
      const errMsg  = data.error?.message||'No message';
      console.error('[CoreLord] API error:', errType, errMsg);
      const userMsg = errType==='authentication_error'
        ? 'Could not reach Core Lord — the proxy may be down.'
        : errType==='invalid_request_error'
        ? 'Bad request: '+errMsg
        : `API error (${res.status}): ${errMsg}`;
      const tel=document.getElementById(tid);
      if(tel) tel.outerHTML=buildMsgHTML('assistant', userMsg);
      if(btn)btn.disabled=false;
      if(inp){inp.disabled=false;inp.focus();}
      return;
    }

    const rawReply=data.content?.find(b=>b.type==='text')?.text||'No reply in response — check console.';
    const reply=rawReply;
    msgs.push({role:'assistant',content:reply});

    const tel=document.getElementById(tid);
    if(tel){
      // Replace typing indicator with empty bubble, then stream words in
      const msgId='m'+Date.now();
      tel.outerHTML=`<div class="msg assistant msg-animate" id="${msgId}">
        <div class="msg-lbl"><span class="lbl-pip"></span>Core Lord</div>
        <div class="msg-bub"><p id="${msgId}-p"></p></div>
      </div>`;
      await typewriterReveal(msgId+'-p', reply, msgsEl);
    }
  }catch(e){
    console.error('[CoreLord] fetch error:', e);
    const tel=document.getElementById(tid);
    if(tel) tel.outerHTML=buildMsgHTML('assistant',"Network error — check your connection and console for details.");
  }

  if(btn)btn.disabled=false;
  if(inp){inp.disabled=false;inp.focus();}
  const msgsEl2=document.getElementById('chatMsgs');
  if(msgsEl2)msgsEl2.scrollTop=msgsEl2.scrollHeight;
}

// ── MSG HELPERS ──
function esc(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function formatMsg(text){
  // Strip markdown formatting Core Lord sometimes uses
  let t = text
    .replace(/\*\*(.+?)\*\*/g,'$1')   // **bold**
    .replace(/__(.+?)__/g,'$1')            // __bold__
    .replace(/\*([^\*]+)\*/g,'$1')      // *italic*
    .replace(/_([^_]+)_/g,'$1')            // _italic_
    .replace(/^#{1,4}\s+/gm,'')           // ## headings
    .replace(/^[\*\-]\s+/gm,'');        // - bullets
  return esc(t)
    .replace(/\n\n/g,'</p><p style="margin-top:10px">')
    .replace(/\n/g,'<br>');
}
// ── TYPEWRITER REVEAL ──
async function typewriterReveal(elId, text, scrollEl){
  const el=document.getElementById(elId);
  if(!el)return;
  // Add cursor
  el.innerHTML='<span class="typing-cursor"></span>';
  // Format the full text first, then stream it in word chunks
  const formatted=formatMsg(text);
  // Split into tokens: tags stay whole, text splits by word
  const tokens=[];
  let buf='',inTag=false;
  for(const ch of formatted){
    if(ch==='<'){inTag=true;buf+=ch;}
    else if(ch==='>'){inTag=false;buf+=ch;tokens.push(buf);buf='';}
    else if(inTag){buf+=ch;}
    else if(ch===' '&&buf){tokens.push(buf+' ');buf='';}
    else{buf+=ch;}
  }
  if(buf)tokens.push(buf);

  let content='';
  const cursor='<span class="typing-cursor"></span>';
  // Batch tokens for speed — ~3 words per frame feels natural
  const BATCH=3;
  for(let i=0;i<tokens.length;i+=BATCH){
    content+=tokens.slice(i,i+BATCH).join('');
    el.innerHTML=content+cursor;
    if(scrollEl)scrollEl.scrollTop=scrollEl.scrollHeight;
    await new Promise(r=>setTimeout(r,28));
  }
  // Final — remove cursor
  el.innerHTML=content;
  if(scrollEl)scrollEl.scrollTop=scrollEl.scrollHeight;
}

function buildMsgHTML(role,text){
  const lbl=role==='user'
    ?'You'
    :'<span class="lbl-pip"></span>Core Lord';
  const animClass=role==='assistant'?' msg-animate':'';
  return`<div class="msg ${role}${animClass}">
    <div class="msg-lbl">${lbl}</div>
    <div class="msg-bub"><p>${formatMsg(text)}</p></div>
  </div>`;
}
function appendMsg(role,text){
  const el=document.getElementById('chatMsgs');
  if(!el)return;
  el.innerHTML+=buildMsgHTML(role,text);
  el.scrollTop=el.scrollHeight;
}

// ── RESET ──
function confirmReset(){
  if(msgs.length>2&&!confirm('Start a new session with Core Lord?'))return;
  clearWS();
  msgs=[];
  showLanding();
}

// ── INIT ──
const existing=getWS();
if(existing){
  // Resume session
  renderChat(existing);
  // Build a short punchy welcome-back — don't parrot their goal back verbatim
  const welcomeBack = `${existing.name}. You're back. Same thing we were working on, or something new?`;
  msgs=[{role:'assistant',content:welcomeBack}];
  appendMsg('assistant',msgs[0].content);
}else{
  showLanding();
}
</script>
</body>
</html>
