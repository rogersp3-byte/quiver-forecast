<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiver — Workshop</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0a;--surface:#141414;--white:#fff;
  --muted:rgba(255,255,255,0.38);--faint:rgba(255,255,255,0.08);
  --accent:#f5c800;--accent-dim:rgba(245,200,0,0.1);--accent-border:rgba(245,200,0,0.22);
  --good:#22c55e;--poor:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{
  font-family:'Archivo Black',sans-serif;color:var(--white);
  background:var(--bg);overflow-x:hidden;min-height:100vh;
}
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.055;mix-blend-mode:overlay;
}

/* ── HEADER ── */
header{
  position:relative;z-index:10;padding:18px 28px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--faint);
}
.logo{font-size:18px;letter-spacing:2px;}
.logo-tag{font-family:'DM Mono',monospace;font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.main-nav{display:flex;gap:0;border:1px solid rgba(255,255,255,0.12);flex:1;margin:0 32px;}
.nav-link{flex:1;text-align:center;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:11px 20px;color:var(--muted);text-decoration:none;border-right:1px solid rgba(255,255,255,0.12);transition:all 0.15s;}
.nav-link:last-child{border-right:none;}
.nav-link:hover{color:var(--white);background:rgba(255,255,255,0.05);}
.nav-link.active{color:var(--white);background:rgba(255,255,255,0.07);}
.profile-btn{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid rgba(255,255,255,0.15);padding:7px 14px;cursor:pointer;transition:all 0.15s;}
.profile-btn:hover{border-color:rgba(255,255,255,0.35);color:rgba(255,255,255,0.7);}

/* ── MODAL ── */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:1000;display:none;align-items:center;justify-content:center;padding:24px;}
.modal-backdrop.show{display:flex;}
.modal{background:#1a1a1a;max-width:480px;width:100%;padding:36px;border:1px solid rgba(255,255,255,0.1);}
.modal-title{font-size:22px;letter-spacing:-0.5px;margin-bottom:6px;}
.modal-sub{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:32px;}
.field{margin-bottom:22px;}
.field-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);margin-bottom:10px;display:block;}
.field select,.field input{width:100%;background:#111;border:1px solid rgba(255,255,255,0.15);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;padding:12px 14px;outline:none;appearance:none;}
.modal-btn{width:100%;background:var(--white);color:#0f0f0f;border:none;font-family:'Archivo Black',sans-serif;font-size:13px;letter-spacing:1px;padding:16px;cursor:pointer;}

/* ── PAGE WRAPPER ── */
.page{position:relative;z-index:5;min-height:calc(100vh - 65px);display:flex;flex-direction:column;}

/* ═══════════════════════════════
   LANDING
═══════════════════════════════ */
.landing{
  flex:1;display:flex;flex-direction:column;align-items:center;
  max-width:640px;width:100%;margin:0 auto;
  padding:clamp(32px,5vh,60px) 28px 60px;
  text-align:center;
}

/* ── TOP EYEBROW ── */
.ws-eyebrow{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:4px;
  text-transform:uppercase;color:rgba(245,200,0,0.55);
  margin-bottom:10px;
}
.ws-title{
  font-size:clamp(28px,6vw,44px);letter-spacing:-1.5px;
  color:var(--accent);margin-bottom:32px;line-height:1;
}
/* ── HERO: signal scene ── */
.cl-hero{
  display:flex;align-items:center;gap:0;
  margin-bottom:24px;position:relative;
  width:100%;justify-content:center;
}
.nokia-col{
  flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:8px;
  opacity:0;animation:fadeup 0.5s 0.1s forwards;position:relative;
}
.nokia-col::after,.face-col::after{
  content:'';position:absolute;inset:0;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)'/%3E%3C/svg%3E");
  opacity:0.35;mix-blend-mode:overlay;z-index:1;
}
.nokia-img{
  height:180px;width:auto;display:block;
  filter: grayscale(1) sepia(0.6) hue-rotate(5deg) saturate(4) contrast(1.5) brightness(0.65);
}
.nokia-lbl{
  font-family:'DM Mono',monospace;font-size:7px;letter-spacing:2px;
  text-transform:uppercase;color:rgba(245,200,0,0.35);
}
.signal-track{
  flex:1;display:flex;align-items:center;padding:0 4px;margin-bottom:28px;
}
.signal-svg{width:100%;overflow:visible;}
.sig-line{stroke-dasharray:4 6;animation:march 0.5s linear infinite;}
@keyframes march{to{stroke-dashoffset:-10;}}
.sig-pulse{
  fill:none;stroke:#f5c800;stroke-width:1.5;
  opacity:0;animation:pulse-travel 2s ease-in-out infinite;
}
.sig-pulse:nth-child(2){animation-delay:0.65s;}
.sig-pulse:nth-child(3){animation-delay:1.3s;}
@keyframes pulse-travel{
  0%{opacity:0;stroke-dashoffset:0;}
  10%{opacity:1;}
  80%{opacity:0.6;}
  100%{opacity:0;stroke-dashoffset:-80;}
}
.sig-dot{animation:sig-pulse 1.4s ease-in-out infinite;}
.sig-dot:nth-child(2){animation-delay:0.35s;}
.sig-dot:nth-child(3){animation-delay:0.7s;}
.sig-dot:nth-child(4){animation-delay:1.05s;}
@keyframes sig-pulse{0%,100%{opacity:0.15;r:3;}50%{opacity:1;r:4.5;}}
.face-col{
  flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:8px;
  opacity:0;animation:fadeup 0.5s 0.2s forwards;position:relative;
}
.face-img{
  width:160px;height:160px;border-radius:50%;display:block;
  filter: grayscale(1) sepia(0.6) hue-rotate(5deg) saturate(4) contrast(1.5) brightness(0.65);
  border:1.5px solid rgba(245,200,0,0.3);
  box-shadow:0 0 30px rgba(245,200,0,0.08),0 0 0 6px rgba(245,200,0,0.04);
  object-fit:cover;
}
.face-lbl{
  font-family:'DM Mono',monospace;font-size:7px;letter-spacing:2px;
  text-transform:uppercase;color:rgba(245,200,0,0.35);
}

.cl-bio-text{
  font-family:'DM Mono',monospace;font-size:11px;line-height:1.75;
  color:rgba(255,255,255,0.52);text-align:center;
  max-width:400px;margin:0 auto 28px;
}
/* ── DIVIDER ── */
.cl-divider{
  width:100%;height:1px;background:rgba(255,255,255,0.07);
  margin-bottom:28px;position:relative;
}
.cl-divider::before{
  content:'Your details';
  position:absolute;left:0;top:50%;transform:translateY(-50%);
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:3px;
  text-transform:uppercase;color:var(--muted);
  background:var(--bg);padding-right:14px;
  text-align:left;
}

/* ── FORM ── */
.q-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;width:100%;}
@media(max-width:480px){.q-grid{grid-template-columns:1fr;}}
.q-field{margin-bottom:14px;width:100%;}
.q-label{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2.5px;
  text-transform:uppercase;color:rgba(255,255,255,0.4);
  margin-bottom:8px;display:block;
}
.q-input,.q-select,.q-textarea{
  width:100%;background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--white);font-family:'DM Mono',monospace;
  font-size:12px;padding:12px 15px;outline:none;appearance:none;
  transition:border-color 0.2s, background 0.2s;
}
.q-input:focus,.q-select:focus,.q-textarea:focus{
  border-color:rgba(245,200,0,0.35);
  background:rgba(245,200,0,0.03);
}
.q-input::placeholder,.q-textarea::placeholder{color:rgba(255,255,255,0.18);}
.q-textarea{resize:none;height:80px;line-height:1.65;}

.cl-cta{
  width:100%;align-self:stretch;background:var(--accent);color:#0a0a0a;border:none;
  font-family:'Archivo Black',sans-serif;font-size:13px;
  letter-spacing:1.5px;text-transform:uppercase;
  padding:19px;cursor:pointer;margin-top:6px;
  transition:opacity 0.15s;position:relative;overflow:hidden;
}
.cl-cta::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);
  transform:translateX(-100%);transition:transform 0.45s;
}
.cl-cta:hover{opacity:0.9;}
.cl-cta:hover::before{transform:translateX(100%);}

/* ═══════════════════════════════
   CHAT
═══════════════════════════════ */
.chat-wrap{
  flex:1;display:flex;flex-direction:column;
  max-width:720px;width:100%;margin:0 auto;
  padding:22px 28px 0;
}
.chat-hdr{
  display:flex;align-items:center;gap:14px;
  padding-bottom:18px;
  border-bottom:1px solid var(--faint);
  margin-bottom:18px;
}
.chat-hdr-avatar{
  width:42px;height:42px;border-radius:50%;flex-shrink:0;
  background:radial-gradient(circle at 38% 32%,#1e1800,#080600);
  border:1.5px solid rgba(245,200,0,0.35);
  display:flex;align-items:center;justify-content:center;
  font-size:19px;
  box-shadow:0 0 14px rgba(245,200,0,0.1);
}
.chat-hdr-info{flex:1;}
.chat-hdr-name{font-size:17px;letter-spacing:-0.3px;}
.chat-hdr-sub{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;
  text-transform:uppercase;color:var(--muted);margin-top:2px;
}
.chat-hdr-live{
  display:flex;align-items:center;gap:6px;
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;
  text-transform:uppercase;color:var(--good);
}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--good);animation:status-blink 2.5s ease-in-out infinite;}
@keyframes status-blink{0%,100%{opacity:1;}50%{opacity:0.4;}}
.new-sesh-btn{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;
  text-transform:uppercase;color:var(--muted);background:none;
  border:1px solid rgba(255,255,255,0.1);padding:7px 11px;cursor:pointer;
  transition:all 0.15s;
}
.new-sesh-btn:hover{border-color:rgba(255,255,255,0.28);color:rgba(255,255,255,0.65);}

.chat-msgs{
  flex:1;overflow-y:auto;padding-bottom:12px;
  display:flex;flex-direction:column;gap:14px;
  max-height:calc(100vh - 310px);
}
.chat-msgs::-webkit-scrollbar{width:2px;}
.chat-msgs::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);}
.chat-msgs::-webkit-scrollbar-track{background:transparent;}

.msg{max-width:84%;}
.msg.user{align-self:flex-end;}
.msg.assistant{align-self:flex-start;}
.msg-lbl{
  font-family:'DM Mono',monospace;font-size:7px;letter-spacing:2px;
  text-transform:uppercase;color:var(--muted);
  margin-bottom:5px;display:flex;align-items:center;gap:5px;
}
.msg.user .msg-lbl{flex-direction:row-reverse;}
.lbl-pip{width:5px;height:5px;border-radius:50%;background:var(--accent);display:inline-block;}
.msg-bub{
  padding:13px 17px;
  font-family:'DM Mono',monospace;font-size:12px;line-height:1.78;
}
.msg.user .msg-bub{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);}
.msg.assistant .msg-bub{
  background:rgba(245,200,0,0.06);
  border:1px solid rgba(245,200,0,0.16);
  border-left:2px solid var(--accent);
}

.typing-row{align-self:flex-start;}
.typing-bub{
  display:inline-flex;gap:5px;align-items:center;
  padding:14px 18px;
  background:rgba(245,200,0,0.05);
  border:1px solid rgba(245,200,0,0.14);
  border-left:2px solid var(--accent);
}
.typing-bub span{
  width:6px;height:6px;border-radius:50%;background:var(--accent);
  animation:tdot 1.3s ease-in-out infinite;
}
.typing-bub span:nth-child(2){animation-delay:0.2s;}
.typing-bub span:nth-child(3){animation-delay:0.4s;}
@keyframes tdot{
  0%,60%,100%{transform:translateY(0);opacity:0.5;}
  30%{transform:translateY(-7px);opacity:1;}
}

.chat-input-area{
  position:sticky;bottom:0;
  padding:12px 0 28px;
  background:linear-gradient(to bottom,transparent,var(--bg) 32%);
}
.sug-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.sug-chip{
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1.5px;
  text-transform:uppercase;padding:7px 12px;
  background:var(--accent-dim);border:1px solid var(--accent-border);
  color:rgba(245,200,0,0.75);cursor:pointer;transition:all 0.15s;
}
.sug-chip:hover{background:rgba(245,200,0,0.15);color:rgba(245,200,0,1);}
.input-row{
  display:flex;
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(6,6,6,0.98);
}
.chat-input{
  flex:1;background:none;border:none;color:var(--white);
  font-family:'DM Mono',monospace;font-size:12px;
  padding:16px 18px;outline:none;letter-spacing:0.3px;
}
.chat-input::placeholder{color:rgba(255,255,255,0.18);}
.chat-input:focus{caret-color:var(--accent);}
.send-btn{
  background:var(--accent);border:none;color:#0a0a0a;
  font-family:'Archivo Black',sans-serif;font-size:11px;
  letter-spacing:1px;padding:0 22px;cursor:pointer;
  transition:opacity 0.15s;white-space:nowrap;
}
.send-btn:hover{opacity:0.85;}
.send-btn:disabled{opacity:0.22;cursor:not-allowed;}
.input-hint{
  font-family:'DM Mono',monospace;font-size:7.5px;letter-spacing:1.5px;
  text-transform:uppercase;color:rgba(255,255,255,0.12);
  margin-top:8px;text-align:center;
}

/* ── MOBILE BOTTOM NAV ── */
.bottom-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;
  background:rgba(8,8,8,0.97);border-top:1px solid rgba(255,255,255,0.08);
  z-index:500;padding:10px 0 max(10px,env(safe-area-inset-bottom));
  backdrop-filter:blur(12px);
}
.bottom-nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;
  color:rgba(255,255,255,0.3);text-decoration:none;
  font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1.5px;
  text-transform:uppercase;padding:4px 0;transition:color 0.15s;
}
.bottom-nav-item svg{width:20px;height:20px;}
.bottom-nav-item:hover,.bottom-nav-item.active{color:#fff;}
.bottom-nav-item.active svg{stroke:#f5c800;}

@media(max-width:640px){
  .bottom-nav{display:flex;}
  .main-nav{display:none!important;}
  body{padding-bottom:72px;}
  .chat-msgs{max-height:calc(100vh - 290px);}
  .nokia-img{height:120px;}.face-img{width:110px;height:110px;}
  .chat-wrap,.landing{padding-left:18px;padding-right:18px;}
}

.landing > *{opacity:0;transform:translateY(14px);animation:fadeup 0.4s forwards;}
.landing > *:nth-child(1){animation-delay:0.05s;}
.landing > *:nth-child(2){animation-delay:0.12s;}
.landing > *:nth-child(3){animation-delay:0.2s;}
.landing > *:nth-child(4){animation-delay:0.28s;}
.landing > *:nth-child(5){animation-delay:0.34s;}
@keyframes ping{0%{transform:scale(1);opacity:0.7;}100%{transform:scale(2.8);opacity:0;}}
@keyframes fadeup{to{opacity:1;transform:none;}}

@keyframes msg-appear{
  0%{opacity:0;transform:translateY(8px);}
  100%{opacity:1;transform:translateY(0);}
}
.msg-animate{animation:msg-appear 0.32s cubic-bezier(0.22,1,0.36,1) forwards;}
.typing-cursor{
  display:inline-block;width:2px;height:1em;
  background:rgba(245,200,0,0.7);
  margin-left:2px;vertical-align:text-bottom;
  animation:cursor-blink 0.7s steps(1) infinite;
}
@keyframes cursor-blink{0%,100%{opacity:1;}50%{opacity:0;}}
</style>
</head>
<body>

<!-- PROFILE MODAL -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <div class="modal-title">Edit Profile</div>
    <div class="modal-sub">Updates across the whole app</div>
    <div class="field"><label class="field-label">Your Name</label><input type="text" id="p-name" placeholder="e.g. Conor"/></div>
    <div class="field">
      <label class="field-label">Skill Level</label>
      <select id="p-skill">
        <option value="beginner">Beginner — still learning to stand up</option>
        <option value="intermediate">Intermediate — comfortable on green waves</option>
        <option value="advanced">Advanced — surfing most conditions</option>
        <option value="expert">Expert — charging anything</option>
      </select>
    </div>
    <div class="field">
      <label class="field-label">Work Schedule</label>
      <select id="p-work">
        <option value="9to5">9–5 weekdays</option>
        <option value="flexible">Flexible / remote</option>
        <option value="shift">Shift work</option>
        <option value="retired">Retired / student</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveProfile()">Save →</button>
  </div>
</div>

<header>
  
    <a href="index.html" class="nav-link">Forecast</a>
    <a href="workshop.html" class="nav-link active">Workshop</a>
    <a href="trip.html" class="nav-link">Trip</a>
  </nav>
  <button class="profile-btn" onclick="document.getElementById('modal').classList.add('show')">Edit Profile</button>
</header>

<div class="page" id="page"></div>

<nav class="bottom-nav">
  <a href="index.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h2M20 12h2M12 2v2M12 20v2"/><circle cx="12" cy="12" r="5"/><path d="M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
    <span>Forecast</span>
  </a>
  <a href="workshop.html" class="bottom-nav-item active">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    <span>Workshop</span>
  </a>
  <a href="trip.html" class="bottom-nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>
    <span>Trip</span>
  </a>
</nav>

<script>

const MODEL = 'claude-haiku-4-5-20251001';

function getProfile(){
  try{const p=JSON.parse(localStorage.getItem('quiver_profile'));return p&&p.skill?p:null;}
  catch(e){return null;}
}
function saveProfile(){
  try{
    const name=document.getElementById('p-name').value.trim()||'Surfer';
    const skill=document.getElementById('p-skill').value;
    const work=document.getElementById('p-work').value;
    localStorage.setItem('quiver_profile',JSON.stringify({name,skill,work}));
  }catch(e){}
  document.getElementById('modal').classList.remove('show');
}

function getWS(){try{return JSON.parse(localStorage.getItem('quiver_workshop'))||null;}catch(e){return null;}}
function saveWS(d){try{localStorage.setItem('quiver_workshop',JSON.stringify(d));}catch(e){}}
function clearWS(){try{localStorage.removeItem('quiver_workshop');}catch(e){}}

let msgs = [];

function buildPrompt(ws){
  const lvlDesc={
    beginner:'still learning the basics — popping up, catching whitewash',
    intermediate:'comfortable on green waves, building their turns and wave reading',
    advanced:'surfing most conditions with intention, working on power and variety',
    expert:'high-performance surfing, comfortable in serious waves'
  }[ws.skill]||ws.skill;

  return `You are Core Lord — the in-house surf coach for the Quiver app. You are knowledgeable, dry, and direct. You've spent your life in the water. You don't do cheerleading or filler — you give real, specific, actionable coaching.

Your voice:
- Dry wit, never at the surfer's expense
- Direct and specific — cut the waffle
- Genuine care about helping them improve
- Use surf terminology naturally; explain it if they're a beginner
- Short focused paragraphs. Never walls of text.
- Ask a sharp follow-up when you need more context
- Occasionally use their name, not every reply
- If asked about shapers, boards, or gear — give a real informed opinion
- Never tell someone whether or not to paddle out — that's their call
- If asked something completely off-topic, redirect with dry humour

Surfer:
- Name: ${ws.name}
- Level: ${ws.skill} (${lvlDesc})
- Board: ${ws.board}
- Surfs: ${ws.freq}
- Working on: ${ws.goal}

Match your technical depth to their level. A beginner gets things explained clearly. An expert gets talked to like a peer. Keep it real.`;
}

function showLanding(){
  const profile=getProfile();
  const sv=profile?.skill||'intermediate';

  document.getElementById('page').innerHTML=`
    <div class="landing">

      <div class="ws-eyebrow">Quiver Workshop</div>
      <div class="ws-title">Talk to Core Lord</div>

      <div class="cl-hero">
        <!-- Nokia -->
        <div class="nokia-col">
          <img class="nokia-img" src="https://quiver-forecast.vercel.app/images/Nokia%203210.png" alt="Nokia 3210"/>
          <div class="nokia-lbl">Nokia 3210</div>
        </div>

        <!-- Animated signal line -->
        <div class="signal-track">
          <svg class="signal-svg" height="36" viewBox="0 0 200 36" preserveAspectRatio="xMidYMid meet">
            <!-- base dashed line -->
            <line class="sig-line" x1="0" y1="18" x2="165" y2="18"
              stroke="rgba(245,200,0,0.3)" stroke-width="1"
              stroke-dasharray="4 6" stroke-dashoffset="0"/>
            <!-- travelling dots -->
            <circle class="sig-dot" cx="30" cy="18" r="3" fill="#f5c800"/>
            <circle class="sig-dot" cx="72" cy="18" r="3" fill="#f5c800"/>
            <circle class="sig-dot" cx="114" cy="18" r="3" fill="#f5c800"/>
            <circle class="sig-dot" cx="150" cy="18" r="3" fill="#f5c800"/>
            <!-- arrowhead -->
            <polyline points="158,11 174,18 158,25"
              stroke="#f5c800" stroke-width="2"
              fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <!-- ping rings on arrowhead -->
            <circle cx="174" cy="18" r="6" fill="none" stroke="rgba(245,200,0,0.5)" stroke-width="1" style="animation:ping 1.8s ease-out infinite;transform-origin:174px 18px;"/>
            <circle cx="174" cy="18" r="6" fill="none" stroke="rgba(245,200,0,0.3)" stroke-width="1" style="animation:ping 1.8s ease-out 0.6s infinite;transform-origin:174px 18px;"/>
          </svg>
        </div>

        <!-- Core Lord face -->
        <div class="face-col">
          <img class="face-img" src="https://quiver-forecast.vercel.app/images/Core%20Lord.png" alt="Core Lord"/>
          <div class="face-lbl">Core Lord</div>
        </div>
      </div>

      <div class="cl-bio-text">The in-house surf coach. Bogging your rail on turns? Paddle power letting you down? Want to find a local shaper? Ask Core Lord.</div>

      <div class="cl-divider"></div>

      <div class="q-grid">
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">Your name</label>
          <input class="q-input" id="q-name" placeholder="e.g. Conor" value="${profile?.name||''}"/>
        </div>
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">Skill level</label>
          <select class="q-select" id="q-skill">
            <option value="beginner" ${sv==='beginner'?'selected':''}>Beginner</option>
            <option value="intermediate" ${sv==='intermediate'?'selected':''}>Intermediate</option>
            <option value="advanced" ${sv==='advanced'?'selected':''}>Advanced</option>
            <option value="expert" ${sv==='expert'?'selected':''}>Expert</option>
          </select>
        </div>
      </div>

      <div class="q-grid">
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">Your board</label>
          <select class="q-select" id="q-board">
            <option value="foamie">Foamie / Softboard</option>
            <option value="longboard">Longboard</option>
            <option value="mid-length">Mid-length</option>
            <option value="fish">Fish</option>
            <option value="shortboard" selected>Shortboard</option>
            <option value="step-up">Step-up</option>
          </select>
        </div>
        <div class="q-field" style="margin-bottom:0">
          <label class="q-label">How often?</label>
          <select class="q-select" id="q-freq">
            <option value="a few times a year">A few times a year</option>
            <option value="once or twice a month">Once or twice a month</option>
            <option value="most weekends" selected>Most weekends</option>
            <option value="a few times a week">A few times a week</option>
            <option value="nearly every day">Nearly every day</option>
          </select>
        </div>
      </div>

      <div class="q-field">
        <label class="q-label">What do you want to work on?</label>
        <textarea class="q-textarea" id="q-goal" placeholder="e.g. I can't generate speed on small waves..."></textarea>
      </div>

      <button class="cl-cta" id="ctaBtn" onclick="startSession()" onmouseenter="this.textContent='Drop In →'" onmouseleave="this.textContent='Talk to Core Lord →'">Talk to Core Lord →</button>

    </div>
  `;

  if(profile?.name) setTimeout(()=>{const g=document.getElementById('q-goal');if(g)g.focus();},200);
}

function startSession(){
  const name =(document.getElementById('q-name').value.trim())||'Surfer';
  const skill= document.getElementById('q-skill').value;
  const board= document.getElementById('q-board').value;
  const freq = document.getElementById('q-freq').value;
  const goal = document.getElementById('q-goal').value.trim();

  if(!goal){
    const g=document.getElementById('q-goal');
    g.style.borderColor='rgba(245,200,0,0.5)';
    g.placeholder='Tell Core Lord what you\'re working on...';
    g.focus();
    return;
  }

  try{
    const ex=getProfile()||{};
    localStorage.setItem('quiver_profile',JSON.stringify({...ex,name,skill}));
  }catch(e){}

  const ws={name,skill,board,freq,goal,started:Date.now()};
  saveWS(ws);
  msgs=[];

  renderChat(ws);
  // Seed conversation with the user's goal as their opening message
  msgs.push({role:'user',content:ws.goal});
  appendMsg('user',ws.goal);
  fetchReply();
}

function renderChat(ws){
  document.getElementById('page').innerHTML=`
    <div class="chat-wrap">
      <div class="chat-hdr">
        <div class="chat-hdr-avatar" style="overflow:hidden;padding:0;">
          <img src="https://quiver-forecast.vercel.app/images/Core%20Lord.png" style="width:100%;height:100%;object-fit:cover;filter:grayscale(1) sepia(0.6) saturate(4) contrast(1.5) brightness(0.65);" alt="Core Lord"/>
        </div>
        <div class="chat-hdr-info">
          <div class="chat-hdr-name">CHAT WITH CORE LORD</div>
          <div class="chat-hdr-sub">${ws.name} · ${ws.skill} · ${ws.board}</div>
        </div>
        <div class="chat-hdr-live"><span class="live-dot"></span>Online</div>
        <button class="new-sesh-btn" onclick="confirmReset()">↺ New session</button>
      </div>

      <div class="chat-msgs" id="chatMsgs"></div>

      <div class="chat-input-area">
        <div class="sug-chips" id="sugChips">
          <div class="sug-chip" onclick="useSug(this)">What drills can I do on land?</div>
          <div class="sug-chip" onclick="useSug(this)">Is my board right for me?</div>
          <div class="sug-chip" onclick="useSug(this)">How do I read a lineup?</div>
          <div class="sug-chip" onclick="useSug(this)">Find me a shaper in Ireland</div>
        </div>
        <div class="input-row">
          <input class="chat-input" id="chatInput"
            placeholder="Ask Core Lord anything..."
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"/>
          <button class="send-btn" id="sendBtn" onclick="sendMsg()">Send →</button>
        </div>
        <div class="input-hint">Enter to send · session saved in browser</div>
      </div>
    </div>
  `;
}

function useSug(el){
  document.getElementById('sugChips').style.display='none';
  const inp=document.getElementById('chatInput');
  if(inp){inp.value=el.textContent.trim();inp.focus();}
}

async function sendMsg(){
  const inp=document.getElementById('chatInput');
  const text=inp?.value.trim();
  if(!text)return;
  inp.value='';
  const chips=document.getElementById('sugChips');
  if(chips)chips.style.display='none';
  msgs.push({role:'user',content:text});
  appendMsg('user',text);
  await fetchReply();
}

const PROXY_URL = 'https://quiver-proxy.quiver-ie.workers.dev/chat';

async function fetchReply(){
  const ws=getWS();
  if(!ws)return;

  const tid='t'+Date.now();
  const msgsEl=document.getElementById('chatMsgs');
  if(msgsEl){
    msgsEl.innerHTML+=`
      <div class="msg assistant typing-row" id="${tid}">
        <div class="msg-lbl"><span class="lbl-pip"></span>Core Lord</div>
        <div class="typing-bub"><span></span><span></span><span></span></div>
      </div>`;
    msgsEl.scrollTop=msgsEl.scrollHeight;
  }

  const btn=document.getElementById('sendBtn');
  const inp=document.getElementById('chatInput');
  if(btn)btn.disabled=true;
  if(inp)inp.disabled=true;

  try{
    const res=await fetch(PROXY_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:MODEL,
        max_tokens:700,
        system:buildPrompt(ws),
        messages:msgs
      })
    });
    const data=await res.json();

    if(!res.ok || data.error){
      const errType = data.error?.type||'unknown';
      const errMsg  = data.error?.message||'No message';
      const userMsg = errType==='authentication_error'
        ? 'Could not reach Core Lord — the proxy may be down.'
        : `API error (${res.status}): ${errMsg}`;
      const tel=document.getElementById(tid);
      if(tel) tel.outerHTML=buildMsgHTML('assistant', userMsg);
      if(btn)btn.disabled=false;
      if(inp){inp.disabled=false;inp.focus();}
      return;
    }

    const rawReply=data.content?.find(b=>b.type==='text')?.text||'No reply in response.';
    msgs.push({role:'assistant',content:rawReply});

    const tel=document.getElementById(tid);
    if(tel){
      const msgId='m'+Date.now();
      tel.outerHTML=`<div class="msg assistant msg-animate" id="${msgId}">
        <div class="msg-lbl"><span class="lbl-pip"></span>Core Lord</div>
        <div class="msg-bub"><p id="${msgId}-p"></p></div>
      </div>`;
      await typewriterReveal(msgId+'-p', rawReply, msgsEl);
    }
  }catch(e){
    const tel=document.getElementById(tid);
    if(tel) tel.outerHTML=buildMsgHTML('assistant',"Network error — check your connection.");
  }

  if(btn)btn.disabled=false;
  if(inp){inp.disabled=false;inp.focus();}
  const msgsEl2=document.getElementById('chatMsgs');
  if(msgsEl2)msgsEl2.scrollTop=msgsEl2.scrollHeight;
}

function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function formatMsg(text){
  let t = text
    .replace(/\*\*(.+?)\*\*/g,'$1')
    .replace(/__(.+?)__/g,'$1')
    .replace(/\*([^\*]+)\*/g,'$1')
    .replace(/_([^_]+)_/g,'$1')
    .replace(/^#{1,4}\s+/gm,'')
    .replace(/^[\*\-]\s+/gm,'');
  return esc(t)
    .replace(/\n\n/g,'</p><p style="margin-top:10px">')
    .replace(/\n/g,'<br>');
}

async function typewriterReveal(elId, text, scrollEl){
  const el=document.getElementById(elId);
  if(!el)return;
  el.innerHTML='<span class="typing-cursor"></span>';
  const formatted=formatMsg(text);
  const tokens=[];
  let buf='',inTag=false;
  for(const ch of formatted){
    if(ch==='<'){inTag=true;buf+=ch;}
    else if(ch==='>'){inTag=false;buf+=ch;tokens.push(buf);buf='';}
    else if(inTag){buf+=ch;}
    else if(ch===' '&&buf){tokens.push(buf+' ');buf='';}
    else{buf+=ch;}
  }
  if(buf)tokens.push(buf);
  let content='';
  const cursor='<span class="typing-cursor"></span>';
  const BATCH=3;
  for(let i=0;i<tokens.length;i+=BATCH){
    content+=tokens.slice(i,i+BATCH).join('');
    el.innerHTML=content+cursor;
    if(scrollEl)scrollEl.scrollTop=scrollEl.scrollHeight;
    await new Promise(r=>setTimeout(r,28));
  }
  el.innerHTML=content;
  if(scrollEl)scrollEl.scrollTop=scrollEl.scrollHeight;
}

function buildMsgHTML(role,text){
  const lbl=role==='user'?'You':'<span class="lbl-pip"></span>Core Lord';
  const animClass=role==='assistant'?' msg-animate':'';
  return`<div class="msg ${role}${animClass}">
    <div class="msg-lbl">${lbl}</div>
    <div class="msg-bub"><p>${formatMsg(text)}</p></div>
  </div>`;
}
function appendMsg(role,text){
  const el=document.getElementById('chatMsgs');
  if(!el)return;
  el.innerHTML+=buildMsgHTML(role,text);
  el.scrollTop=el.scrollHeight;
}

function confirmReset(){
  if(msgs.length>2&&!confirm('Start a new session with Core Lord?'))return;
  clearWS();msgs=[];showLanding();
}

const existing=getWS();
if(existing){
  renderChat(existing);
  const welcomeBack = `${existing.name}. You're back. Same thing we were working on, or something new?`;
  msgs=[{role:'assistant',content:welcomeBack}];
  appendMsg('assistant',msgs[0].content);
}else{
  showLanding();
}
</script>
</body>
</html>
